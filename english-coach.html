<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>English Coach</title>
<link rel="icon" href="/favicon.svg">
<style>
  :root{
    --bg:#0f0f12;--panel:#16161a;--chip:#202028;--text:#e9e9ee;--muted:#9a9aa6;
    --accent1:#7b2cf1;--accent2:#5c2df5;--ok:#27d1a0;--warn:#f0c032;--danger:#f06464;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1180px;margin:32px auto;padding:0 16px}
  header{display:flex;align-items:center;gap:14px;justify-content:space-between;margin-bottom:18px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--accent1),var(--accent2));box-shadow:0 0 0 2px #0006 inset}
  h1{margin:0;font-weight:800;font-size:24px}
  .auth{display:flex;align-items:center;gap:10px}
  .avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid #0006}
  .muted{color:var(--muted)}
  .btn{display:inline-flex;align-items:center;gap:10px;border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;color:#fff;background:linear-gradient(135deg,var(--accent1),var(--accent2))}
  .btn.secondary{background:var(--chip);color:var(--text)}
  .btn:disabled{opacity:.5;cursor:not-allowed}

  .grid{display:grid;grid-template-columns:320px 1fr;gap:18px}
  @media (max-width:950px){.grid{grid-template-columns:1fr}}
  .card{background:var(--panel);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.25);padding:16px}

  .section-title{font-weight:700;margin:0 0 8px}
  .chip-row{display:flex;flex-wrap:wrap;gap:10px;margin:6px 0 12px}
  .chip{background:var(--chip);color:var(--text);border-radius:12px;padding:10px 14px;font-weight:700}
  .chip.active{background:linear-gradient(135deg,var(--accent1),var(--accent2));box-shadow:0 10px 18px rgba(124,45,240,.25)}

  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .timer{font-weight:900;font-size:34px;background:#111218;border-radius:14px;padding:10px 14px;min-width:150px;text-align:center}
  .bar{height:10px;border-radius:8px;background:#2a2a33;flex:1;position:relative;overflow:hidden}
  .bar>i{position:absolute;left:0;top:0;bottom:0;width:0;border-radius:8px;background:var(--danger);transition:width .3s ease,background .3s ease}
  .list{list-style:none;margin:6px 0 0;padding:0;display:grid;gap:8px}
  .item{background:#1a1a20;border-radius:12px;padding:12px}

  .km{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .k{background:#1b1b23;border-radius:12px;padding:8px 10px;font-weight:700}

  footer{display:flex;justify-content:center;margin:20px 0 40px;color:var(--muted);gap:8px;font-size:13px}
  .badge{background:#1b1b23;padding:3px 8px;border-radius:10px}

  /* modal */
  .modalBg{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;padding:16px}
  .modal{background:var(--panel);border-radius:16px;max-width:560px;width:100%;padding:16px;box-shadow:0 10px 30px #000a}
  .field{display:flex;flex-direction:column;gap:6px;margin:8px 0}
  input,textarea{background:#1b1b23;border:1px solid #282838;color:var(--text);border-radius:10px;padding:10px}
  .stars{display:flex;gap:6px}
  .star{font-size:22px;cursor:pointer}
  .star.on{color:#ffd36a}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1>English Coach</h1>
    </div>
    <div class="auth">
      <img id="avatar" class="avatar" src="" alt="" style="display:none">
      <span id="who" class="muted"></span>
      <button id="btnAuth" class="btn secondary">Sign in with Google</button>
    </div>
  </header>

  <div class="grid">
    <!-- left column -->
    <aside class="card">
      <h2 class="section-title">Goal</h2>
      <div id="goalRow" class="chip-row">
        <button class="chip active" data-goal="Work English">Work English</button>
        <button class="chip" data-goal="Daily Life">Daily Life</button>
        <button class="chip" data-goal="Interview Prep">Interview Prep</button>
        <button class="chip" data-goal="Travel">Travel</button>
        <button class="chip" data-goal="Presentation">Presentation</button>
      </div>

      <div class="section-title" style="margin-top:12px">Recording</div>
      <div class="row">
        <button id="btnStart" class="btn"><span>‚ñ∂</span> Start recording</button>
        <button id="btnStop" class="btn secondary">‚ñ† Stop</button>
      </div>
      <div class="row" style="margin-top:8px">
        <div id="timer" class="timer">00:00</div>
        <div class="bar"><i id="timeFill"></i></div>
      </div>
      <button id="btnSend" class="btn" style="width:100%;margin-top:12px" disabled>Send & Analyze</button>

      <div class="section-title" style="margin-top:16px">What to say to start</div>
      <div class="item" id="promptBox">Describe a recent project you led and one lesson you learned.</div>
      <div class="row" style="margin-top:8px">
        <button id="btnRandom" class="btn secondary">üé≤ Randomize prompt</button>
        <span class="muted" style="margin-left:auto">We don‚Äôt store your audio.</span>
      </div>
    </aside>

    <!-- right column -->
    <main class="card">
      <div class="km">
        <span id="liveDot" class="k">‚óè Idle</span>
        <span class="k">Level: <b id="lvlTxt">‚Äì</b></span>
        <span class="k">Fillers: <b id="fillersTxt">0</b></span>
        <span class="k">Streak: <b id="streakTxt">0</b></span>
        <span class="k">Sessions: <b id="sessionsTxt">0</b></span>
      </div>

      <div class="km" style="margin-bottom:8px">
        <span class="k" style="min-width:240px">Level meter
          <span class="bar" style="width:140px;margin-left:8px"><i id="levelFill" style="width:0;background:var(--warn)"></i></span>
          <span id="levelPct" class="muted" style="margin-left:6px">0%</span>
        </span>
        <!-- Relevancy removed as requested -->
      </div>

      <section>
        <h3 class="section-title">Pronunciation</h3>
        <ul id="pronList" class="list"><li class="muted">‚Äì</li></ul>
      </section>

      <section style="margin-top:8px">
        <h3 class="section-title">Grammar</h3>
        <ul id="gramList" class="list"><li class="muted">‚Äì</li></ul>
      </section>

      <section style="margin-top:8px">
        <h3 class="section-title">What to fix now</h3>
        <div id="fixNow" class="item muted">‚Äì</div>
      </section>

      <section style="margin-top:8px">
        <h3 class="section-title">Next prompt (30‚Äì45s)</h3>
        <div id="nextPrompt" class="item muted">‚Äì</div>
      </section>

      <section style="margin-top:8px">
        <h3 class="section-title">Leaderboard</h3>
        <ul id="leaderboard-list" class="list"><li class="muted">Loading‚Ä¶</li></ul>
      </section>
    </main>
  </div>

  <footer>
    <span>¬© 2025 <a href="https://simpleia.com" target="_blank" class="muted" style="text-decoration:none;color:inherit">Simpleia</a> ‚Äî Built by <a href="https://aosama.net" target="_blank" class="muted" style="text-decoration:none;color:inherit">Abdo Osama</a></span>
    <span class="badge">v1.3.2</span>
  </footer>
</div>

<!-- Feedback modal -->
<div id="fbBg" class="modalBg">
  <div class="modal">
    <h3 class="section-title">Quick feedback (required to continue)</h3>
    <div class="field">
      <label>Name</label>
      <input id="fbName" placeholder="Your name"/>
    </div>
    <div class="field">
      <label>Email</label>
      <input id="fbEmail" placeholder="you@email.com"/>
    </div>
    <div class="field">
      <label>Rating</label>
      <div id="stars" class="stars">
        <span class="star">‚òÖ</span><span class="star">‚òÖ</span><span class="star">‚òÖ</span><span class="star">‚òÖ</span><span class="star">‚òÖ</span>
      </div>
    </div>
    <div class="field">
      <label>Feedback / Suggestions</label>
      <textarea id="fbMsg" rows="4" placeholder="Tell us what to improve‚Ä¶"></textarea>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="fbCancel" class="btn secondary">Cancel</button>
      <button id="fbSubmit" class="btn">Submit feedback</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ====== CONFIG (EDIT THESE) ====== */
const API_URL = "https://YOUR-VERCEL-APP.vercel.app/api/analyze"; // <- your analyzer
const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co";          // <- Supabase project URL
const SUPABASE_ANON_KEY = "YOUR-ANON-PUBLIC-KEY";                 // <- anon public key
/* ================================= */

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const EC_USER_KEY = "ec_user_id";
const EC_SESSIONS_LOCAL = "ec_sessions_count";
const EC_STREAK = "ec_streak_days";
const EC_LAST_DAY = "ec_last_day";
const FEEDBACK_EVERY_N = 1; // require feedback every N sessions (1 = every time)

/* --------- Auth UI --------- */
const btnAuth = document.getElementById("btnAuth");
const who = document.getElementById("who");
const avatar = document.getElementById("avatar");

async function refreshAuthUI(){
  const { data: { session } } = await sb.auth.getSession();
  if(session?.user){
    const { user } = session;
    // try profile
    const { data: prof } = await sb.from("profiles").select("*").eq("id", user.id).maybeSingle();
    who.textContent = prof?.display_name || user.email || "Signed in";
    if(prof?.avatar_url){ avatar.src = prof.avatar_url; avatar.style.display="block"; } else { avatar.style.display="none"; }
    btnAuth.textContent = "Sign out";
    btnAuth.onclick = async ()=>{ await sb.auth.signOut(); await refreshAuthUI(); };
  }else{
    who.textContent = "Guest";
    avatar.style.display="none";
    btnAuth.textContent = "Sign in with Google";
    btnAuth.onclick = async ()=>{
      await sb.auth.signInWithOAuth({ provider: "google" });
    };
  }
}

function getLocalUserId(){
  let id = localStorage.getItem(EC_USER_KEY);
  if(!id){ id = crypto.randomUUID(); localStorage.setItem(EC_USER_KEY, id); }
  return id;
}

/* --------- Recorder --------- */
const btnStart = document.getElementById("btnStart");
const btnStop  = document.getElementById("btnStop");
const btnSend  = document.getElementById("btnSend");
const btnRandom= document.getElementById("btnRandom");
const promptBox= document.getElementById("promptBox");
const timerEl  = document.getElementById("timer");
const timeFill = document.getElementById("timeFill");
const lvlTxt    = document.getElementById("lvlTxt");
const fillersTxt= document.getElementById("fillersTxt");
const streakTxt = document.getElementById("streakTxt");
const sessionsTxt = document.getElementById("sessionsTxt");
const levelFill = document.getElementById("levelFill");
const levelPct  = document.getElementById("levelPct");
const pronList  = document.getElementById("pronList");
const gramList  = document.getElementById("gramList");
const fixNowEl  = document.getElementById("fixNow");
const nextPromptEl = document.getElementById("nextPrompt");
const liveDot   = document.getElementById("liveDot");

const MAX_SEC = 95;
let media, rec, chunks = [];
let sec = 0, timerInt = null;
let currentGoal = "Work English";
let lastResult = null;

document.getElementById("goalRow").addEventListener("click", (e)=>{
  const b = e.target.closest("[data-goal]");
  if(!b) return;
  document.querySelectorAll("#goalRow .chip").forEach(c=>c.classList.remove("active"));
  b.classList.add("active");
  currentGoal = b.dataset.goal;
});

btnStart.onclick = async () => {
  try{
    btnStart.disabled = true; btnStop.disabled = false; btnSend.disabled = true; btnRandom.disabled = true;
    liveDot.textContent = "‚óè Live";
    media = await navigator.mediaDevices.getUserMedia({ audio:true });
    rec = new MediaRecorder(media, { mimeType:"audio/webm" });
    chunks = [];
    rec.ondataavailable = e => e.data.size && chunks.push(e.data);
    rec.onstop = () => media.getTracks().forEach(t=>t.stop());
    rec.start(250);

    sec = 0; paintTimer();
    clearInterval(timerInt);
    timerInt = setInterval(()=>{
      sec++; paintTimer();
      if(sec>=MAX_SEC) btnStop.click();
    }, 1000);
  }catch(e){
    alert("Mic permission error: "+e.message);
    btnStart.disabled = false;
  }
};

btnStop.onclick = () => {
  if(rec && rec.state!=="inactive") rec.stop();
  clearInterval(timerInt);
  btnSend.disabled = chunks.length===0;
  btnRandom.disabled = false;
  liveDot.textContent = "‚óè Idle";
};

btnRandom.onclick = () => {
  if(btnStart.disabled) return; // disabled while recording
  const options = [
    "Describe a recent project you led and one lesson you learned.",
    "Explain a challenge your team faced and how you solved it.",
    "Talk about a time you disagreed and how you handled it.",
    "Describe your typical day (~45s).",
    "What is one skill you want to improve and why?"
  ];
  promptBox.textContent = options[Math.floor(Math.random()*options.length)];
};

btnSend.onclick = async () => {
  if(!chunks.length) return;
  btnSend.disabled = true;

  const blob = new Blob(chunks, { type:"audio/webm" });
  const fd = new FormData();
  fd.append("files[]", blob, "audio.webm");
  fd.append("duration_sec", String(sec));
  fd.append("goal", currentGoal);
  fd.append("prompt_text", promptBox.textContent.trim());

  const res = await fetch(API_URL, { method:"POST", body:fd });
  const json = await res.json();
  renderResult(json);

  // reset for next try
  chunks = []; sec = 0; paintTimer(); liveDot.textContent = "‚óè Idle"; btnSend.disabled = true;

  // Save session + refresh leaderboard
  await postAnalysis(json, { goal: currentGoal, duration_sec: sec });
  await fetchAndRenderLeaderboard();

  // counters / streak
  bumpLocalCounters();

  // feedback gate
  const runs = Number(localStorage.getItem(EC_SESSIONS_LOCAL)||0);
  if(runs % FEEDBACK_EVERY_N === 0) openFeedback();
};

function paintTimer(){
  const mm = String(Math.floor(sec/60)).padStart(2,"0");
  const ss = String(sec%60).padStart(2,"0");
  timerEl.textContent = `${mm}:${ss}`;
  const pct = Math.min(100, Math.round((sec/MAX_SEC)*100));
  timeFill.style.width = pct+"%";
  timeFill.style.background = sec<30 ? "var(--danger)" : (sec<60 ? "var(--warn)" : "var(--ok)");
}

/* --------- Render results --------- */
function escapeHTML(s){ return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c])); }
function renderResult(r){
  lastResult = r;
  const L = r.friendly_level || r.cefr_estimate || "‚Äì";
  lvlTxt.textContent = L;
  fillersTxt.textContent = r?.fluency?.fillers ?? 0;

  levelPct.textContent = (r.level_score||0)+"%";
  levelFill.style.width = (r.level_score||0)+"%";
  levelFill.style.background = (r.level_score||0) > 66 ? "var(--ok)" : (r.level_score||0) > 33 ? "var(--warn)" : "var(--danger)";

  pronList.innerHTML = (r.pronunciation||[]).map(p => `
    <li class="item">
      <b>${escapeHTML(p.sound_or_word||"-")}</b> ‚Äî ${escapeHTML(p.issue||"-")}
      <div class="muted">Try: ${escapeHTML(p.minimal_pair||"-")}</div>
    </li>`).join("") || `<li class="muted">‚Äì</li>`;

  gramList.innerHTML = (r.grammar_issues||[]).map(g => `
    <li class="item">
      ‚Üí ${escapeHTML(g.error||"-")}
      <div>Try: ${escapeHTML(g.fix||"-")}</div>
      <div class="muted">Why: ${escapeHTML(g.why||"-")}</div>
    </li>`).join("") || `<li class="muted">‚Äì</li>`;

  fixNowEl.textContent = r.one_thing_to_fix || "‚Äì";
  nextPromptEl.textContent = r.next_prompt || "‚Äì";
}

/* --------- Local counters + streak --------- */
function bumpLocalCounters(){
  const today = new Date().toISOString().slice(0,10);
  const last = localStorage.getItem(EC_LAST_DAY);
  let streak = Number(localStorage.getItem(EC_STREAK)||0);
  if(!last || last===today){
    if(!streak) streak = 1; // first day
  }else{
    const d1 = new Date(last); const d2 = new Date(today);
    const diff = (d2 - d1)/(1000*60*60*24);
    streak = diff===1 ? streak+1 : 1;
  }
  localStorage.setItem(EC_LAST_DAY, today);
  localStorage.setItem(EC_STREAK, String(streak));

  let localCount = Number(localStorage.getItem(EC_SESSIONS_LOCAL)||0) + 1;
  localStorage.setItem(EC_SESSIONS_LOCAL, String(localCount));

  streakTxt.textContent = String(streak);
  sessionsTxt.textContent = String(localCount);
}

/* --------- Supabase: store sessions + leaderboard --------- */
async function getUserIdOrGuest(){
  const { data:{ session } } = await sb.auth.getSession();
  return session?.user?.id || getLocalUserId();
}

async function saveSessionToSupabase({ goal, duration_sec, result }){
  try{
    const user_id = await getUserIdOrGuest();
    const payload = {
      user_id,
      goal,
      duration_sec: Math.round(duration_sec||0),
      wpm: result?.fluency?.wpm ?? null,
      fillers: result?.fluency?.fillers ?? null,
      level_score: result?.level_score ?? null,
      relevance_score: null /* removed from UI */,
    };
    await sb.from("sessions").insert(payload).throwOnError();
  }catch(e){ console.warn("Supabase insert:", e.message); }
}

async function fetchAndRenderLeaderboard(){
  const UL = document.getElementById("leaderboard-list");
  try{
    // Get counts per user
    const { data } = await sb.from("sessions").select("user_id");
    const counts = new Map();
    (data||[]).forEach(r => counts.set(r.user_id, (counts.get(r.user_id)||0)+1));

    // fetch names for top 10
    const top = [...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
    if(!top.length){ UL.innerHTML = `<li class="muted">No sessions yet.</li>`; return; }

    const ids = top.map(([id])=>id);
    const { data: profs } = await sb.from("profiles").select("id, display_name").in("id", ids);
    const nameById = new Map((profs||[]).map(p=>[p.id, p.display_name]));

    const me = await getUserIdOrGuest();
    UL.innerHTML = top.map(([uid,cnt],i)=>{
      const label = nameById.get(uid) || (uid===me ? "You" : "Guest");
      return `<li>${i+1}. <b>${label}</b> ‚Äî ${cnt} session${cnt>1?"s":""}</li>`;
    }).join("");
  }catch(e){
    UL.innerHTML = `<li class="muted">Leaderboard unavailable</li>`;
  }
}

async function postAnalysis(result, meta){
  await saveSessionToSupabase({ goal: meta?.goal, duration_sec: meta?.duration_sec, result });
}

/* --------- Feedback modal --------- */
const fbBg = document.getElementById("fbBg");
const fbName = document.getElementById("fbName");
const fbEmail= document.getElementById("fbEmail");
const fbMsg  = document.getElementById("fbMsg");
const fbSubmit = document.getElementById("fbSubmit");
const fbCancel = document.getElementById("fbCancel");
const starsEl = document.getElementById("stars");
let fbRating = 5;

starsEl.querySelectorAll(".star").forEach((el,idx)=>{
  el.addEventListener("click", ()=>{
    fbRating = idx+1;
    starsEl.querySelectorAll(".star").forEach((s,i)=>s.classList.toggle("on", i<fbRating));
  });
});
starsEl.querySelectorAll(".star").forEach((s,i)=>s.classList.toggle("on", i<fbRating));

function openFeedback(){ fbBg.style.display="flex"; prefillFeedback(); }
function closeFeedback(){ fbBg.style.display="none"; }

async function prefillFeedback(){
  const { data:{ session } } = await sb.auth.getSession();
  if(session?.user){
    const { user } = session;
    const { data: prof } = await sb.from("profiles").select("*").eq("id", user.id).maybeSingle();
    fbName.value = prof?.display_name || user.user_metadata?.name || "";
    fbEmail.value = user.email || "";
  }
}

fbCancel.onclick = closeFeedback;
fbSubmit.onclick = async ()=>{
  const { data:{ session } } = await sb.auth.getSession();
  const user_id = session?.user?.id ?? null;
  try{
    await sb.from("feedback").insert({
      user_id,
      name: fbName.value.trim() || null,
      email: fbEmail.value.trim() || null,
      rating: fbRating,
      message: fbMsg.value.trim() || null
    }).throwOnError();
    closeFeedback();
  }catch(e){
    alert("Could not submit feedback: "+e.message);
  }
};

/* --------- Boot --------- */
document.addEventListener("DOMContentLoaded", async ()=>{
  await refreshAuthUI();
  sb.auth.onAuthStateChange(refreshAuthUI);
  streakTxt.textContent   = localStorage.getItem(EC_STREAK)||"0";
  sessionsTxt.textContent = localStorage.getItem(EC_SESSIONS_LOCAL)||"0";
  fetchAndRenderLeaderboard();
});
</script>
</body>
</html>
