<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>English Coach â€” Instant English Feedback</title>
<meta name="color-scheme" content="dark">
<style>
  :root{
    --bg:#191919;
    --panel:#1f1f1f;
    --panel-2:#181818;
    --text:#f5f5f5;
    --muted:#a7a7a7;
    --chip:#222;
    --ok:#22c55e;
    --err:#ef4444;
    --ring:rgba(78,10,122,.45);
    --primary:#4E0A7A;
    --primary-2:#7123a7;
    --shadow:0 10px 30px rgba(0,0,0,.35);
    --radius:14px;
  }
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family:"Avenir Next",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  }
  .wrap{max-width:1200px; margin:24px auto; padding:0 16px}
  header{display:flex; align-items:center; gap:16px; margin-bottom:20px}
  .brand{font-size:28px; font-weight:800; letter-spacing:.3px}
  .pill{font-size:14px; padding:8px 14px; border-radius:999px;
        background:linear-gradient(135deg,var(--primary),var(--primary-2)); box-shadow:var(--shadow)}
  .grid{display:grid; grid-template-columns:360px 1fr; gap:18px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }

  .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));
        border:1px solid #262626; border-radius:var(--radius); box-shadow:var(--shadow)}
  .card .inner{padding:18px}
  .title{font-weight:800; font-size:18px; margin-bottom:6px}
  .muted{color:var(--muted); font-size:14px}

  /* goal row: exactly one row, scroll when narrow */
  .goal-chips{
    display:flex; gap:10px; overflow-x:auto; padding-bottom:4px; scrollbar-width:thin; white-space:nowrap;
  }
  .goal-chips::-webkit-scrollbar{height:6px}
  .goal-chips::-webkit-scrollbar-thumb{background:#2c2c2c; border-radius:8px}

  .chip{
    display:inline-flex; align-items:center; justify-content:center;
    padding:12px 18px; border-radius:14px; background:var(--chip); color:#ddd;
    border:1px solid #2a2a2a; user-select:none; cursor:pointer; transition:.15s;
  }
  .chip:hover{border-color:#3a3a3a}
  .chip.active{background:linear-gradient(135deg,var(--primary),var(--primary-2)); color:#fff; border-color:transparent}

  .row{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .btn{
    appearance:none; border:0; border-radius:12px; padding:12px 16px; cursor:pointer;
    font-weight:700; color:#fff; background:#2b2b2b;
    border:1px solid #2a2a2a; transition:.15s; box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);
  }
  .btn:hover{background:#343434}
  .btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary-2)); border-color:transparent}
  .timer{min-width:100px; text-align:center; padding:12px; border-radius:12px; background:#202020; border:1px solid #2a2a2a}

  .starter{
    margin-top:14px; border-radius:12px; border:1px dashed #323232; padding:14px;
    background:#1a1a1a; color:#ddd; font-size:14px; line-height:1.35;
  }

  .two{display:grid; grid-template-columns:1fr; gap:14px}
  .row-mini{display:flex; gap:10px; align-items:center}
  .badge{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #2a2a2a; background:#151515}
  .out{padding:12px; border-radius:12px; border:1px solid #2a2a2a; background:#151515; color:#ddd; min-height:42px}
  .list{display:grid; gap:10px}
  .li{padding:12px; border-radius:12px; border:1px solid #2a2a2a; background:#141414}
  .tag{display:inline-block; padding:2px 8px; border-radius:8px; font-size:12px; margin-right:6px; background:#232323; border:1px solid #2a2a2a}

  footer{margin:26px 0 40px; color:#bdbdbd; font-size:13px; text-align:center}
  footer a{color:#caa8ff; text-decoration:none}
  footer a:hover{text-decoration:underline}

  .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
         background:#262626; color:#fff; border:1px solid #333; border-radius:12px; padding:12px 16px; box-shadow:var(--shadow);
         display:none; z-index:50;}

  /* Modal */
  .modal-back{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:60;}
  .modal{width:min(520px,92vw); background:#1c1c1c; border:1px solid #2a2a2a; border-radius:16px; box-shadow:var(--shadow)}
  .modal .hd{padding:16px 18px; border-bottom:1px solid #2a2a2a; font-weight:800}
  .modal .bd{padding:18px; display:grid; gap:12px}
  .input, textarea{
    width:100%; padding:12px 14px; border-radius:12px; background:#111; color:#eee; border:1px solid #2a2a2a;
  }
  textarea{min-height:110px; resize:vertical}
  .stars{display:flex; gap:10px}
  .star{font-size:22px; cursor:pointer; color:#666}
  .star.active{color:#ffd369}
  .modal .ft{padding:16px 18px; border-top:1px solid #2a2a2a; display:flex; gap:10px; justify-content:flex-end}
  .tbl{width:100%; border-collapse:collapse; font-size:14px}
  .tbl th,.tbl td{padding:10px 12px; border-bottom:1px solid #2a2a2a; text-align:left}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">English Coach</div>
      <div class="pill">Instant English Feedback</div>
    </header>

    <div class="grid">
      <!-- LEFT: controls -->
      <section class="card">
        <div class="inner">
          <div class="title" style="font-size:22px">Record for <strong>60â€“90 seconds</strong>.</div>
          <div class="muted">Weâ€™ll analyze fluency & correctness, then show key corrections and a next prompt.</div>

          <div style="height:14px"></div>
          <div class="muted" style="margin-bottom:8px">Goal</div>
          <div id="goalChips" class="goal-chips"></div>

          <div style="height:14px"></div>
          <div class="row">
            <button id="btnStart" class="btn primary">Start recording</button>
            <button id="btnStop" class="btn">Stop</button>
            <div class="timer" id="timer">00:00</div>
          </div>

          <div style="height:10px"></div>
          <button id="btnSend" class="btn" style="width:100%">Send & Analyze</button>

          <div class="starter">
            <div class="muted" style="margin-bottom:6px">What to say to start</div>
            <div id="starterText">Describe your last weekend in 45 seconds.</div>
            <div style="height:6px"></div>
            <button id="btnDice" class="btn" style="padding:8px 12px">Randomize prompt ðŸŽ²</button>
          </div>

          <div class="muted" style="margin-top:14px; font-size:12px">
            We donâ€™t store your audio; itâ€™s sent to the analyzer and immediately discarded.
          </div>
        </div>
      </section>

      <!-- RIGHT: results -->
      <section class="card">
        <div class="inner">
          <div class="title">Summary</div>
          <div class="row-mini" style="margin-bottom:8px">
            <span class="badge">Level: <span id="levelOut">â€“</span></span>
            <span class="badge">Fillers: <span id="fillersOut">0</span></span>
          </div>

          <div class="two">
            <div>
              <div class="muted" style="margin-bottom:6px">What to fix now</div>
              <div class="out" id="fixNowOut">â€“</div>
            </div>
            <div>
              <div class="muted" style="margin-bottom:6px">Next prompt (30â€“45s)</div>
              <div class="out" id="nextPromptOut">â€“</div>
            </div>
          </div>

          <div style="height:16px"></div>
          <div class="title">Grammar</div>
          <div class="list" id="grammarList"></div>

          <div style="height:16px"></div>
          <div class="title">Pronunciation</div>
          <div class="list" id="pronList"></div>
        </div>
      </section>
    </div>

    <!-- Leaderboard -->
    <section class="card" id="board" style="margin-top:16px; display:none">
      <div class="inner">
        <div class="title">Leaderboard</div>
        <table class="tbl" id="boardTbl">
          <thead><tr><th>#</th><th>Name</th><th>Sessions</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="muted" id="boardEmpty">Coming soon.</div>
      </div>
    </section>

    <footer>
      Â© 2025 <a href="https://simpleia.com" target="_blank" rel="noopener">Simpleia</a> â€” Built by
      <a href="https://aosama.net/" target="_blank" rel="noopener">Abdo Osama</a>
    </footer>
  </div>

  <!-- Feedback modal -->
  <div class="modal-back" id="fbBack">
    <div class="modal">
      <div class="hd">Quick feedback (required to continue)</div>
      <div class="bd">
        <input id="fbName" class="input" placeholder="Your name" autocomplete="name" />
        <input id="fbEmail" class="input" placeholder="Email" type="email" autocomplete="email" />
        <div>
          <div class="muted" style="margin-bottom:6px">Rating</div>
          <div class="stars" id="stars"></div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px">Feedback / Suggestions</div>
          <textarea id="fbText" placeholder="What should we improve?"></textarea>
        </div>
      </div>
      <div class="ft">
        <button class="btn" id="fbCancel">Cancel</button>
        <button class="btn primary" id="fbSubmit">Submit feedback</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ===================== CONFIG (change if needed) ===================== */
const API = 'https://english-coach-endpoint.vercel.app/api/analyze'; // Analyzer
const FEEDBACK_URL = 'https://hook.your-make.com/your-ec_feedback_webhook'; // <- PUT your Make.com webhook here
const LEADERBOARD_URL = ''; // optional: endpoint returning [{name,uses}], leave blank to hide

/* =================== GOALS, STARTERS, FRIENDLY LEVELS =================== */
const GOALS = [
  { key:'work', label:'Work English',
    starters:[
      'Explain one problem your team faced and how you solved it.',
      'Describe a recent project you led and one lesson you learned.',
      'Give a 45-second update on your current task and next step.'
    ] },
  { key:'daily', label:'Daily Life',
    starters:[
      'Describe your last weekend in 45 seconds.',
      'Tell me about a typical day in your life.',
      'Talk about a hobby you enjoy and why.'
    ] },
  { key:'interview', label:'Interview Prep',
    starters:[
      'Tell me about yourself in under one minute.',
      'What is your biggest strength at work?',
      'Describe a time you handled a difficult situation.'
    ] },
  { key:'travel', label:'Travel',
    starters:[
      'Describe a city you want to visit and why.',
      'Talk about your best travel experience.',
      'Explain how you plan a short weekend trip.'
    ] }
];

const FRIENDLY_LEVEL = (cefr) => {
  const x = (cefr||'').toUpperCase();
  if (x==='A1'||x==='A2') return 'Beginner';
  if (x==='B1') return 'Intermediate';
  if (x==='B2' || x==='C1') return 'Advanced';
  if (x==='C2') return 'Fluent';
  return 'â€“';
};

/* ============================= UI REFS ============================== */
const btnStart = document.getElementById('btnStart');
const btnStop  = document.getElementById('btnStop');
const btnSend  = document.getElementById('btnSend');
const timerEl  = document.getElementById('timer');

const starterText = document.getElementById('starterText');
const btnDice = document.getElementById('btnDice');
const goalChips = document.getElementById('goalChips');

const levelOut = document.getElementById('levelOut');
const fillersOut = document.getElementById('fillersOut');
const fixNowOut = document.getElementById('fixNowOut');
const nextPromptOut = document.getElementById('nextPromptOut');
const grammarList = document.getElementById('grammarList');
const pronList = document.getElementById('pronList');

const toast = document.getElementById('toast');
const boardSec = document.getElementById('board');
const boardTbl = document.querySelector('#boardTbl tbody');
const boardEmpty = document.getElementById('boardEmpty');

/* Feedback modal refs */
const fbBack = document.getElementById('fbBack');
const fbName = document.getElementById('fbName');
const fbEmail = document.getElementById('fbEmail');
const fbText = document.getElementById('fbText');
const fbCancel = document.getElementById('fbCancel');
const fbSubmit = document.getElementById('fbSubmit');
const starsWrap = document.getElementById('stars');

/* ====================== USER / FEEDBACK GATING ====================== */
const UID = (()=>{ const k='ec_uid'; let v=localStorage.getItem(k); if(!v){v='web-'+crypto.randomUUID(); localStorage.setItem(k,v);} return v; })();
const FB_DONE_KEY = 'ec_fb_done';
const USES_KEY = 'ec_uses';

function uses(){ return parseInt(localStorage.getItem(USES_KEY)||'0',10); }
function bumpUses(){ localStorage.setItem(USES_KEY, String(uses()+1)); }
function hasFeedback(){ return !!localStorage.getItem(FB_DONE_KEY); }
function requireFeedbackGate(){
  // Allow first run; require feedback before the second run.
  if (uses() >= 1 && !hasFeedback()){
    openFeedback(); return true;
  }
  return false;
}

/* ===================== GOAL CHIPS / STARTERS ====================== */
let currentGoal = GOALS[0];
function renderGoalChips(){
  goalChips.innerHTML='';
  GOALS.forEach(g=>{
    const el=document.createElement('div');
    el.className='chip'+(g.key===currentGoal.key?' active':'');
    el.textContent=g.label;
    el.onclick=()=>{ currentGoal=g; renderGoalChips(); setRandomStarter(); };
    goalChips.appendChild(el);
  });
}
function setRandomStarter(){
  const arr=currentGoal.starters;
  starterText.textContent = arr[Math.floor(Math.random()*arr.length)];
}
btnDice.addEventListener('click', setRandomStarter);
renderGoalChips(); setRandomStarter();

/* ============================== RECORDING ============================== */
let media,rec,chunks=[],startTime=0,timerI=null,blob=null;

function fmt(ms){ const s=Math.floor(ms/1000); const m=String(Math.floor(s/60)).padStart(2,'0'); const r=String(s%60).padStart(2,'0'); return `${m}:${r}`; }
function setButtons(busy){
  btnStart.disabled=busy; btnStop.disabled=!busy; btnSend.disabled=busy;
  document.body.style.cursor = busy ? 'progress' : 'default';
}
async function startRec(){
  if(requireFeedbackGate()) return;
  try{
    media = await navigator.mediaDevices.getUserMedia({audio:true});
    chunks=[]; rec = new MediaRecorder(media, {mimeType:'audio/webm;codecs=opus'});
    rec.ondataavailable=e=>{ if(e.data?.size>0) chunks.push(e.data); };
    rec.onstop=()=>{ blob=new Blob(chunks,{type:'audio/webm'}); if(media){media.getTracks().forEach(t=>t.stop());} };
    rec.start(200);
    startTime=performance.now(); clearInterval(timerI);
    timerI=setInterval(()=>{ timerEl.textContent = fmt(performance.now()-startTime); }, 250);
    setButtons(true);
  }catch(e){ notify('Microphone not available.'); console.error(e); }
}
function stopRec(){
  try{ rec?.stop(); }catch{}
  clearInterval(timerI);
  timerEl.textContent = fmt(performance.now()-startTime);
  setButtons(false);
}
btnStart.addEventListener('click', startRec);
btnStop.addEventListener('click', stopRec);

/* =============================== ANALYZE =============================== */
async function sendAnalyze(){
  if(requireFeedbackGate()) return;
  if(!blob || blob.size===0){ notify('Please record first, then Send & Analyze.'); return; }
  const dur=Math.round((performance.now()-startTime)/1000);
  const fd=new FormData();
  const file=new File([blob],'audio.webm',{type:blob.type||'audio/webm'});
  fd.append('files[]', file);
  fd.append('duration_sec', String(dur));
  fd.append('goal', currentGoal.label);

  setButtons(true);

  try{
    const res=await fetch(API,{method:'POST',body:fd});
    const text=await res.text();

    if(!res.ok){ notify('Analyzer error'); setButtons(false); return; }
    let j; try{ j=JSON.parse(text); }catch{ notify('Analyzer returned non-JSON'); setButtons(false); return; }

    bumpUses();              // mark a completed session
    renderResult(j);
  }catch(err){
    notify('Network error'); console.error(err);
  }finally{
    setButtons(false);
  }
}
btnSend.addEventListener('click', sendAnalyze);

/* ============================== RENDER =============================== */
function renderResult(j){
  if(j.fallback){
    levelOut.textContent = 'â€“';
    fillersOut.textContent = '0';
    fixNowOut.textContent = 'Speak for at least 30â€“60 seconds in full sentences.';
    nextPromptOut.textContent = starterText.textContent;
    grammarList.innerHTML=''; pronList.innerHTML='';
    return;
  }
  levelOut.textContent   = FRIENDLY_LEVEL(j.cefr_estimate);
  fillersOut.textContent = String(j?.fluency?.fillers ?? 0);
  fixNowOut.textContent  = (j?.one_thing_to_fix || j?.rationale || 'â€“');
  nextPromptOut.textContent = (j?.next_prompt || starterText.textContent);

  grammarList.innerHTML='';
  (j?.grammar_issues||[]).forEach(g=>{
    const row=document.createElement('div'); row.className='li';
    row.innerHTML = `
      <div class="tag">error</div> ${escapeHtml(g.error||'')}
      <div style="height:6px"></div>
      <div class="tag">fix</div> ${escapeHtml(g.fix||'')}
      ${g.why ? `<div style="height:6px"></div><div class="tag">why</div> ${escapeHtml(g.why)}`:''}
    `;
    grammarList.appendChild(row);
  });

  pronList.innerHTML='';
  (j?.pronunciation||[]).forEach(p=>{
    const row=document.createElement('div'); row.className='li';
    row.innerHTML = `
      <div class="tag">word</div> ${escapeHtml(p.sound_or_word||'')}
      ${p.issue ? `<div style="height:6px"></div><div class="tag">issue</div> ${escapeHtml(p.issue)}`:''}
      ${p.minimal_pair ? `<div style="height:6px"></div><div class="tag">try</div> ${escapeHtml(p.minimal_pair)}`:''}
    `;
    pronList.appendChild(row);
  });
}
function escapeHtml(s){ return (s??'').toString().replace(/[<>&"]/g,m=>({ '<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;' }[m])); }

/* ============================ FEEDBACK MODAL ============================ */
let rating=0;
function drawStars(){
  starsWrap.innerHTML='';
  for(let i=1;i<=5;i++){
    const el=document.createElement('span');
    el.className = 'star' + (i<=rating?' active':'');
    el.textContent = 'â˜…';
    el.title = `${i} star${i>1?'s':''}`;
    el.onclick=()=>{ rating=i; drawStars(); };
    starsWrap.appendChild(el);
  }
}
drawStars();

function openFeedback(){ fbBack.style.display='flex'; }
function closeFeedback(){ fbBack.style.display='none'; }

fbCancel.addEventListener('click', closeFeedback);
fbSubmit.addEventListener('click', async ()=>{
  const name=(fbName.value||'').trim();
  const email=(fbEmail.value||'').trim();
  const text=(fbText.value||'').trim();

  if(!name || !email || !rating || !text){
    notify('Please fill all fields and select a rating.'); return;
  }
  if(!FEEDBACK_URL || FEEDBACK_URL.includes('your-ec_feedback_webhook')){
    notify('Feedback endpoint not configured.'); return;
  }

  const payload={
    user_id:UID,
    user_name:name,
    email,
    rating,
    suggestions:text,
    ts_date:new Date().toISOString()
  };
  try{
    await fetch(FEEDBACK_URL,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
    localStorage.setItem(FB_DONE_KEY, 'true');
    notify('Thanks for the feedback!'); closeFeedback();
  }catch(e){
    notify('Failed to send feedback.'); console.error(e);
  }
});

/* =========================== LEADERBOARD ============================ */
async function loadBoard(){
  if(!LEADERBOARD_URL){ boardSec.style.display='none'; return; }
  try{
    const r=await fetch(LEADERBOARD_URL, {cache:'no-store'});
    if(!r.ok) throw 0;
    const data=await r.json(); // [{name,uses}]
    if(!Array.isArray(data)||!data.length){ boardSec.style.display='none'; return; }
    boardTbl.innerHTML='';
    data.slice(0,20).forEach((row,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i+1}</td><td>${escapeHtml(row.name||'Anonymous')}</td><td>${row.uses||0}</td>`;
      boardTbl.appendChild(tr);
    });
    boardEmpty.style.display='none';
    boardSec.style.display='block';
  }catch{
    boardSec.style.display='none';
  }
}
loadBoard();

/* ================================ UX ================================= */
let toastT=null;
function notify(msg){
  toast.textContent=msg; toast.style.display='block';
  clearTimeout(toastT); toastT=setTimeout(()=>toast.style.display='none', 2200);
}

/* ========================= INIT (optional ?api) ======================== */
(function maybeOverrideApiFromQuery(){
  const u=new URL(location.href);
  const q=u.searchParams.get('api');
  if(q && /^https?:\/\//.test(q)) { /* hidden override for internal testing */ }
})();
</script>
</body>
</html>
