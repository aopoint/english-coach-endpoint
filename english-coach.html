<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>English Coach — Instant English Feedback</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#191919;
    --panel:#161616;
    --card:#1f1f1f;
    --muted:#9a9a9a;
    --text:#f5f5f5;
    --ok:#22c55e;
    --err:#ef4444;
    --chip:#222;
    --ring:rgba(78,10,122,.35);
    --primary:#4E0A7A;      /* Simpleia primary */
    --primary-2:#7f3ab7;    /* lighter hover */
    --shadow:0 8px 38px rgba(0,0,0,.45), 0 2px 12px rgba(0,0,0,.35);
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background: radial-gradient(1000px 600px at 30% -10%, rgba(78,10,122,.18), transparent 60%),
                radial-gradient(900px 500px at 90% -10%, rgba(78,10,122,.12), transparent 60%),
                var(--bg);
    color:var(--text);
    font:16px/1.35 "Avenir Next", Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    letter-spacing:.2px;
  }
  a{color:#b29ad9;text-decoration:none}
  a:hover{text-decoration:underline}
  .wrap{
    max-width:1200px;
    margin:40px auto 100px;
    padding:0 20px;
  }

  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:22px;
  }
  .brand{
    display:flex;align-items:center;gap:12px;
    font-weight:800;letter-spacing:.4px;font-size:26px;
  }
  .badge{font-size:12px;padding:6px 10px;border-radius:999px;background:linear-gradient(180deg, var(--primary), #361157);box-shadow:inset 0 0 0 1px rgba(255,255,255,.06);}

  .grid{
    display:grid;
    grid-template-columns: 420px 1fr;
    gap:18px;
  }
  @media (max-width: 980px){
    .grid{grid-template-columns: 1fr;gap:16px}
  }

  .card{
    background:var(--card);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    border:1px solid rgba(255,255,255,.04);
  }
  .pad{padding:18px}

  /* Left controller */
  .title{
    font-weight:800;
    font-size:28px;
    margin:6px 0 6px;
  }
  .subtitle{color:var(--muted);margin-bottom:18px}
  .section-label{font-weight:700;margin:14px 0 10px}

  /* Goal chips row (one row, horizontal scroll on mobile) */
  .chip-row{
    display:flex;gap:10px;align-items:center;overflow:auto;padding-bottom:4px;
    -webkit-overflow-scrolling:touch;scrollbar-width:none;
  }
  .chip-row::-webkit-scrollbar{display:none}
  .chip{
    white-space:nowrap;
    padding:12px 18px;border-radius:14px;background:var(--chip);
    border:1px solid rgba(255,255,255,.06);
    color:#ddd;cursor:pointer;user-select:none;
    transition:.15s ease;
  }
  .chip:hover{border-color:rgba(255,255,255,.12)}
  .chip.active{
    color:#fff;background:linear-gradient(180deg,var(--primary),#361157);
    box-shadow:0 0 0 3px var(--ring);
  }

  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row .btn{flex:1}
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:14px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.06);
    background:#232323;color:#fff;cursor:pointer;transition:.15s ease;
    font-weight:700;
  }
  .btn:hover{border-color:rgba(255,255,255,.12)}
  .btn.primary{background:linear-gradient(180deg, var(--primary), #361157)}
  .btn.primary:hover{filter:brightness(1.08)}
  .btn.ghost{background:#1b1b1b}
  .timer{
    min-width:140px;text-align:center;font-weight:800;font-size:26px;padding:10px 14px;border-radius:14px;background:#141414;border:1px solid rgba(255,255,255,.06)
  }
  .prompt-box{
    margin-top:12px;font-size:14px;color:#cfcfcf;background:#151515;border:1px dashed rgba(255,255,255,.08);
    border-radius:12px;padding:12px
  }
  .prompt-actions{display:flex;gap:8px;margin-top:8px}
  .mini{font-size:12px;padding:6px 10px;border-radius:10px;background:#232323;border:1px solid rgba(255,255,255,.06);cursor:pointer}
  .mini:hover{border-color:rgba(255,255,255,.12)}

  /* Right: results */
  .stack{display:flex;flex-direction:column;gap:14px}
  .metric-row{display:flex;gap:10px;flex-wrap:wrap}
  .metric{
    padding:10px 12px;border-radius:12px;background:#141414;border:1px solid rgba(255,255,255,.06);color:#d9d9d9;
    display:flex;align-items:center;gap:8px;font-weight:700
  }
  .metric .dot{width:10px;height:10px;border-radius:999px;background:#444}
  .metric .dot.green{background:var(--ok)}
  .metric .dot.red{background:var(--err)}

  .out{background:#151515;border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:12px;color:#eaeaea;min-height:48px}
  .out.mono{font:13px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;color:#c9c9c9}

  /* Feedback modal */
  .modal{
    position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(2px);z-index:1000;
  }
  .modal.show{display:flex}
  .sheet{
    width:min(560px,calc(100vw - 32px));
    background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:var(--shadow);
    padding:16px 16px 12px;
  }
  .sheet h3{margin:6px 0 2px}
  .fld{margin:10px 0}
  .fld input, .fld textarea{
    width:100%;background:#121212;border:1px solid rgba(255,255,255,.08);color:#eee;border-radius:12px;padding:12px 12px;font:14px Inter, system-ui
  }
  .fld textarea{min-height:120px;resize:vertical}
  .stars{display:flex;gap:8px;font-size:24px;cursor:pointer}
  .star{filter:grayscale(1) brightness(1.1);opacity:.6;transition:.12s}
  .star.active{filter:none;opacity:1}
  .sheet .row{justify-content:flex-end;margin-top:6px}
  .toast{
    position:fixed;left:50%;bottom:22px;transform:translateX(-50%);
    background:#101010;border:1px solid rgba(255,255,255,.08);color:#eee;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);
    z-index:1200;display:none
  }
  .toast.show{display:block}

  footer{margin:24px 0 60px;text-align:center;color:#bdbdbd}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">English Coach <span class="badge">Instant English Feedback</span></div>
    </header>

    <div class="grid">
      <!-- LEFT: CONTROLS -->
      <div class="card pad">
        <div class="title">Record for 60–90 seconds.</div>
        <div class="subtitle">We’ll analyze fluency & correctness, then show key corrections and a next prompt.</div>

        <div class="section-label">Goal</div>
        <div id="goals" class="chip-row" role="tablist" aria-label="Goal">
          <div class="chip active" data-goal="Work English">Work English</div>
          <div class="chip" data-goal="Daily Life">Daily Life</div>
          <div class="chip" data-goal="Interview Prep">Interview Prep</div>
          <div class="chip" data-goal="Travel">Travel</div>
        </div>

        <div class="row" style="margin:12px 0 10px">
          <button id="btnStart" class="btn primary">Start recording</button>
          <button id="btnStop" class="btn ghost">Stop</button>
          <div id="timer" class="timer">00:00</div>
        </div>
        <button id="btnSend" class="btn" style="width:100%;font-size:17px;font-weight:800;letter-spacing:.2px;">Send & Analyze</button>

        <div class="prompt-box">
          <div style="font-weight:700;margin-bottom:6px">What to say to start</div>
          <div id="starter">Describe a recent project you led and one lesson you learned.</div>
          <div class="prompt-actions">
            <button id="btnRandom" class="mini">Randomize prompt</button>
            <button id="btnCopy" class="mini">Copy</button>
          </div>
        </div>

        <div style="margin-top:12px;color:#a6a6a6;font-size:13px">
          We don’t store your audio; it’s sent to the analyzer and immediately discarded.
        </div>
      </div>

      <!-- RIGHT: RESULTS -->
      <div class="stack">
        <div class="card pad">
          <div class="metric-row" style="margin-bottom:10px">
            <div class="metric"><span class="dot green"></span> Live</div>
            <div class="metric">Level: <span id="level" style="margin-left:8px">–</span></div>
            <div class="metric">Fillers: <span id="fillers" style="margin-left:6px">0</span></div>
          </div>

          <div class="section-label">What to fix now</div>
          <div id="fixnow" class="out">–</div>

          <div class="section-label" style="margin-top:14px">Next prompt (30–45s)</div>
          <div id="nextprompt" class="out">–</div>

          <div class="section-label" style="margin-top:16px">Grammar</div>
          <div id="grammar" class="out">–</div>

          <div class="section-label" style="margin-top:16px">Pronunciation</div>
          <div id="pron" class="out">–</div>
        </div>
      </div>
    </div>

    <footer>
      © 2025 <a href="https://simpleia.com" target="_blank" rel="noopener">Simpleia</a> — Built by <a href="https://aosama.net" target="_blank" rel="noopener">Abdo Osama</a>
    </footer>
  </div>

  <!-- FEEDBACK MODAL (required after the first run) -->
  <div id="modal" class="modal" aria-hidden="true" aria-label="Feedback modal">
    <div class="sheet" role="dialog" aria-modal="true">
      <h3>Quick feedback (required to continue)</h3>
      <div class="fld"><input id="fbName" type="text" placeholder="Your name"></div>
      <div class="fld"><input id="fbEmail" type="email" placeholder="Your email"></div>

      <div class="fld">
        <div style="font-weight:700;margin-bottom:6px">Rating</div>
        <div id="stars" class="stars" aria-label="Rating">
          <span class="star">⭐️</span><span class="star">⭐️</span><span class="star">⭐️</span><span class="star">⭐️</span><span class="star">⭐️</span>
        </div>
      </div>

      <div class="fld"><textarea id="fbMsg" placeholder="Feedback / Suggestions"></textarea></div>

      <div class="row">
        <button id="fbCancel" class="btn ghost">Cancel</button>
        <button id="fbSubmit" class="btn primary">Submit feedback</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ================== CONFIG ================== */
const ANALYZE_API  = "https://english-coach-endpoint.vercel.app/api/analyze"; // <- your live analyzer
const FEEDBACK_API = ""; // optional: Make/Vercel feedback endpoint. Leave blank to store “submitted” locally.

/* ================== UI HELPERS ================== */
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),2200) }
function formatTime(sec){
  const m = Math.floor(sec/60).toString().padStart(2,"0");
  const s = Math.floor(sec%60).toString().padStart(2,"0");
  return `${m}:${s}`;
}

/* ================== GOALS & PROMPTS ================== */
const GOALS = ["Work English","Daily Life","Interview Prep","Travel"];
const STARTERS = {
  "Work English":[
    "Describe a recent project you led and one lesson you learned.",
    "Explain a problem your team faced and how you solved it.",
    "Give a 60-second update on your current work priorities."
  ],
  "Daily Life":[
    "Tell me about your morning routine and what you enjoy about it.",
    "Describe your last weekend in 60 seconds.",
    "Explain one healthy habit you’re trying to build."
  ],
  "Interview Prep":[
    "Answer: 'Tell me about yourself' in 60 seconds.",
    "Describe a challenge you overcame at work.",
    "Explain your proudest achievement and why."
  ],
  "Travel":[
    "Describe your favorite city and why you love it.",
    "Explain a memorable trip you’ve taken.",
    "Give tips for a first-time visitor to your hometown."
  ],
};
let goal = "Work English";
function setGoal(g){
  goal=g;
  $$("#goals .chip").forEach(ch=>ch.classList.toggle("active", ch.dataset.goal===g));
  randomizeStarter();
}
function randomizeStarter(){
  const arr=STARTERS[goal]; $("#starter").textContent = arr[Math.floor(Math.random()*arr.length)];
}

/* ================== RECORDER ================== */
let media, recorder, chunks=[], startedAt=0, timerInt;
function updateTimer(){ $("#timer").textContent = formatTime((performance.now()-startedAt)/1000) }
async function startRec(){
  if (!window.MediaRecorder){ toast("Recording not supported in this browser."); return; }
  try{
    media = await navigator.mediaDevices.getUserMedia({audio:true});
    chunks=[]; recorder = new MediaRecorder(media);
    recorder.ondataavailable = e => { if (e.data.size>0) chunks.push(e.data); };
    recorder.start(100);
    startedAt=performance.now(); clearInterval(timerInt); timerInt=setInterval(updateTimer,200);
    $("#timer").textContent="00:00";
  }catch(e){ console.error(e); toast("Mic permission denied."); }
}
function stopRec(){
  try{
    recorder && recorder.state!=="inactive" && recorder.stop();
    media && media.getTracks().forEach(t=>t.stop());
  }catch{}
  clearInterval(timerInt);
}

/* ================== ANALYZE ================== */
let alreadyRan = localStorage.getItem("ec_first_run_done")==="yes";
let feedbackOK = localStorage.getItem("ec_feedback_ok")==="yes";

async function analyze(){
  if (!alreadyRan || feedbackOK){ /* allowed */ }
  else { openFeedback(); return; }

  if (chunks.length===0){ toast("Please record something first."); return; }

  const blob = new Blob(chunks, {type:"audio/webm"});
  const file = new File([blob], "audio.webm", {type:blob.type});
  const fd = new FormData();
  fd.append("files[]", file);
  fd.append("duration_sec", ((performance.now()-startedAt)/1000).toFixed(0));
  fd.append("goal", goal);

  try{
    $("#btnSend").disabled = true;
    const res = await fetch(ANALYZE_API, {method:"POST", body:fd});
    const raw = await res.text();
    let js;
    try{ js = JSON.parse(raw); }catch{ js = { fallback:true, rationale:"We didn’t catch enough speech to analyze." } }

    // Handle fallback from server or empty JSON
    const isFallback = js.fallback || !js.cefr_estimate;

    // Fill UI
    $("#level").textContent      = js.cefr_estimate || "–";
    $("#fillers").textContent    = js.fluency?.fillers ?? 0;
    $("#fixnow").textContent     = js.one_thing_to_fix || "–";
    $("#nextprompt").textContent = js.next_prompt || "–";
    $("#grammar").textContent    = (js.grammar_issues && js.grammar_issues.length)
                                      ? js.grammar_issues.map(g=>`→ ${g.error} → ${g.fix}`).join("\n")
                                      : "–";
    $("#pron").textContent       = (js.pronunciation && js.pronunciation.length)
                                      ? js.pronunciation.map(p=>`${p.sound_or_word} — ${p.issue}`).join("\n")
                                      : "–";

    if (!alreadyRan){ alreadyRan=true; localStorage.setItem("ec_first_run_done","yes"); openFeedback(); }

  }catch(e){
    console.error(e); toast("Request failed.");
  }finally{
    $("#btnSend").disabled = false;
  }
}

/* ================== FEEDBACK (required after first run) ================== */
const modal=$("#modal");
const nameEl=$("#fbName"), mailEl=$("#fbEmail"), msgEl=$("#fbMsg");
const starsWrap=$("#stars"); let rating=5;
function openFeedback(){
  // Prefill from localStorage
  nameEl.value = localStorage.getItem("ec_name") || "";
  mailEl.value = localStorage.getItem("ec_email") || "";
  msgEl.value  = "";
  setStars(rating);
  modal.classList.add("show");
  modal.setAttribute("aria-hidden","false");
}
function closeFeedback(){
  modal.classList.remove("show");
  modal.setAttribute("aria-hidden","true");
}
function setStars(n){
  rating=n;
  [...starsWrap.children].forEach((s,i)=>s.classList.toggle("active", i<n));
}
starsWrap.addEventListener("click", e=>{
  const idx=[...starsWrap.children].indexOf(e.target);
  if (idx>-1) setStars(idx+1);
});

$("#fbCancel").addEventListener("click", ()=>closeFeedback());
$("#fbSubmit").addEventListener("click", async ()=>{
  const name=nameEl.value.trim();
  const email=mailEl.value.trim();
  const text=msgEl.value.trim();
  if (!name || !email || !text){ toast("Please fill in all fields."); return; }

  localStorage.setItem("ec_name", name);
  localStorage.setItem("ec_email", email);

  try{
    if (FEEDBACK_API && !FEEDBACK_API.startsWith("PUT_")){
      const payload = { user_name:name, user_email:email, rating, suggestions:text, ts: new Date().toISOString() };
      await fetch(FEEDBACK_API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    }
    localStorage.setItem("ec_feedback_ok","yes");
    feedbackOK = true;
    closeFeedback();
    toast("Thanks for your feedback!");
  }catch{
    toast("Feedback endpoint not configured.");
    // Still allow continuing for demo purposes:
    localStorage.setItem("ec_feedback_ok","yes");
    feedbackOK = true;
    closeFeedback();
  }
});

/* ================== EVENTS ================== */
$("#goals").addEventListener("click", (e)=>{ const x=e.target.closest(".chip"); if(!x) return; setGoal(x.dataset.goal) });
$("#btnStart").addEventListener("click", async ()=>{
  if (alreadyRan && !feedbackOK){ openFeedback(); return; }
  await startRec();
});
$("#btnStop").addEventListener("click", stopRec);
$("#btnSend").addEventListener("click", analyze);
$("#btnRandom").addEventListener("click", randomizeStarter);
$("#btnCopy").addEventListener("click", ()=>{ navigator.clipboard.writeText($("#starter").textContent); toast("Copied") });

/* ================== INIT ================== */
setGoal(goal);
</script>
</body>
</html>
