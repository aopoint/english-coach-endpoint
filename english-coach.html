<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>English Coach â€” Instant Feedback</title>

  <!-- ===== Styles (simple, responsive, dark) ===== -->
  <style>
    :root{
      --bg:#0f1115; --panel:#171a21; --panel-2:#1c2028;
      --text:#e9ecf1; --muted:#9aa3af; --brand:#7c3aed; --brand-2:#8b5cf6;
      --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --chip:#2a2f3a; --line:#262b36;
      --card:#131720;
      --shadow:0 6px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *,*:before,*:after{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      background:linear-gradient(180deg,#0f1115 0%, #0d1014 100%);
      color:var(--text);
    }
    .wrap{max-width:1260px; margin:24px auto; padding:0 16px}
    header{
      display:flex; align-items:center; gap:14px; margin:8px 0 18px;
    }
    .logo{
      width:22px; height:22px; border-radius:6px;
      background:linear-gradient(135deg,var(--brand) 0%, var(--brand-2) 100%);
      box-shadow:0 4px 18px rgba(139,92,246,.35);
    }
    h1{font-size:22px; margin:0}
    .signin{
      margin-left:auto; font-size:14px; color:var(--muted)
    }
    .signin a{color:#c4b5fd; text-decoration:none}
    .grid{
      display:grid; grid-template-columns: 340px 1fr; gap:18px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:var(--panel); border:1px solid var(--line);
      border-radius:var(--radius); box-shadow:var(--shadow);
    }
    .card h3{
      margin:0 0 8px; font-size:14px; color:#cbd5e1; letter-spacing:.02em;
      text-transform:uppercase;
    }
    .left .block{padding:16px}
    .right .block{padding:16px}
    .title{
      padding:18px 16px 8px; border-bottom:1px solid var(--line)
    }
    .sub{color:var(--muted); font-size:14px}
    .goals{display:flex; flex-wrap:wrap; gap:10px; margin:12px 0}
    .chip{
      background:var(--chip); border:1px solid var(--line); color:var(--text);
      padding:10px 14px; border-radius:12px; cursor:pointer; user-select:none;
    }
    .chip.active{
      background:linear-gradient(135deg,var(--brand),var(--brand-2));
      border-color:transparent; box-shadow:0 8px 28px rgba(124,58,237,.35);
    }
    .controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    button{
      border:0; padding:12px 16px; border-radius:12px; font-weight:600; color:#fff;
      background:var(--panel-2); cursor:pointer;
    }
    .btn-brand{
      background:linear-gradient(135deg,var(--brand) 0%, var(--brand-2) 100%);
      box-shadow:0 12px 30px rgba(139,92,246,.35);
    }
    .btn-dim{background:#232937; color:#d6dae2}
    .btn-ghost{background:#1b202b; color:#d6dae2}
    .btn-disabled{opacity:.5; cursor:not-allowed}
    .timer{
      min-width:120px; font-size:28px; font-weight:800;
      background:#121621; padding:10px 14px; border-radius:14px; text-align:center;
      border:1px solid var(--line);
    }
    .meter{
      position:relative; height:10px; background:#121621; border:1px solid var(--line);
      border-radius:999px; overflow:hidden; flex:1;
    }
    .meter > span{
      position:absolute; left:0; top:0; bottom:0; width:0%;
      background:linear-gradient(90deg,#ef4444,#f59e0b,#10b981);
      transition:width .2s ease;
    }
    .muted{color:var(--muted)}
    .panel-list{display:flex; flex-direction:column; gap:10px}
    .pill{font-size:12px; padding:6px 10px; border-radius:24px; background:#111520; border:1px solid var(--line); color:#cbd5e1}
    .result{
      background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px 14px;
    }
    .result + .result{margin-top:8px}
    .pair b{color:#e5e7eb}
    footer{
      color:var(--muted); font-size:13px; text-align:center; margin:20px 0 10px
    }
    .live{display:inline-flex; align-items:center; gap:8px; font-size:13px}
    .dot{width:8px; height:8px; border-radius:99px; background:#6366f1}
    .dot.live{background:#10b981; box-shadow:0 0 0 6px rgba(16,185,129,.12)}
    .badge{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; background:#101421; border:1px solid var(--line); border-radius:999px; color:#d3d7df}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .hidden{display:none!important}
    input[type="text"],input[type="email"],textarea{
      background:#0f1420; border:1px solid var(--line); color:var(--text);
      padding:10px 12px; border-radius:10px; width:100%;
    }
    .right h4{margin:14px 0 8px}
  </style>

  <!-- ===== Load order matters: Supabase SDK, then your config, THEN app code ===== -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/config.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <h1>English Coach</h1>
      <div class="signin">
        <span id="userName" class="muted">Guest</span>
        Â· <a href="#" id="signinLink">Sign in</a>
        <span class="hidden"> Â· <a href="#" id="signoutLink">Sign out</a></span>
      </div>
    </header>

    <div class="grid">
      <!-- ========== LEFT: Controls ========== -->
      <div class="left">
        <div class="card title">
          <div style="display:flex;align-items:center;gap:10px;justify-content:space-between">
            <div>
              <div style="font-weight:800;font-size:18px">Record for 60â€“90 seconds.</div>
              <div class="sub">Weâ€™ll analyze fluency & correctness, then show key corrections and a next prompt.</div>
            </div>
          </div>
        </div>

        <div class="card block">
          <h3>Goal</h3>
          <div class="goals" id="goals">
            <div class="chip active" data-goal="Work English">Work English</div>
            <div class="chip" data-goal="Daily Life">Daily Life</div>
            <div class="chip" data-goal="Interview Prep">Interview Prep</div>
            <div class="chip" data-goal="Travel">Travel</div>
            <div class="chip" data-goal="Presentation">Presentation</div>
          </div>

          <div class="controls" style="margin-top:10px">
            <button id="btnStart" class="btn-brand">â–¶ï¸Ž Start recording</button>
            <button id="btnStop"  class="btn-dim" disabled>â–  Stop</button>
          </div>

          <div class="controls" style="margin-top:10px">
            <div class="timer" id="timer">00:00</div>
            <div class="meter"><span id="meter"></span></div>
          </div>

          <div class="controls" style="margin-top:14px">
            <button id="btnSend" class="btn-brand btn-disabled" disabled>Send & Analyze</button>
          </div>
        </div>

        <div class="card block">
          <h3>What to say to start</h3>
          <div class="result" id="prompt">
            Describe a recent project you led and one lesson you learned.
          </div>
          <div class="row" style="margin-top:10px">
            <button id="btnRnd" class="btn-ghost">ðŸŽ² Randomize prompt</button>
            <span class="pill"><span id="liveChip" class="dot"></span> <span id="statusText">Idle</span></span>
          </div>
        </div>

        <div class="card block">
          <div class="row">
            <span class="pill">Level: <b id="levelLabel" style="margin-left:6px">â€“</b></span>
            <span class="pill">Fillers: <b id="fillers" style="margin-left:6px">0</b></span>
            <span class="pill">Sessions: <b id="sessions" style="margin-left:6px">0</b></span>
          </div>
          <div class="meter" style="margin-top:10px"><span id="meterLvl"></span></div>
        </div>
      </div>

      <!-- ========== RIGHT: Results ========== -->
      <div class="right">
        <div class="card block">
          <div class="row" style="justify-content:space-between;margin-bottom:8px">
            <span class="live"><span id="liveDot" class="dot"></span> <span id="liveText">Idle</span></span>
            <span class="badge">v<span id="ver">â€”</span></span>
          </div>

          <h3>Pronunciation</h3>
          <div id="pronBox" class="panel-list">
            <div class="result muted">â€“</div>
          </div>

          <h3 style="margin-top:12px">Grammar</h3>
          <div id="gramBox" class="panel-list">
            <div class="result muted">â€“</div>
          </div>

          <h3 style="margin-top:12px">What to fix now</h3>
          <div id="fixBox" class="result">â€“</div>

          <h3 style="margin-top:12px">Next prompt (30â€“45s)</h3>
          <div id="nextBox" class="result">â€“</div>

          <h3 style="margin-top:12px">Leaderboard</h3>
          <div id="leadBox" class="result">Public leaderboard requires sign-in. Youâ€™ll still see your local totals below.</div>
        </div>
      </div>
    </div>

    <footer>
      Â© 2025 <a href="https://simpleia.com" target="_blank" style="color:#c4b5fd;text-decoration:none">Simpleia</a> â€”
      Built by <a href="https://aosama.net" target="_blank" style="color:#c4b5fd;text-decoration:none">Abdo Osama</a>
      Â· <span id="verFoot"></span>
    </footer>
  </div>

  <!-- ===== Main App (runs AFTER Supabase + config) ===== -->
  <script>
  (function(){
    // --- 0) Read config safely ---
    const cfg = window.APP_CONFIG || {};
    const SUPABASE_URL  = cfg.SUPABASE_URL  || "";
    const SUPABASE_KEY  = cfg.SUPABASE_ANON_KEY || "";
    const API_URL       = cfg.API_URL || "";
    const VERSION       = cfg.VERSION || "";

    // put version text if the element exists
    const verEl = document.getElementById('ver');
    if (verEl) verEl.textContent = VERSION || '';
    const verFoot = document.getElementById('verFoot');
    if (verFoot) verFoot.textContent = VERSION || '';

    // --- 1) Supabase client ---
    const supabase = (SUPABASE_URL && SUPABASE_KEY && window.supabase)
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)
      : null;

    // --- 2) UI refs ---
    const btnStart   = document.getElementById('btnStart');
    const btnStop    = document.getElementById('btnStop');
    const btnSend    = document.getElementById('btnSend');
    const btnRnd     = document.getElementById('btnRnd');

    const timerEl    = document.getElementById('timer');
    const meterEl    = document.getElementById('meter');
    const meterLvlEl = document.getElementById('meterLvl');

    const goalsEl    = document.getElementById('goals');
    const promptEl   = document.getElementById('prompt');

    const liveChip   = document.getElementById('liveChip');
    const liveDot    = document.getElementById('liveDot');
    const liveText   = document.getElementById('liveText');

    const levelLabel = document.getElementById('levelLabel');
    const fillersEl  = document.getElementById('fillers');
    const sessionsEl = document.getElementById('sessions');

    const pronBox = document.getElementById('pronBox');
    const gramBox = document.getElementById('gramBox');
    const fixBox  = document.getElementById('fixBox');
    const nextBox = document.getElementById('nextBox');
    const leadBox = document.getElementById('leadBox');

    const signinLink  = document.getElementById('signinLink');
    const signoutLink = document.getElementById('signoutLink');
    const userNameEl  = document.getElementById('userName');

    // --- 3) State ---
    let mediaStream = null;
    let mediaRec    = null;
    let chunks      = [];
    let intTimer    = null;
    let t0          = 0;

    let currentUser = null;
    let localCount  = Number(localStorage.getItem('ec_sessions')||"0");
    sessionsEl.textContent = String(localCount);

    const prompts = [
      "Describe a recent project you led and one lesson you learned.",
      "Tell me about your last weekend in 45 seconds.",
      "Explain one problem your team faced and how you solved it.",
      "Share a time you had to persuade someone at work. What happened?",
      "Talk about a product you use daily and why you like it."
    ];

    function setStatus(label, live=false){
      liveText.textContent = label;
      (live ? liveDot.classList.add('live') : liveDot.classList.remove('live'));
      (live ? liveChip.classList.add('live') : liveChip.classList.remove('live'));
      document.getElementById('statusText').textContent = label;
    }
    setStatus('Idle', false);

    // --- 4) Auth (top-left link only) ---
    async function refreshUser(){
      if (!supabase) return;
      const { data: { user } } = await supabase.auth.getUser();
      currentUser = user || null;
      if (currentUser){
        userNameEl.textContent = currentUser.user_metadata?.name || currentUser.email || 'User';
        signinLink.parentElement.querySelector('#signoutLink').parentElement.classList.remove('hidden');
        signinLink.textContent = 'Switch account';
        // update leaderboard
        showLeaderboard();
      }else{
        userNameEl.textContent = 'Guest';
        signinLink.textContent  = 'Sign in';
        signinLink.parentElement.querySelector('#signoutLink').parentElement.classList.add('hidden');
        showLeaderboard(); // will show local count
      }
    }

    async function signInGoogle(){
      if (!supabase){ alert('Supabase client not available. Check config.js.'); return; }
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: location.origin + location.pathname }
      });
      if (error) alert(error.message);
    }
    async function signOut(){
      if (!supabase) return;
      await supabase.auth.signOut();
      currentUser = null;
      refreshUser();
    }

    signinLink.addEventListener('click', e => {e.preventDefault(); signInGoogle();});
    signoutLink.addEventListener('click', e => {e.preventDefault(); signOut();});

    if (supabase){
      supabase.auth.onAuthStateChange(refreshUser);
      refreshUser();
    }

    // --- 5) Goals ---
    function currentGoal(){
      const active = goalsEl.querySelector('.chip.active');
      return active ? active.dataset.goal : 'Work English';
    }
    goalsEl.addEventListener('click', (e)=>{
      const chip = e.target.closest('.chip'); if(!chip) return;
      goalsEl.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      chip.classList.add('active');
    });

    // --- 6) Timer & meter ---
    function fmt(sec){
      const m = Math.floor(sec/60).toString().padStart(2,'0');
      const s = Math.floor(sec%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }
    function setTimer(sec){
      timerEl.textContent = fmt(sec);
      // progress from 0..90 seconds
      const pct = Math.min(100, Math.floor((sec/90)*100));
      meterEl.style.width = pct + '%';
    }

    // --- 7) Recording ---
    async function startRec(){
      // soft gate: if already did 1 session and not signed in, nudge to sign in
      if (!currentUser && localCount >= 1){
        alert('Sign in to save progress and join the leaderboard.');
      }

      setStatus('Recordingâ€¦', true);
      btnStart.disabled = true; btnStart.classList.add('btn-disabled');
      btnStop.disabled  = false; btnStop.classList.remove('btn-disabled');
      btnSend.disabled  = true; btnSend.classList.add('btn-disabled');
      btnRnd.disabled   = true;

      chunks = []; t0 = Date.now(); setTimer(0); meterEl.style.width = '0%';

      try{
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true });
      }catch(err){
        setStatus('Mic blocked', false);
        alert('Microphone permission is required.');
        resetButtons(); return;
      }

      mediaRec = new MediaRecorder(mediaStream, { mimeType: 'audio/webm' });
      mediaRec.ondataavailable = (e)=>{ if (e.data && e.data.size) chunks.push(e.data); };
      mediaRec.onstop = ()=>{};
      mediaRec.start(100);
      intTimer = setInterval(()=>{
        const sec = (Date.now()-t0)/1000;
        setTimer(sec);
        if (sec >= 120) stopRec(); // hard cap 2 minutes
      }, 200);
    }

    function stopRec(){
      btnStop.disabled = true; btnStop.classList.add('btn-disabled');
      try{ mediaRec && mediaRec.state!=='inactive' && mediaRec.stop(); }catch{}
      try{ mediaStream && mediaStream.getTracks().forEach(t=>t.stop()); }catch{}
      clearInterval(intTimer); intTimer=null;

      setStatus('Ready to analyze', false);
      btnSend.disabled = false; btnSend.classList.remove('btn-disabled');
      btnRnd.disabled  = false;
    }

    function resetButtons(){
      btnStart.disabled = false; btnStart.classList.remove('btn-disabled');
      btnStop.disabled  = true;  btnStop.classList.add('btn-disabled');
      btnSend.disabled  = true;  btnSend.classList.add('btn-disabled');
      btnRnd.disabled   = false;
      setStatus('Idle', false);
    }

    btnStart.addEventListener('click', startRec);
    btnStop.addEventListener('click',  stopRec);

    // --- 8) Prompts ---
    btnRnd.addEventListener('click', ()=>{
      if (btnStart.disabled) return; // don't change mid recording
      const i = Math.floor(Math.random()*prompts.length);
      promptEl.textContent = prompts[i];
    });

    // --- 9) Analyze ---
    async function analyze(){
      if (!chunks.length){ alert('No audio recorded.'); return; }
      btnSend.disabled = true; btnSend.classList.add('btn-disabled');
      setStatus('Analyzingâ€¦', false);

      const blob = new Blob(chunks,{type:'audio/webm'});
      const fd   = new FormData();
      fd.append('files[]', blob, 'audio.webm');
      fd.append('duration_sec', Math.round((Date.now()-t0)/1000));
      fd.append('goal', currentGoal());
      fd.append('prompt_text', promptEl.textContent || '');

      try{
        const res = await fetch(API_URL, { method:'POST', body: fd });
        const json = await res.json();

        renderResult(json);

        // count + store
        localCount += 1; localStorage.setItem('ec_sessions', String(localCount));
        sessionsEl.textContent = String(localCount);

        // if signed in, save to supabase
        if (supabase && currentUser){
          await supabase.from('sessions').insert({
            user_id: currentUser.id,
            duration_sec: Math.round((Date.now()-t0)/1000),
            level_label: json.friendly_level || json.cefr_estimate || 'â€“',
            goal: currentGoal()
          });
          showLeaderboard();
        }
      }catch(err){
        console.error(err);
        alert('Analyze failed. Please try again.');
      }finally{
        resetButtons();
      }
    }
    btnSend.addEventListener('click', analyze);

    // --- 10) Render results ---
    function renderResult(json){
      // fallback
      if (json.fallback){
        levelLabel.textContent = 'Beginner';
        fillersEl.textContent = (json.fluency && json.fluency.fillers) ? String(json.fluency.fillers) : '0';
        pronBox.innerHTML = `<div class="result">${escapeHtml(json.rationale||'Try speaking for 45â€“90 seconds in full sentences.')}</div>`;
        gramBox.innerHTML = `<div class="result">${escapeHtml(json.one_thing_to_fix||'Speak for 30â€“60 seconds.')}</div>`;
        fixBox.textContent = json.one_thing_to_fix || 'Speak for 30â€“60 seconds.';
        nextBox.textContent = json.next_prompt || 'Describe your last weekend in 45 seconds.';
        meterLvlEl.style.width = '25%';
        return;
      }

      // level + fillers
      const friendly = json.friendly_level || json.cefr_estimate || 'â€“';
      levelLabel.textContent = friendly;
      fillersEl.textContent = String(json.fluency?.fillers ?? 0);
      meterLvlEl.style.width = String(Math.max(0,Math.min(100, Number(json.level_score||50)))) + '%';

      // grammar
      gramBox.innerHTML = (Array.isArray(json.grammar_issues) && json.grammar_issues.length)
        ? json.grammar_issues.map(g => (
            `<div class="result">
               <div class="pair">â†’ ${escapeHtml(g.error||'')}</div>
               <div class="pair"><b>Try:</b> ${escapeHtml(g.fix||'')}</div>
               <div class="muted"><b>Why:</b> ${escapeHtml(g.why||'')}</div>
             </div>`
          )).join('')
        : `<div class="result muted">â€“</div>`;

      // pronunciation
      pronBox.innerHTML = (Array.isArray(json.pronunciation) && json.pronunciation.length)
        ? json.pronunciation.map(p => (
            `<div class="result">
               <div class="pair"><b>${escapeHtml(p.sound_or_word||'')}</b> â€” ${escapeHtml(p.issue||'')}</div>
               ${p.minimal_pair ? `<div class="muted">Try: ${escapeHtml(p.minimal_pair)}</div>`:''}
             </div>`
          )).join('')
        : `<div class="result muted">â€“</div>`;

      fixBox.textContent  = json.one_thing_to_fix || 'â€”';
      nextBox.textContent = json.next_prompt || 'â€”';
    }

    // --- 11) Leaderboard (simple) ---
    async function showLeaderboard(){
      if (!supabase || !currentUser){
        leadBox.innerHTML = `You â€” ${localCount} session${localCount===1?'':'s'} (sign in to appear on the public board).`;
        return;
      }
      try{
        const { data, error } = await supabase.rpc('top_users_by_sessions');
        if (error) throw error;
        if (!data || !data.length){
          leadBox.textContent = 'No public data yet.';
          return;
        }
        leadBox.innerHTML = data.slice(0,10).map((r,i)=>{
          const name = r.display ?? (r.email||'User');
          return `<div>${i+1}. ${escapeHtml(name)} â€” ${r.sessions} session${r.sessions===1?'':'s'}</div>`;
        }).join('');
      }catch(e){
        leadBox.textContent = 'Leaderboard unavailable.';
      }
    }

    // --- 12) Small helpers ---
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // Initial prompt randomization (looks nicer)
    (function initPrompt(){
      const i = Math.floor(Math.random()*prompts.length);
      promptEl.textContent = prompts[i];
    })();

  })();
  </script>
</body>
</html>
