<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>English Coach</title>
  <link rel="icon" href="data:image/svg+xml,\
  %3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1'%3E%3Cstop stop-color='%238d4bff'/%3E%3Cstop offset='1' stop-color='%23513cff'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect rx='14' ry='14' width='64' height='64' fill='url(%23g)'/%3E%3C/svg%3E" />
  <style>
    :root {
      --bg: #0f1012;
      --panel: #17181c;
      --panel-2: #1d1f24;
      --muted: #9aa3ad;
      --text: #e8ebf0;
      --brand1: #8d4bff;
      --brand2: #5b3bff;
      --ok: #39d98a;
      --warn: #ffcc66;
      --bad: #ff5c5c;
      --chip: #262a31;
      --shadow: 0 10px 28px rgba(0,0,0,.35);
      --radius: 16px;
    }
    * { box-sizing:border-box; }
    body {
      margin:0; background:var(--bg); color:var(--text);
      font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;
    }
    .wrap { max-width:1200px; margin:20px auto 60px; padding:0 16px; }
    header {
      display:flex; align-items:center; gap:14px; margin-bottom:16px;
    }
    .logo {
      width:24px; height:24px; border-radius:8px;
      background:linear-gradient(135deg,var(--brand1),var(--brand2));
      box-shadow: var(--shadow);
    }
    .title { font-size:20px; font-weight:700; letter-spacing:.2px; }
    .spacer { flex:1 }
    .top-links { display:flex; align-items:center; gap:14px; color:var(--muted); }
    .link { color:var(--muted); text-decoration:none; }
    .link:hover { color:#fff; }
    .chip { background:var(--chip); color:#cfd6dd; padding:6px 10px; border-radius:999px; }
    .ver { opacity:.6; }

    .grid {
      display:grid; grid-template-columns: 340px 1fr; gap:18px;
    }
    @media (max-width: 1000px) { .grid { grid-template-columns: 1fr; } }

    .card {
      background:var(--panel); border-radius:var(--radius); box-shadow: var(--shadow);
      padding:16px;
    }
    .card h3 { margin:0 0 10px; font-size:14px; text-transform:uppercase; letter-spacing:.12em; color:#cdd5df; }
    .subtle { color:var(--muted); }

    .goals { display:flex; flex-wrap:wrap; gap:10px; }
    .goal { background:#20242a; padding:10px 14px; border-radius:12px; color:#cdd5df; }
    .goal.active { color:#fff; background:linear-gradient(135deg,var(--brand1),var(--brand2)); box-shadow:0 8px 22px rgba(103,77,255,.35); }

    .row { display:flex; gap:10px; align-items:center; }
    .row.wrap { flex-wrap:wrap; }
    .btn {
      appearance:none; border:0; cursor:pointer; border-radius:14px;
      padding:14px 18px; background:linear-gradient(135deg,var(--brand1),var(--brand2)); color:#fff;
      font-weight:700; letter-spacing:.2px; box-shadow: var(--shadow);
      display:inline-flex; gap:8px; align-items:center; justify-content:center;
    }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .btn.gray { background:#262a31; color:#e6ecf3; }
    .btn.ghost { background:#20242a; color:#dbe3ea; }
    .timer {
      font-size:36px; font-weight:800; background:#121317; padding:14px 18px; border-radius:14px; min-width:160px; text-align:center;
    }
    .bar {
      height:10px; background:#232730; border-radius:999px; width:100%; position:relative; overflow:hidden;
    }
    .bar > i { position:absolute; left:0; top:0; bottom:0; width:0%; border-radius:999px;
      background:linear-gradient(90deg,#f55555,#ffb74a,#3dd982);
      transition: width .25s ease;
    }
    .list { display:flex; flex-direction:column; gap:10px; }
    .pill {
      background:var(--panel-2); border-radius:12px; padding:14px; color:#d9e0e7;
    }
    .empty { color:var(--muted); font-style:italic; }
    .kpis { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .kpi { background:#20242a; color:#d6dee6; padding:8px 10px; border-radius:999px; font-weight:600; }
    .kpi.ok { color:var(--ok); }
    .kpi.bad { color:#ff8686; }
    .table { width:100%; }
    .table .rowh, .table .rowd {
      display:grid; grid-template-columns: 1fr 120px; padding:10px 12px; gap:8px; align-items:center;
    }
    .table .rowh { color:#a9b4c0; text-transform:uppercase; letter-spacing:.1em; font-size:12px; }
    .table .rowd:nth-child(odd) { background:#1a1d23; border-radius:10px; }
    .table small { color:#96a1ad; }

    /* Modals */
    .modal {
      position:fixed; inset:0; background:rgba(8,9,11,.6); display:none; align-items:center; justify-content:center; z-index:40;
    }
    .modal > .box {
      background:var(--panel); border-radius:16px; width:min(560px, 92vw); padding:18px; box-shadow: var(--shadow);
    }
    .modal h2 { margin:0 0 8px; }
    .modal .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .input { width:100%; background:#20242a; color:#fff; border:0; padding:12px 14px; border-radius:12px; }
    .hr { height:1px; background:#232730; margin:14px 0; }
    .right { margin-left:auto }

    .muted { color:var(--muted) }
    footer { margin-top:20px; text-align:center; color:#9fa9b4; }
    .danger { color:#ff7a7a; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"></div>
      <div class="title">English Coach</div>
      <div class="spacer"></div>

      <a class="link" id="lnkFeedback" href="#">Give feedback</a>
      <span class="chip ver">v1.2.13</span>
      <span class="chip" id="chipUser"><a class="link" id="lnkAuth" href="#">Sign in</a></span>
    </header>

    <div class="grid">
      <!-- Left column: controls -->
      <div class="card">
        <h2 style="margin:4px 0 12px">Record for <b>60‚Äì90 seconds</b>.</h2>
        <div class="subtle" style="margin-bottom:16px">We‚Äôll analyze fluency & correctness, then show key corrections and a next prompt.</div>

        <h3>Goal</h3>
        <div class="goals" id="goalChips">
          <button class="goal active" data-goal="Work English">Work English</button>
          <button class="goal" data-goal="Daily Life">Daily Life</button>
          <button class="goal" data-goal="Interview Prep">Interview Prep</button>
          <button class="goal" data-goal="Travel">Travel</button>
          <button class="goal" data-goal="Presentation">Presentation</button>
        </div>

        <h3 style="margin-top:18px">Recording</h3>
        <div class="row wrap" style="gap:12px">
          <button id="btnStart" class="btn">
            <span>‚ñ∂</span> Start recording
          </button>
          <button id="btnStop" class="btn gray" disabled>
            ‚ñ™ Stop
          </button>
        </div>

        <div class="row" style="margin-top:12px; gap:14px; align-items:center">
          <div id="timer" class="timer">00:00</div>
          <div class="bar" title="Aim for 60‚Äì90 seconds">
            <i id="barFill"></i>
          </div>
        </div>

        <button id="btnAnalyze" class="btn" style="margin-top:12px; width:100%" disabled>Send & Analyze</button>

        <h3 style="margin-top:18px">What to say to start</h3>
        <div class="row" style="gap:10px; align-items:flex-start">
          <textarea id="promptText" class="input" rows="3" style="height:96px; resize:vertical">Describe a recent project you led and one lesson you learned.</textarea>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="btnRand" class="btn ghost">üé≤ Randomize prompt</button>
          <div class="spacer"></div>
          <div class="kpis">
            <span class="kpi" id="kStatus">Idle</span>
            <span class="kpi">Level: <b id="kLevel">‚Äì</b></span>
            <span class="kpi">Fillers: <b id="kFillers">0</b></span>
            <span class="kpi">Streak: <b id="kStreak">0</b></span>
            <span class="kpi">Sessions: <b id="kSessions">0</b></span>
          </div>
        </div>
      </div>

      <!-- Right column: results -->
      <div class="card">
        <div class="kpis" style="margin-bottom:12px">
          <span class="kpi" id="kLive">‚óè Idle</span>
          <span class="kpi">Level: <b id="kLevelTop">‚Äì</b></span>
          <span class="kpi">Fillers: <b id="kFillersTop">0</b></span>
          <span class="kpi" id="kSessionsTop">Sessions: 0</span>
        </div>

        <div class="list" id="resultsPane">
          <div>
            <h3>Pronunciation</h3>
            <div id="pron" class="pill empty">‚Äì</div>
          </div>

          <div>
            <h3>Grammar</h3>
            <div id="gram" class="pill empty">‚Äì</div>
          </div>

          <div>
            <h3>What to fix now</h3>
            <div id="fix" class="pill empty">‚Äì</div>
          </div>

          <div>
            <h3>Next prompt (30‚Äì45s)</h3>
            <div id="next" class="pill empty">‚Äì</div>
          </div>

          <div>
            <h3>Leaderboard</h3>
            <div class="table" id="leader">
              <div class="rowh"><div>User</div><div style="text-align:right">Sessions</div></div>
              <div class="rowd"><div>You</div><div style="text-align:right">0</div></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="muted">¬© 2025 <a class="link" target="_blank" href="https://simpleia.com">Simpleia</a> ‚Äî Built by <a class="link" target="_blank" href="https://aosama.net/">Abdo Osama</a></footer>
  </div>

  <!-- Sign-in modal -->
  <div class="modal" id="authModal" aria-hidden="true">
    <div class="box">
      <h2>Sign in</h2>
      <div class="muted">Sign in to save your streak and appear on the leaderboard.</div>
      <div class="actions">
        <button class="btn" id="btnGoogle">Continue with Google</button>
        <button class="btn ghost" id="btnFacebook">Continue with Facebook</button>
      </div>
      <div class="hr"></div>
      <div class="actions">
        <input id="emailLink" class="input" placeholder="you@email.com" />
        <button class="btn" id="btnEmailLink">Email sign-in link</button>
        <button class="btn gray right" id="btnCloseAuth">Close</button>
      </div>
    </div>
  </div>

  <!-- Feedback modal -->
  <div class="modal" id="fbModal" aria-hidden="true">
    <div class="box">
      <h2>Feedback</h2>
      <div class="row wrap">
        <input id="fbName" class="input" placeholder="Your name (optional)" style="flex:1" />
        <input id="fbEmail" class="input" placeholder="email@domain.com (optional)" style="flex:1" />
      </div>
      <div class="row" style="margin-top:8px">
        <label class="muted">Rating:</label>
        <div class="row" id="stars" style="gap:6px">
          <button class="btn ghost" data-star="1">‚òÖ</button>
          <button class="btn ghost" data-star="2">‚òÖ</button>
          <button class="btn ghost" data-star="3">‚òÖ</button>
          <button class="btn ghost" data-star="4">‚òÖ</button>
          <button class="btn ghost" data-star="5">‚òÖ</button>
        </div>
      </div>
      <textarea id="fbText" class="input" rows="5" placeholder="Suggestions / bugs / ideas"></textarea>
      <div class="actions">
        <button class="btn" id="btnSendFb">Submit feedback</button>
        <button class="btn gray right" id="btnCloseFb">Close</button>
      </div>
      <div class="muted" id="fbNote"></div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <script>
    // ==== CONFIG: replace these ====
    const SUPABASE_URL      = "https://cstwbjtbwwnxrsvpxqro.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzdHdianRid3dueHJzdnB4cXJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDg1OTgsImV4cCI6MjA3MDQyNDU5OH0.D-P8NWdJoro_pzSk6qoi5_Hl6Ohz_hiTZr4-fqmyXkM";
    const ANALYZE_URL       = "https://english-coach-endpoint-git-main-abelrahman-osamas-projects.vercel.app/api/analyze";

    // ==== Supabase client ====
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ==== UI handles ====
    const goalChips = document.getElementById('goalChips');
    let goal = 'Work English';
    goalChips.addEventListener('click', (e)=>{
      if(e.target.closest('.goal')) {
        [...goalChips.querySelectorAll('.goal')].forEach(x=>x.classList.remove('active'));
        e.target.closest('.goal').classList.add('active');
        goal = e.target.closest('.goal').dataset.goal;
      }
    });

    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const btnAnalyze = document.getElementById('btnAnalyze');
    const btnRand = document.getElementById('btnRand');
    const timerEl = document.getElementById('timer');
    const barFill = document.getElementById('barFill');
    const promptText = document.getElementById('promptText');

    const kStatus = document.getElementById('kStatus');
    const kLevel = document.getElementById('kLevel');
    const kFillers = document.getElementById('kFillers');
    const kStreak = document.getElementById('kStreak');
    const kSessions = document.getElementById('kSessions');

    const kLive = document.getElementById('kLive');
    const kLevelTop = document.getElementById('kLevelTop');
    const kFillersTop = document.getElementById('kFillersTop');
    const kSessionsTop = document.getElementById('kSessionsTop');

    const elPron = document.getElementById('pron');
    const elGram = document.getElementById('gram');
    const elFix  = document.getElementById('fix');
    const elNext = document.getElementById('next');
    const leader = document.getElementById('leader');

    const lnkAuth = document.getElementById('lnkAuth');
    const chipUser = document.getElementById('chipUser');
    const authModal = document.getElementById('authModal');
    const btnGoogle = document.getElementById('btnGoogle');
    const btnFacebook = document.getElementById('btnFacebook');
    const btnEmailLink = document.getElementById('btnEmailLink');
    const emailLink = document.getElementById('emailLink');
    const btnCloseAuth = document.getElementById('btnCloseAuth');

    const fbModal = document.getElementById('fbModal');
    const lnkFeedback = document.getElementById('lnkFeedback');
    const btnCloseFb = document.getElementById('btnCloseFb');
    const btnSendFb = document.getElementById('btnSendFb');
    const fbName = document.getElementById('fbName');
    const fbEmail = document.getElementById('fbEmail');
    const fbText = document.getElementById('fbText');
    const fbNote = document.getElementById('fbNote');
    let fbRating = 0;
    document.getElementById('stars').addEventListener('click', (e)=>{
      const b = e.target.closest('button'); if(!b) return;
      fbRating = +b.dataset.star;
      [...e.currentTarget.querySelectorAll('button')].forEach((x,i)=>{
        x.classList.toggle('gray', i+1>fbRating);
      });
    });

    // ===== Sign-in UX =====
    function show(el, on=true){ el.style.display = on?'flex':'none'; el.setAttribute('aria-hidden', on?'false':'true'); }
    lnkAuth.addEventListener('click', (e)=>{ e.preventDefault(); openAuth(); });
    function openAuth(){ show(authModal, true); }
    btnCloseAuth.onclick = () => show(authModal, false);

    btnGoogle.onclick = async ()=>{
      await sb.auth.signInWithOAuth({ provider:'google', options:{ redirectTo: location.href }});
    };
    btnFacebook.onclick = async ()=>{
      await sb.auth.signInWithOAuth({ provider:'facebook', options:{ redirectTo: location.href }});
    };
    btnEmailLink.onclick = async ()=>{
      const email = emailLink.value.trim();
      if(!email) return alert('Type your email');
      const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: location.href } });
      alert(error ? error.message : 'Check your inbox for the sign-in link.');
    };

    // Feedback modal
    lnkFeedback.onclick = (e)=>{ e.preventDefault(); show(fbModal,true); };
    btnCloseFb.onclick = ()=> show(fbModal,false);
    btnSendFb.onclick = async ()=>{
      const { data: { user }} = await sb.auth.getUser();
      const payload = {
        name: fbName.value || null,
        email: fbEmail.value || null,
        text: fbText.value || null,
        rating: fbRating||3,
        user_id: user?.id ?? null
      };
      const { error } = await sb.from('feedback').insert(payload);
      fbNote.textContent = error ? error.message : 'Thanks! Feedback submitted.';
      if(!error) setTimeout(()=>show(fbModal,false), 900);
    };

    // === Auth state, streak, leaderboard ===
    let currentUser = null;
    async function refreshAuthUI(){
      const { data:{user} } = await sb.auth.getUser();
      currentUser = user;
      if(user){
        chipUser.innerHTML = `<span class="chip">Hi, ${user.email?.split('@')[0]||'you'} ‚Ä¢ <a class="link" href="#" id="lnkOut">Sign out</a></span>`;
        document.getElementById('lnkOut').onclick = async (e)=>{ e.preventDefault(); await sb.auth.signOut(); location.reload(); };
        show(authModal,false);
        await refreshStats();
      }else{
        chipUser.innerHTML = `<a class="link" id="lnkAuth" href="#">Sign in</a>`;
        chipUser.querySelector('#lnkAuth').onclick = (e)=>{ e.preventDefault(); openAuth(); };
        kStreak.textContent = '0'; kSessions.textContent='0'; kSessionsTop.textContent='Sessions: 0';
      }
    }

    async function refreshStats(){
      if(!currentUser) return;
      // sessions count
      const { data:sess, error } = await sb.from('sessions').select('created_at').eq('user_id', currentUser.id).order('created_at', { ascending:false });
      if(error) return;
      const sessions = sess?.length || 0;
      kSessions.textContent = sessions; kSessionsTop.textContent = `Sessions: ${sessions}`;
      // streak (days)
      kStreak.textContent = computeStreak(sess||[]);
      // leaderboard (RPC if exists, otherwise fallback)
      let rows = [];
      const rpc = await sb.rpc('top_users_by_sessions');
      if(!rpc.error && rpc.data) rows = rpc.data;
      else {
        const agg = await sb.from('sessions').select('user_id, users(email)', { count:'exact', head:false }).not('user_id','is',null);
        // Fallback omitted for brevity when RLS; we‚Äôll just show ‚ÄúYou‚Äù.
      }
      leader.innerHTML = `<div class="rowh"><div>User</div><div style="text-align:right">Sessions</div></div>` +
        (rows?.length? rows.slice(0,10).map(r=>(
          `<div class="rowd"><div>${displayName(r)}</div><div style="text-align:right">${r.sessions||r.count||0}</div></div>`
        )).join('') : `<div class="rowd"><div>You</div><div style="text-align:right">${sessions}</div></div>`);
      function displayName(r){
        const n = r.display || r.display_text || r.email || (r.user_id||'').slice(0,6)+'‚Ä¶';
        return n;
      }
      function computeStreak(list){
        if(list.length===0) return 0;
        const days = new Set(list.map(x=> new Date(x.created_at).toISOString().slice(0,10)));
        let d = new Date(); let streak=0;
        for(;;){
          const key = d.toISOString().slice(0,10);
          if(days.has(key)){ streak++; d.setDate(d.getDate()-1); } else break;
        }
        return streak;
      }
    }

    // ===== Recording =====
    let media, rec, chunks=[], dur=0, tInt=null, freeUsed = localStorage.getItem('ec_free_used') === '1';
    const MAX_SEC = 90;

    function fmt(s){ s=Math.max(0,s|0); const m=String((s/60|0)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`; }
    function setTimer(s){ timerEl.textContent = fmt(s); const pct = Math.min(100, (s/90)*100); barFill.style.width = pct+'%'; barFill.style.background = s<20?'#ff6666': s<60?'linear-gradient(90deg,#ffb84d,#ffd44d)':'linear-gradient(90deg,#68f3b2,#3dd982)'; }

    btnStart.onclick = async ()=>{
      try{
        btnStart.disabled = true; btnStop.disabled=false; btnAnalyze.disabled=true; btnRand.disabled=true;
        kStatus.textContent='Recording'; kLive.textContent='‚óè Live';
        media = await navigator.mediaDevices.getUserMedia({ audio:true });
        rec = new MediaRecorder(media);
        chunks = []; dur=0; setTimer(0);
        rec.ondataavailable = e=>{ if(e.data.size) chunks.push(e.data); };
        rec.onstop = ()=>{};
        rec.start(250);
        tInt = setInterval(()=>{
          dur++; setTimer(dur);
          if(dur>=MAX_SEC){ stopRec(); }
        },1000);
      }catch(e){
        alert('Microphone error: '+e.message);
        resetUI();
      }
    };
    btnStop.onclick = ()=> stopRec();

    function stopRec(){
      if(!rec) return;
      rec.stop(); media.getTracks().forEach(t=>t.stop());
      clearInterval(tInt); tInt=null;
      kStatus.textContent='Stopped'; kLive.textContent='‚óè Idle';
      btnStop.disabled=true; btnAnalyze.disabled=false; btnRand.disabled=false; btnStart.disabled=false;
    }

    function resetUI(){
      clearInterval(tInt); tInt=null;
      btnStart.disabled=false; btnStop.disabled=true; btnAnalyze.disabled=true; btnRand.disabled=false;
      setTimer(0); kLive.textContent='‚óè Idle'; kStatus.textContent='Idle';
    }

    // Gating: allow one free analysis without login, require auth from the second attempt
    btnAnalyze.onclick = async ()=>{
      const { data:{user} } = await sb.auth.getUser();
      if(!user && freeUsed){ openAuth(); return; } // require sign-in from 2nd run
      await analyze();
      // After first successful run mark free used
      if(!user && !freeUsed){ freeUsed = true; localStorage.setItem('ec_free_used','1'); }
    };

    async function analyze(){
      try{
        kStatus.textContent='Sending‚Ä¶'; btnAnalyze.disabled=true; btnStart.disabled=true; btnStop.disabled=true;
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const fd = new FormData();
        fd.append('files[]', new File([blob],'audio.webm',{type:'audio/webm'}));
        fd.append('duration_sec', String(dur));
        fd.append('goal', goal);
        fd.append('prompt_text', promptText.value||'');
        const resp = await fetch(ANALYZE_URL, { method:'POST', body:fd });
        const json = await resp.json();

        renderResults(json);
        resetUI(); // reset for next round

        // Save session if logged in
        const { data:{user} } = await sb.auth.getUser();
        if(user){
          await sb.from('sessions').insert({
            user_id: user.id,
            duration_sec: dur,
            level_label: json.friendly_level || json.cefr_estimate || '‚Äî',
            goal: goal
          });
          await refreshStats();
        }
      }catch(e){
        alert('Analyze failed: '+(e?.message||'unknown'));
        btnAnalyze.disabled=false;
      }
    }

    function renderResults(j){
      // fallback case
      const level = j.friendly_level || j.cefr_estimate || '‚Äì';
      const fillers = j.fluency?.fillers ?? 0;
      kLevel.textContent = level; kLevelTop.textContent = level;
      kFillers.textContent = fillers; kFillersTop.textContent = fillers;

      // Pronunciation
      if(j.pronunciation && j.pronunciation.length){
        elPron.classList.remove('empty');
        elPron.innerHTML = j.pronunciation.map(p=>(
          `<div style="margin-bottom:10px"><b>${escape(p.sound_or_word||'')}</b> ‚Äî ${escape(p.issue||'')}
            <div class="muted">Try: ${escape(p.minimal_pair||'-')}</div></div>`
        )).join('');
      }else{ elPron.classList.add('empty'); elPron.textContent='‚Äì'; }

      // Grammar
      if(j.grammar_issues && j.grammar_issues.length){
        elGram.classList.remove('empty');
        elGram.innerHTML = j.grammar_issues.map(g=>(
          `<div style="margin-bottom:10px">‚Üí ${escape(g.error||'')}
             <div class="muted">Try: ${escape(g.fix||'')}</div>
             <div class="muted">Why: ${escape(g.why||'')}</div></div>`
        )).join('');
      }else{ elGram.classList.add('empty'); elGram.textContent='‚Äì'; }

      // What to fix + next prompt
      elFix.classList.toggle('empty', !j.one_thing_to_fix);
      elFix.textContent = j.one_thing_to_fix || '‚Äî';

      elNext.classList.toggle('empty', !j.next_prompt);
      elNext.textContent = j.next_prompt || '‚Äî';
    }

    function escape(s){ return String(s||'').replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

    // random prompts
    const PROMPTS = [
      "Describe a recent project you led and one lesson you learned.",
      "Tell me about a challenge you faced at work and how you solved it.",
      "Describe your typical day and one change you want to make.",
      "Talk about your favorite place to visit and why.",
      "Explain a problem your team faced and how you solved it."
    ];
    btnRand.onclick = ()=>{
      if(!btnStart.disabled) {
        const p = PROMPTS[(Math.random()*PROMPTS.length|0)];
        promptText.value = p;
      }
    };

    // Disable randomize while recording
    const mo = new MutationObserver(()=>{
      btnRand.disabled = !btnStart.disabled && !btnAnalyze.disabled ? false : btnStop.disabled ? false : true;
    });
    mo.observe(btnStart, { attributes:true });
    mo.observe(btnStop, { attributes:true });

    // init
    (async ()=>{
      await refreshAuthUI();
      setTimer(0);
    })();
  </script>
</body>
</html>
