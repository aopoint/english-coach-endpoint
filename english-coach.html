<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>English Coach</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='96' height='96'%3E%3Crect rx='16' width='96' height='96' fill='%238a2be2'/%3E%3C/svg%3E">
<style>
  :root{
    --bg:#0f0f12;--panel:#16161a;--chip:#202028;--text:#e9e9ee;--muted:#9a9aa6;--accent1:#7b2cf1;--accent2:#5c2df5;--ok:#27d1a0;--warn:#f0c032;--danger:#f06464;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1180px;margin:32px auto;padding:0 16px}
  header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
  .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--accent1),var(--accent2));box-shadow:0 0 0 2px #0006 inset}
  h1{margin:0;font-weight:800;font-size:24px}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:18px}
  @media (max-width:950px){.grid{grid-template-columns:1fr}}
  .card{background:var(--panel);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.25);padding:16px}
  .section-title{font-weight:700;margin:0 0 8px 0;letter-spacing:.2px}
  .chip-row{display:flex;flex-wrap:wrap;gap:10px;margin:6px 0 12px}
  .chip{background:var(--chip);color:var(--text);border-radius:12px;padding:10px 14px;font-weight:700}
  .chip.active{background:linear-gradient(135deg,var(--accent1),var(--accent2));box-shadow:0 10px 18px rgba(124,45,240,.25)}
  .btn{display:inline-flex;align-items:center;gap:10px;border:0;border-radius:16px;padding:14px 18px;font-weight:800;cursor:pointer;color:#fff;background:linear-gradient(135deg,var(--accent1),var(--accent2))}
  .btn.secondary{background:var(--chip);color:var(--text)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .timer{font-weight:900;font-size:34px;background:#111218;border-radius:14px;padding:10px 14px;min-width:150px;text-align:center}
  .bar{height:10px;border-radius:8px;background:#2a2a33;flex:1;position:relative;overflow:hidden}
  .bar>i{position:absolute;left:0;top:0;bottom:0;width:0;border-radius:8px;background:var(--danger);transition:width .3s ease,background .3s ease}
  .list{list-style:none;margin:6px 0 0;padding:0;display:grid;gap:8px}
  .item{background:#1a1a20;border-radius:12px;padding:12px}
  .muted{color:var(--muted)}
  footer{display:flex;justify-content:center;margin:20px 0 40px;color:var(--muted);gap:8px;font-size:13px}
  .badge{background:#1b1b23;padding:3px 8px;border-radius:10px}
  .km{display:flex;gap:8px;flex-wrap:wrap}
  .k{background:#1b1b23;border-radius:12px;padding:8px 10px;font-weight:700}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .danger{color:var(--danger)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo" aria-hidden="true"></div>
    <h1>English Coach</h1>
  </header>

  <div class="grid">
    <!-- Left column -->
    <aside class="card">
      <h2 class="section-title">Goal</h2>
      <div id="goalRow" class="chip-row">
        <button class="chip active" data-goal="Work English">Work English</button>
        <button class="chip" data-goal="Daily Life">Daily Life</button>
        <button class="chip" data-goal="Interview Prep">Interview Prep</button>
        <button class="chip" data-goal="Travel">Travel</button>
        <button class="chip" data-goal="Presentation">Presentation</button>
      </div>

      <div class="section-title" style="margin-top:12px">Recording</div>
      <div class="row">
        <button id="btnStart" class="btn"><span>‚ñ∂</span> Start recording</button>
        <button id="btnStop" class="btn secondary">‚ñ† Stop</button>
      </div>
      <div class="row" style="margin-top:8px">
        <div id="timer" class="timer">00:00</div>
        <div class="bar"><i id="timeFill"></i></div>
      </div>
      <button id="btnSend" class="btn" style="width:100%;margin-top:12px" disabled>Send & Analyze</button>

      <div class="section-title" style="margin-top:16px">What to say to start</div>
      <div class="item" id="promptBox">Describe a recent project you led and one lesson you learned.</div>
      <div class="row" style="margin-top:8px">
        <button id="btnRandom" class="btn secondary">üé≤ Randomize prompt</button>
        <span class="muted" style="margin-left:auto">We don‚Äôt store your audio; it‚Äôs sent to the analyzer and immediately discarded.</span>
      </div>
    </aside>

    <!-- Right column -->
    <main class="card">
      <div class="km" style="margin-bottom:12px">
        <span id="liveDot" class="k">‚óè <span class="muted">Live</span></span>
        <span class="k">Level: <b id="lvlTxt">‚Äì</b></span>
        <span class="k">Fillers: <b id="fillersTxt">0</b></span>
        <span class="k">Streak: <b id="streakTxt">0</b></span>
        <span class="k">Sessions: <b id="sessionsTxt">0</b></span>
      </div>

      <div class="km" style="margin-bottom:8px">
        <span class="k" style="min-width:240px">Level meter
          <span class="bar" style="width:140px;margin-left:8px"><i id="levelFill" style="width:0;background:var(--warn)"></i></span>
          <span id="levelPct" class="muted" style="margin-left:6px">0%</span>
        </span>
        <span class="k" style="min-width:240px">Relevancy
          <span class="bar" style="width:140px;margin-left:8px"><i id="relFill" style="width:0;background:var(--warn)"></i></span>
          <span id="relPct" class="muted" style="margin-left:6px">0%</span>
        </span>
      </div>

      <section>
        <h3 class="section-title">Pronunciation</h3>
        <ul id="pronList" class="list"></ul>
      </section>

      <section style="margin-top:8px">
        <h3 class="section-title">Grammar</h3>
        <ul id="gramList" class="list"></ul>
      </section>

      <section style="margin-top:8px">
        <h3 class="section-title">What to fix now</h3>
        <div id="fixNow" class="item muted">‚Äì</div>
      </section>

      <section style="margin-top:8px">
        <h3 class="section-title">Next prompt (30‚Äì45s)</h3>
        <div id="nextPrompt" class="item muted">‚Äì</div>
      </section>

      <section style="margin-top:8px">
        <h3 class="section-title">Leaderboard</h3>
        <ul id="leaderboard-list" class="list"><li class="muted">Loading‚Ä¶</li></ul>
      </section>
    </main>
  </div>

  <footer>
    <span>¬© 2025 <a href="https://simpleia.com" target="_blank" rel="noopener" class="muted" style="text-decoration:none;color:inherit">Simpleia</a> ‚Äî Built by <a href="https://aosama.net" target="_blank" rel="noopener" class="muted" style="text-decoration:none;color:inherit">Abdo Osama</a></span>
    <span class="badge">v1.2.12</span>
  </footer>
</div>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* === CONFIG === */
const API_URL = "https://english-coach-endpoint-git-main-abelrahman-osamas-projects.vercel.app/api/analyze";    // <- change to your analyzer endpoint
// Supabase: paste from Supabase ‚Üí Settings ‚Üí API (Client Keys)
const SUPABASE_URL = "https://cstwbjtbwwnxrsvpxqro.supabase.co";             // <- CHANGE
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzdHdianRid3dueHJzdnB4cXJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDg1OTgsImV4cCI6MjA3MDQyNDU5OH0.D-P8NWdJoro_pzSk6qoi5_Hl6Ohz_hiTZr4-fqmyXkM";                    // <- CHANGE

/* === Supabase client & basic session logging === */
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const EC_USER_KEY = "ec_user_id";
const EC_SESSIONS_LOCAL = "ec_sessions_count";
const EC_STREAK = "ec_streak_days";
const EC_LAST_DAY = "ec_last_day";

function getLocalUserId(){
  let id = localStorage.getItem(EC_USER_KEY);
  if(!id){ id = crypto.randomUUID(); localStorage.setItem(EC_USER_KEY, id); }
  return id;
}

async function saveSessionToSupabase({ goal, duration_sec, result }){
  try{
    const user_id = getLocalUserId();
    const payload = {
      user_id,
      goal,
      duration_sec: Math.round(duration_sec||0),
      wpm: result?.fluency?.wpm ?? null,
      fillers: result?.fluency?.fillers ?? null,
      level_score: result?.level_score ?? null,
      relevance_score: result?.relevance?.score ?? null,
    };
    await sb.from("sessions").insert(payload).throwOnError();
  }catch(e){ console.warn("Supabase insert:", e.message); }
}

async function fetchAndRenderLeaderboard(){
  const UL = document.getElementById("leaderboard-list");
  try{
    const { data } = await sb.from("sessions").select("user_id, created_at");
    const counts = new Map();
    (data||[]).forEach(row => counts.set(row.user_id, (counts.get(row.user_id)||0)+1));
    const sorted = [...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
    if(!sorted.length){ UL.innerHTML = `<li class="muted">No sessions yet.</li>`; return; }
    const me = getLocalUserId();
    UL.innerHTML = sorted.map(([uid,cnt],i)=>(
      `<li>${i+1}. <span class="${uid===me?'ok':''}">${uid.slice(0,6)}‚Ä¶</span> ‚Äî <b>${cnt}</b> sessions</li>`
    )).join("");
  }catch(e){
    UL.innerHTML = `<li class="muted">Leaderboard unavailable</li>`;
  }
}

/* === UI / Recorder === */
const btnStart = document.getElementById("btnStart");
const btnStop  = document.getElementById("btnStop");
const btnSend  = document.getElementById("btnSend");
const btnRandom= document.getElementById("btnRandom");
const promptBox= document.getElementById("promptBox");
const timerEl  = document.getElementById("timer");
const timeFill = document.getElementById("timeFill");

const lvlTxt    = document.getElementById("lvlTxt");
const fillersTxt= document.getElementById("fillersTxt");
const streakTxt = document.getElementById("streakTxt");
const sessionsTxt = document.getElementById("sessionsTxt");
const levelFill = document.getElementById("levelFill");
const levelPct  = document.getElementById("levelPct");
const relFill   = document.getElementById("relFill");
const relPct    = document.getElementById("relPct");
const pronList  = document.getElementById("pronList");
const gramList  = document.getElementById("gramList");
const fixNowEl  = document.getElementById("fixNow");
const nextPromptEl = document.getElementById("nextPrompt");
const liveDot   = document.getElementById("liveDot");

const MAX_SEC = 95;
let media, rec, chunks = [];
let sec = 0, timerInt = null;
let currentGoal = "Work English";
let lastResult = null;

document.getElementById("goalRow").addEventListener("click", (e)=>{
  const b = e.target.closest("[data-goal]");
  if(!b) return;
  document.querySelectorAll("#goalRow .chip").forEach(c=>c.classList.remove("active"));
  b.classList.add("active");
  currentGoal = b.dataset.goal;
});

btnStart.onclick = async () => {
  try{
    btnStart.disabled = true;
    btnStop.disabled = false;
    btnSend.disabled = true;
    btnRandom.disabled = true;
    liveDot.innerHTML = "‚óè <span class='muted'>Live</span>";
    media = await navigator.mediaDevices.getUserMedia({ audio:true });
    rec = new MediaRecorder(media, { mimeType:"audio/webm" });
    chunks = [];
    rec.ondataavailable = e => e.data.size && chunks.push(e.data);
    rec.onstop = () => media.getTracks().forEach(t=>t.stop());
    rec.start(250);

    // timer
    sec = 0; paintTimer();
    clearInterval(timerInt);
    timerInt = setInterval(()=>{
      sec++; paintTimer();
      if(sec>=MAX_SEC) btnStop.click();
    }, 1000);
  }catch(e){
    alert("Mic permission error: "+e.message);
    btnStart.disabled = false;
  }
};

btnStop.onclick = () => {
  if(rec && rec.state!=="inactive") rec.stop();
  clearInterval(timerInt);
  btnSend.disabled = chunks.length===0;
  btnRandom.disabled = false;
  liveDot.innerHTML = "‚óè <span class='muted'>Idle</span>";
};

btnSend.onclick = async () => {
  if(!chunks.length) return;
  btnSend.disabled = true;

  const blob = new Blob(chunks, { type:"audio/webm" });
  const fd = new FormData();
  fd.append("files[]", blob, "audio.webm");
  fd.append("duration_sec", String(sec));
  fd.append("goal", currentGoal);
  fd.append("prompt_text", promptBox.textContent.trim());

  const res = await fetch(API_URL, { method:"POST", body:fd });
  const json = await res.json();
  renderResult(json);

  // reset state for next try
  chunks = [];
  sec = 0; paintTimer();
  liveDot.innerHTML = "‚óè <span class='muted'>Idle</span>";
  btnSend.disabled = true;

  // Save session + refresh leaderboard
  await postAnalysis(json, { goal: currentGoal, duration_sec: sec });
  await fetchAndRenderLeaderboard();

  // local counters / streak
  bumpLocalCounters();
};

btnRandom.onclick = () => {
  if(btnStart.disabled && !btnSend.disabled) return; // extra guard
  const options = [
    "Describe a recent project you led and one lesson you learned.",
    "Explain a challenge your team faced and how you solved it.",
    "Talk about a time you disagreed and how you handled it.",
    "Describe your typical day (~45s).",
    "What is one skill you want to improve and why?"
  ];
  promptBox.textContent = options[Math.floor(Math.random()*options.length)];
};

function paintTimer(){
  const mm = String(Math.floor(sec/60)).padStart(2,"0");
  const ss = String(sec%60).padStart(2,"0");
  timerEl.textContent = `${mm}:${ss}`;
  const pct = Math.min(100, Math.round((sec/MAX_SEC)*100));
  timeFill.style.width = pct+"%";
  // color ramp
  timeFill.style.background = sec<30 ? "var(--danger)" : (sec<60 ? "var(--warn)" : "var(--ok)");
}

// ‚Äî Render results
function renderResult(r){
  lastResult = r;
  // Level text
  const L = r.friendly_level || r.cefr_estimate || "‚Äì";
  lvlTxt.textContent = L;
  fillersTxt.textContent = r?.fluency?.fillers ?? 0;

  // meters
  levelPct.textContent = (r.level_score||0)+"%";
  levelFill.style.width = (r.level_score||0)+"%";
  levelFill.style.background = (r.level_score||0) > 66 ? "var(--ok)" : (r.level_score||0) > 33 ? "var(--warn)" : "var(--danger)";

  const rel = r?.relevance?.score ?? 0;
  relPct.textContent = rel+"%";
  relFill.style.width = rel+"%";
  relFill.style.background = rel>66 ? "var(--ok)" : rel>33 ? "var(--warn)" : "var(--danger)";

  // lists
  pronList.innerHTML = (r.pronunciation||[]).map(p => `
    <li class="item">
      <b>${escapeHTML(p.sound_or_word||"-")}</b> ‚Äî ${escapeHTML(p.issue||"-")}
      <div class="muted">Try: ${escapeHTML(p.minimal_pair||"-")}</div>
    </li>`).join("") || `<li class="muted">‚Äì</li>`;

  gramList.innerHTML = (r.grammar_issues||[]).map(g => `
    <li class="item">
      ‚Üí ${escapeHTML(g.error||"-")}
      <div>Try: ${escapeHTML(g.fix||"-")}</div>
      <div class="muted">Why: ${escapeHTML(g.why||"-")}</div>
    </li>`).join("") || `<li class="muted">‚Äì</li>`;

  fixNowEl.textContent = r.one_thing_to_fix || "‚Äì";
  nextPromptEl.textContent = r.next_prompt || "‚Äì";
}

function escapeHTML(s){ return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c])); }

/* === Sessions / streak counters === */
function bumpLocalCounters(){
  const today = new Date().toISOString().slice(0,10);
  const last = localStorage.getItem(EC_LAST_DAY);
  let streak = Number(localStorage.getItem(EC_STREAK)||0);
  if(!last || last===today){
    // same day, keep streak as is (counts once/day)
  }else{
    // if it's exactly next day -> +1 else reset
    const d1 = new Date(last); const d2 = new Date(today);
    const diff = (d2 - d1)/(1000*60*60*24);
    streak = diff===1 ? streak+1 : 1;
  }
  localStorage.setItem(EC_LAST_DAY, today);
  localStorage.setItem(EC_STREAK, String(streak||1));

  // session count (local)
  let localCount = Number(localStorage.getItem(EC_SESSIONS_LOCAL)||0) + 1;
  localStorage.setItem(EC_SESSIONS_LOCAL, String(localCount));

  streakTxt.textContent = localStorage.getItem(EC_STREAK)||"0";
  sessionsTxt.textContent = localStorage.getItem(EC_SESSIONS_LOCAL)||"0";
}

// Supabase hook called after analysis
async function postAnalysis(result, meta){
  await saveSessionToSupabase({ goal: meta?.goal, duration_sec: meta?.duration_sec, result });
}

document.addEventListener("DOMContentLoaded", ()=>{
  // initial numbers
  streakTxt.textContent   = localStorage.getItem(EC_STREAK)||"0";
  sessionsTxt.textContent = localStorage.getItem(EC_SESSIONS_LOCAL)||"0";
  fetchAndRenderLeaderboard();
});
</script>
</body>
</html>
