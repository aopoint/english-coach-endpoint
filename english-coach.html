<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>English Coach ‚Äî Instant English Feedback</title>
<meta name="color-scheme" content="dark">
<style>
  :root{
    --bg:#191919;
    --panel:#1f1f1f;
    --panel-2:#181818;
    --text:#f5f5f5;
    --muted:#a7a7a7;
    --chip:#222;
    --ok:#22c55e;
    --err:#ef4444;
    --ring:rgba(78,10,122,.45);
    --primary:#4E0A7A;
    --primary-2:#7123a7;
    --shadow:0 10px 30px rgba(0,0,0,.35);
    --radius:14px;
  }
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family:"Avenir Next",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  }
  .wrap{max-width:1200px; margin:24px auto; padding:0 16px}
  header{
    display:flex; align-items:center; gap:16px; margin-bottom:20px;
  }
  .brand{font-size:28px; font-weight:800; letter-spacing:.3px}
  .pill{font-size:14px; padding:8px 14px; border-radius:999px;
        background:linear-gradient(135deg,var(--primary),var(--primary-2)); box-shadow:var(--shadow)}
  .grid{
    display:grid; grid-template-columns:360px 1fr; gap:18px;
  }
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }

  .card{
    background:linear-gradient(180deg,var(--panel),var(--panel-2));
    border:1px solid #262626; border-radius:var(--radius); box-shadow:var(--shadow);
  }
  .card .inner{padding:18px}
  .title{font-weight:800; font-size:18px; margin-bottom:6px}
  .muted{color:var(--muted); font-size:14px}

  /* left control */
  .goal-chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{
    padding:8px 12px; border-radius:12px; background:var(--chip); color:#ddd; cursor:pointer;
    border:1px solid #2a2a2a; user-select:none; transition:.15s;
  }
  .chip:hover{border-color:#3a3a3a}
  .chip.active{background:linear-gradient(135deg,var(--primary),var(--primary-2)); color:#fff; border-color:transparent}
  .row{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .btn{
    appearance:none; border:0; border-radius:12px; padding:12px 16px; cursor:pointer;
    font-weight:700; color:#fff; background:#2b2b2b;
    border:1px solid #2a2a2a; transition:.15s; box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);
  }
  .btn:hover{background:#343434}
  .btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary-2)); border-color:transparent}
  .timer{min-width:86px; text-align:center; padding:10px 12px; border-radius:12px; background:#202020; border:1px solid #2a2a2a}

  .starter{
    margin-top:14px; border-radius:12px; border:1px dashed #323232; padding:14px;
    background:#1a1a1a; color:#ddd; font-size:14px; line-height:1.35;
  }

  /* Debug & API */
  .api-bar{display:flex; align-items:center; gap:10px; margin:0 0 12px}
  .api-dot{width:10px; height:10px; border-radius:999px; background:var(--err); box-shadow:0 0 0 4px rgba(239,68,68,.1)}
  .api-input{
    flex:1; padding:10px 12px; border-radius:12px; border:1px solid #2a2a2a; background:#141414; color:#ddd
  }
  .kbd{font-size:12px; opacity:.8}
  pre{
    background:#0f0f0f; border:1px solid #222; border-radius:12px; padding:14px; color:#e5e5e5;
    overflow:auto; min-height:54px; font-size:13px; line-height:1.4
  }

  /* Summary cards */
  .two{display:grid; grid-template-columns:1fr; gap:14px}
  .row-mini{display:flex; gap:10px; align-items:center}
  .badge{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #2a2a2a; background:#151515}
  .ok{background:rgba(34,197,94,.08); border-color:rgba(34,197,94,.2); color:#a7f3d0}
  .bad{background:rgba(239,68,68,.08); border-color:rgba(239,68,68,.2); color:#fecaca}
  .out{padding:12px; border-radius:12px; border:1px solid #2a2a2a; background:#151515; color:#ddd; min-height:42px}
  .list{display:grid; gap:10px}
  .li{padding:12px; border-radius:12px; border:1px solid #2a2a2a; background:#141414}
  .tag{display:inline-block; padding:2px 8px; border-radius:8px; font-size:12px; margin-right:6px; background:#232323; border:1px solid #2a2a2a}

  footer{margin:26px 0 40px; color:#bdbdbd; font-size:13px; text-align:center}
  footer a{color:#caa8ff; text-decoration:none}
  footer a:hover{text-decoration:underline}

  .toast{
    position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
    background:#262626; color:#fff; border:1px solid #333; border-radius:12px; padding:12px 16px; box-shadow:var(--shadow);
    display:none; z-index:50;
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">English Coach</div>
      <div class="pill">Instant English Feedback</div>
      <div style="flex:1"></div>
      <div class="kbd">API field sits on the ‚ÄúDebug / Raw response‚Äù card.</div>
    </header>

    <div class="grid">
      <!-- LEFT: controls -->
      <section class="card">
        <div class="inner">
          <div class="title">Record for <strong>60‚Äì90 seconds</strong>.</div>
          <div class="muted">We‚Äôll analyze fluency & correctness, then show key corrections and a next prompt.</div>

          <div style="height:10px"></div>
          <div class="muted" style="margin-bottom:8px">Goal</div>
          <div id="goalChips" class="goal-chips"></div>

          <div style="height:14px"></div>
          <div class="row">
            <button id="btnStart" class="btn primary">Start recording</button>
            <button id="btnStop" class="btn">Stop</button>
            <div class="timer" id="timer">00:00</div>
          </div>

          <div style="height:10px"></div>
          <button id="btnSend" class="btn" style="width:100%">Send & Analyze</button>

          <div class="starter">
            <div class="muted" style="margin-bottom:6px">What to say to start</div>
            <div id="starterText">Describe your last weekend in 45 seconds.</div>
            <div style="height:6px"></div>
            <button id="btnDice" class="btn" style="padding:8px 12px">Randomize prompt üé≤</button>
          </div>

          <div class="muted" style="margin-top:14px; font-size:12px">
            We don‚Äôt store your audio; it‚Äôs sent to the analyzer and immediately discarded.
          </div>
        </div>
      </section>

      <!-- RIGHT: debug + results -->
      <section class="card">
        <div class="inner">
          <div class="api-bar">
            <div class="api-dot" id="apiDot" title="API status"></div>
            <input id="api" class="api-input" placeholder="https://your-endpoint.vercel.app/api/analyze" />
            <button class="btn" id="saveApi">Save</button>
            <button class="btn" id="shareLink">Share</button>
          </div>

          <div class="title">Debug / Raw response</div>
          <pre id="raw">‚Äì</pre>

          <div style="height:10px"></div>
          <div class="title">Summary</div>
          <div class="row-mini" style="margin-bottom:8px">
            <span class="badge">Level: <span id="levelOut">‚Äì</span></span>
            <span class="badge">Fillers: <span id="fillersOut">0</span></span>
          </div>

          <div class="two">
            <div>
              <div class="muted" style="margin-bottom:6px">What to fix now</div>
              <div class="out" id="fixNowOut">‚Äì</div>
            </div>
            <div>
              <div class="muted" style="margin-bottom:6px">Next prompt (30‚Äì45s)</div>
              <div class="out" id="nextPromptOut">‚Äì</div>
            </div>
          </div>

          <div style="height:16px"></div>
          <div class="title">Grammar</div>
          <div class="list" id="grammarList"></div>

          <div style="height:16px"></div>
          <div class="title">Pronunciation</div>
          <div class="list" id="pronList"></div>
        </div>
      </section>
    </div>

    <footer>
      ¬© 2025 <a href="https://simpleia.com" target="_blank" rel="noopener">Simpleia</a> ‚Äî Built by
      <a href="https://aosama.net/" target="_blank" rel="noopener">Abdo Osama</a>
    </footer>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ================== SETTINGS / GOALS / PROMPTS =================== */
const GOALS = [
  {
    key:'work', label:'Work English',
    starters:[
      'Explain one problem your team faced and how you solved it.',
      'Describe a recent project you led and one lesson you learned.',
      'Give a 45-second update on your current task and next step.'
    ]
  },
  {
    key:'daily', label:'Daily Life',
    starters:[
      'Describe your last weekend in 45 seconds.',
      'Tell me about a typical day in your life.',
      'Talk about a hobby you enjoy and why.'
    ]
  },
  {
    key:'interview', label:'Interview Prep',
    starters:[
      'Tell me about yourself in under one minute.',
      'What is your biggest strength at work?',
      'Describe a time you handled a difficult situation.'
    ]
  },
  {
    key:'travel', label:'Travel',
    starters:[
      'Describe a city you want to visit and why.',
      'Talk about your best travel experience.',
      'Explain how you plan a short weekend trip.'
    ]
  }
];

const FRIENDLY_LEVEL = (cefr) => {
  const x = (cefr||'').toUpperCase();
  if (x==='A1'||x==='A2') return 'Beginner';
  if (x==='B1') return 'Intermediate';
  if (x==='B2') return 'Advanced';
  if (x==='C1') return 'Advanced';
  if (x==='C2') return 'Fluent';
  return '‚Äì';
};

/* =========================== UI REFS ============================= */
const btnStart = document.getElementById('btnStart');
const btnStop  = document.getElementById('btnStop');
const btnSend  = document.getElementById('btnSend');
const timerEl  = document.getElementById('timer');

const starterText = document.getElementById('starterText');
const btnDice = document.getElementById('btnDice');
const goalChips = document.getElementById('goalChips');

const raw = document.getElementById('raw');
const levelOut = document.getElementById('levelOut');
const fillersOut = document.getElementById('fillersOut');
const fixNowOut = document.getElementById('fixNowOut');
const nextPromptOut = document.getElementById('nextPromptOut');
const grammarList = document.getElementById('grammarList');
const pronList = document.getElementById('pronList');

const apiDot = document.getElementById('apiDot');
const apiInput = document.getElementById('api');
const saveBtn = document.getElementById('saveApi');
const shareBtn = document.getElementById('shareLink');
const toast = document.getElementById('toast');

/* ====================== API MEMORY / STATUS ====================== */
const LS_KEY='ec_api';
function isValidApi(u){
  try{ const v=new URL(u); return /^https?:/.test(v.protocol) && /\/api\/analyze$/.test(v.pathname); }
  catch{ return false; }
}
function setApi(u){ localStorage.setItem(LS_KEY,u); apiInput.value=u; markApi(true); }
function getApi(){ return (localStorage.getItem(LS_KEY)||'').trim(); }
function markApi(ok){ apiDot.style.background = ok ? 'var(--ok)' : 'var(--err)'; }
(function hydrateApi(){
  const qs = new URLSearchParams(location.search);
  const fromQuery=(qs.get('api')||'').trim();
  const stored=getApi(); const chosen=fromQuery||stored;
  if (chosen && isValidApi(chosen)) setApi(chosen); else markApi(false);
})();
saveBtn.addEventListener('click', ()=>{
  const v=(apiInput.value||'').trim();
  if(!isValidApi(v)) return notify('Please paste a valid API like https://‚Ä¶/api/analyze');
  setApi(v); notify('Saved!');
});
shareBtn.addEventListener('click', async ()=>{
  const api=getApi(); const url=new URL(location.href);
  if(api) url.searchParams.set('api',api); else url.searchParams.delete('api');
  try{ await navigator.clipboard.writeText(url.toString()); notify('Share link copied.'); }
  catch{ notify(url.toString()); }
});
function requireApiOrWarn(){ const a=getApi(); if(!isValidApi(a)){ notify('Please set a valid Analyzer API URL first.'); return null; } return a; }

/* ====================== GOAL CHIPS / STARTER ===================== */
let currentGoal = GOALS[0];
function renderGoalChips(){
  goalChips.innerHTML='';
  GOALS.forEach(g=>{
    const el=document.createElement('div');
    el.className='chip'+(g.key===currentGoal.key?' active':'');
    el.textContent=g.label;
    el.onclick=()=>{ currentGoal=g; renderGoalChips(); setRandomStarter(); };
    goalChips.appendChild(el);
  });
}
function setRandomStarter(){
  const arr=currentGoal.starters;
  starterText.textContent = arr[Math.floor(Math.random()*arr.length)];
}
btnDice.addEventListener('click', setRandomStarter);
renderGoalChips(); setRandomStarter();

/* ============================ RECORDER =========================== */
let media,rec,chunks=[],startTime=0,timerI=null,blob=null;

function fmt(ms){ const s=Math.floor(ms/1000); const m=String(Math.floor(s/60)).padStart(2,'0'); const r=String(s%60).padStart(2,'0'); return `${m}:${r}`; }
function setButtons(busy){
  btnStart.disabled=busy; btnStop.disabled=!busy; btnSend.disabled=busy;
  document.body.style.cursor = busy ? 'progress' : 'default';
}
async function startRec(){
  try{
    media = await navigator.mediaDevices.getUserMedia({audio:true});
    chunks=[]; rec = new MediaRecorder(media, {mimeType:'audio/webm;codecs=opus'});
    rec.ondataavailable=e=>{ if(e.data?.size>0) chunks.push(e.data); };
    rec.onstop=()=>{ blob=new Blob(chunks,{type:'audio/webm'}); if(media){media.getTracks().forEach(t=>t.stop());} };
    rec.start(200);
    startTime=performance.now(); clearInterval(timerI);
    timerI=setInterval(()=>{ timerEl.textContent = fmt(performance.now()-startTime); }, 250);
    setButtons(true);
  }catch(e){
    notify('Microphone not available.'); console.error(e);
  }
}
function stopRec(){
  try{ rec?.stop(); }catch{}
  clearInterval(timerI);
  timerEl.textContent = fmt(performance.now()-startTime);
  setButtons(false);
}

btnStart.addEventListener('click', startRec);
btnStop.addEventListener('click', stopRec);

/* ============================ ANALYZE ============================ */
async function sendAnalyze(){
  const api=requireApiOrWarn(); if(!api) return;
  if(!blob || blob.size===0){ notify('Please record first, then Send & Analyze.'); return; }
  const dur=Math.round((performance.now()-startTime)/1000);
  const fd=new FormData();
  const file=new File([blob],'audio.webm',{type:blob.type||'audio/webm'});
  fd.append('files[]', file);
  fd.append('duration_sec', String(dur));
  fd.append('goal', currentGoal.label);

  markApi(true);
  setButtons(true);
  raw.textContent='Sending‚Ä¶';

  try{
    const res=await fetch(api,{method:'POST',body:fd});
    const text=await res.text();
    raw.textContent=text||'(empty response)';

    if(!res.ok){ notify('Analyzer error'); setButtons(false); return; }

    let json; try{ json=JSON.parse(text); }catch{ notify('Analyzer returned non-JSON'); setButtons(false); return; }
    renderResult(json);
  }catch(err){
    notify('Network error'); console.error(err);
  }finally{
    setButtons(false);
  }
}
btnSend.addEventListener('click', sendAnalyze);

/* =========================== RENDERING =========================== */
function renderResult(j){
  // Fallback if analyzer says nothing useful
  if(j.fallback){
    levelOut.textContent = '‚Äì';
    fillersOut.textContent = '0';
    fixNowOut.textContent = 'Speak for at least 30‚Äì60 seconds in full sentences.';
    nextPromptOut.textContent = starterText.textContent;
    grammarList.innerHTML=''; pronList.innerHTML='';
    return;
  }

  levelOut.textContent   = FRIENDLY_LEVEL(j.cefr_estimate);
  fillersOut.textContent = String(j?.fluency?.fillers ?? 0);
  fixNowOut.textContent  = (j?.one_thing_to_fix || j?.rationale || '‚Äì');
  nextPromptOut.textContent = (j?.next_prompt || starterText.textContent);

  // Grammar
  grammarList.innerHTML='';
  (j?.grammar_issues||[]).forEach(g=>{
    const row=document.createElement('div'); row.className='li';
    row.innerHTML = `
      <div class="tag">error</div> ${escapeHtml(g.error||'')}
      <div style="height:6px"></div>
      <div class="tag">fix</div> ${escapeHtml(g.fix||'')}
      ${g.why ? `<div style="height:6px"></div><div class="tag">why</div> ${escapeHtml(g.why)}`:''}
    `;
    grammarList.appendChild(row);
  });

  // Pronunciation
  pronList.innerHTML='';
  (j?.pronunciation||[]).forEach(p=>{
    const row=document.createElement('div'); row.className='li';
    row.innerHTML = `
      <div class="tag">word</div> ${escapeHtml(p.sound_or_word||'')}
      ${p.issue ? `<div style="height:6px"></div><div class="tag">issue</div> ${escapeHtml(p.issue)}`:''}
      ${p.minimal_pair ? `<div style="height:6px"></div><div class="tag">try</div> ${escapeHtml(p.minimal_pair)}`:''}
    `;
    pronList.appendChild(row);
  });
}
function escapeHtml(s){ return (s??'').toString().replace(/[<>&"]/g,m=>({ '<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;' }[m])); }

/* ============================== UX =============================== */
let toastT=null;
function notify(msg){
  toast.textContent=msg; toast.style.display='block';
  clearTimeout(toastT); toastT=setTimeout(()=>toast.style.display='none', 2200);
}
</script>
</body>
</html>
