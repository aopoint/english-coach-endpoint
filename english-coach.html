// ===== read config =====
const { SUPABASE_URL, SUPABASE_ANON_KEY, API_URL, VERSION } = window.APP_CONFIG || {};
document.getElementById("ver").textContent = VERSION || "";

// ===== supabase =====
const supabase = (SUPABASE_URL && SUPABASE_ANON_KEY)
  ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
  : null;

let currentUser = null;
let localSessionCount = Number(localStorage.getItem("ec_sessions") || "0");
let allowNextWithoutLogin = false; // flips after feedback submit for guests

// ===== UI refs =====
const btnStart = document.getElementById('btnStart');
const btnStop  = document.getElementById('btnStop');
const btnSend  = document.getElementById('btnSend');
const btnRnd   = document.getElementById('btnRnd');
const timerEl  = document.getElementById('timer');
const meterEl  = document.getElementById('meter');
const goalsEl  = document.getElementById('goals');
const promptEl = document.getElementById('prompt');
const liveChip = document.getElementById('liveChip').firstElementChild;
const levelLabelEl = document.getElementById('levelLabel');
const fillersEl = document.getElementById('fillers');
const streakEl = document.getElementById('streak');
const sessionsEl = document.getElementById('sessions');
const localSessionsEl = document.getElementById('localSessions');

// results
const pronBox = document.getElementById('pronBox');
const gramBox = document.getElementById('gramBox');
const fixBox  = document.getElementById('fixBox');
const nextBox = document.getElementById('nextBox');

// modals
const fbBack = document.getElementById('fbBack');
const fbName = document.getElementById('fbName');
const fbEmail= document.getElementById('fbEmail');
const fbText = document.getElementById('fbText');
let fbRating = 0;
document.getElementById('stars').addEventListener('click', e=>{
  if(e.target.dataset.v){ fbRating = Number(e.target.dataset.v); [...e.currentTarget.children].forEach((b,i)=> b.style.color = (i<fbRating)?'#ffd166':'#d0d6e5'); }
});
document.getElementById('fbCancel').onclick = ()=> fbBack.style.display='none';
document.getElementById('fbSend').onclick   = submitFeedback;

const authBack = document.getElementById('authBack');
document.getElementById('authClose').onclick = ()=> authBack.style.display='none';
document.getElementById('signinLink').onclick= (e)=>{ e.preventDefault(); authBack.style.display='flex'; };
document.getElementById('btnG').onclick = ()=> startOAuth('google');
document.getElementById('btnF').onclick = ()=> startOAuth('facebook');
document.getElementById('btnMagic').onclick = async ()=>{
  const email = document.getElementById('authEmail').value.trim();
  if(!email) return alert('Enter email');
  await supabase.auth.signInWithOtp({ email, options:{emailRedirectTo: location.origin} });
  alert('Magic link sent. Check your inbox.');
};

function showLive(on){ liveChip.style.background = on ? '#2dcc70' : '#555' }

// ===== auth state =====
if (supabase) supabase.auth.onAuthStateChange((_e,sess)=> {
  currentUser = sess?.user || null;
  updateHeader();
  if(currentUser) refreshUserStats();
});

function updateHeader(){
  sessionsEl.textContent = localSessionCount.toString();
  localSessionsEl.textContent = localSessionCount.toString();
}

async function refreshUserStats(){
  try{
    const { data } = await supabase.from('sessions').select('id, created_at').order('created_at',{ascending:false}).limit(365);
    const sessions = data?.length || 0;
    sessionsEl.textContent = sessions;
    localSessionsEl.textContent = sessions.toString();

    // streak
    const days = new Set((data||[]).map(r => r.created_at.slice(0,10)));
    let streak = 0, d = new Date();
    for(;;){
      const key = d.toISOString().slice(0,10);
      if(days.has(key)){ streak++; d.setDate(d.getDate()-1); } else break;
    }
    streakEl.textContent = streak.toString();

    // leaderboard (very simple: show you only; advanced RPC optional)
    document.getElementById('lbNote').textContent = 'Signed-in. Tracking your public totals.';
  }catch(e){/* ignore */}
}

// ===== recording =====
let mediaStream=null, mediaRec=null, chunks=[], recStart=0, timerInt=null;
const MAX_SEC = 95;

function fmt(n){const m=Math.floor(n/60),s=n%60;return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`}

function setMeter(sec){
  const p = Math.min(100, Math.round((sec/90)*100));
  meterEl.style.width = p+'%';
  meterEl.style.background = sec<30 ? 'var(--danger)' : sec<60 ? 'var(--warn)' : 'var(--ok)';
}

async function startRec(){
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
    const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus'
               : MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : '';

    mediaRec = new MediaRecorder(mediaStream, mime ? {mimeType:mime} : undefined);
    chunks=[]; recStart=Date.now(); btnStart.disabled=true; btnStop.disabled=false; btnSend.disabled=true;
    btnRnd.disabled = true;
    showLive(true);

    mediaRec.ondataavailable = e=> { if(e.data && e.data.size>0) chunks.push(e.data); };
    mediaRec.onstop = ()=> { showLive(false); btnSend.disabled=false; btnStart.disabled=false; btnStop.disabled=true; btnRnd.disabled = false; };

    mediaRec.start(100);
    timerInt = setInterval(()=>{
      const sec = Math.floor((Date.now()-recStart)/1000);
      timerEl.textContent = fmt(sec);
      setMeter(sec);
      if(sec>=MAX_SEC) stopRec();
    },250);
  }catch(err){
    alert('Mic permission denied or unavailable.');
  }
}
function stopRec(){
  try{ mediaRec && mediaRec.stop(); }catch(_){}
  try{ mediaStream && mediaStream.getTracks().forEach(t=>t.stop()); }catch(_){}
  clearInterval(timerInt); timerInt=null;
}

btnStart.onclick = startRec;
btnStop.onclick  = stopRec;

const prompts = [
  "Describe a recent challenge you faced and how you solved it.",
  "Tell me about your last weekend in 45 seconds.",
  "Explain one problem your team faced and how you solved it.",
  "Describe a project you’re proud of and why.",
  "Talk about a mistake and what you learned from it."
];
btnRnd.onclick = ()=>{
  if(btnStart.disabled) return; // disabled while recording
  promptEl.value = prompts[Math.floor(Math.random()*prompts.length)];
};

// ===== goal selection =====
let goal = "Work English";
goalsEl.addEventListener('click', e=>{
  const b = e.target.closest('button.gbtn'); if(!b) return;
  goalsEl.querySelectorAll('.gbtn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); goal = b.dataset.goal;
});

// ===== analyze =====
btnSend.onclick = async ()=>{
  if(chunks.length===0) return;
  const dur = Math.max(1, Math.floor((Date.now()-recStart)/1000));
  btnSend.disabled=true;

  // gate: if not signed-in and user already analyzed once and not left feedback
  const analyzedCount = Number(localStorage.getItem('ec_an_cnt')||'0');
  if(!currentUser && analyzedCount>=1 && !allowNextWithoutLogin){
    // recommend sign-in; otherwise feedback unlock
    authBack.style.display='flex';
    btnSend.disabled=false;
    return;
  }

  try{
    const blob = new Blob(chunks, {type: chunks[0]?.type || 'audio/webm'});
    const fd = new FormData();
    fd.append('files[]', blob, 'audio.webm');
    fd.append('duration_sec', String(dur));
    fd.append('goal', goal);
    fd.append('prompt_text', promptEl.value.trim());

    const res = await fetch(API_URL, { method:'POST', body:fd });
    const json = await res.json();

    renderResult(json, dur);

    // reset timer for “new session” feeling
    timerEl.textContent = '00:00'; setMeter(0);

    // store session
    if(currentUser && supabase){
      await supabase.from('sessions').insert({
        user_id: currentUser.id,
        duration_sec: dur,
        level_label: json.friendly_level || json.cefr_estimate || '—',
        goal
      });
      refreshUserStats();
    }else{
      localSessionCount++; localStorage.setItem('ec_sessions', String(localSessionCount));
      updateHeader();
      // after FIRST analysis, ask optional feedback to continue
      let cnt = Number(localStorage.getItem('ec_an_cnt')||'0'); cnt++; localStorage.setItem('ec_an_cnt', String(cnt));
      if(cnt===1 && !allowNextWithoutLogin){ fbBack.style.display='flex'; }
    }
  }catch(err){
    alert('Analysis failed. Please try again.');
  }finally{
    btnSend.disabled=false;
  }
};

function renderResult(json, dur){
  // fallback
  if(json.fallback){
    levelLabelEl.textContent = 'Beginner';
    fillersEl.textContent = '0';
    pronBox.textContent = '—';
    gramBox.textContent = '—';
    fixBox.textContent  = json.one_thing_to_fix || 'Speak for 30–60 seconds.';
    nextBox.textContent = json.next_prompt || 'Describe your last weekend in 45 seconds.';
    return;
  }

  levelLabelEl.textContent = json.friendly_level || json.cefr_estimate || '—';
  fillersEl.textContent = String(json.fluency?.fillers ?? 0);

  // grammar
  if(Array.isArray(json.grammar_issues) && json.grammar_issues.length){
    gramBox.innerHTML = json.grammar_issues.map(g =>
      `<div class="item">→ ${escapeHtml(g.error || '')}<br><span class="muted">Try:</span> ${escapeHtml(g.fix || '')}<br><span class="muted">Why:</span> ${escapeHtml(g.why || '')}</div>`
    ).join('');
  }else gramBox.textContent='—';

  // pronunciation
  if(Array.isArray(json.pronunciation) && json.pronunciation.length){
    pronBox.innerHTML = json.pronunciation.map(p =>
      `<div class="item"><strong>${escapeHtml(p.sound_or_word||'')}</strong> — ${escapeHtml(p.issue||'')}<br><span class="muted">Try:</span> ${escapeHtml(p.minimal_pair||'')}</div>`
    ).join('');
  }else pronBox.textContent='—';

  fixBox.textContent  = json.one_thing_to_fix || '—';
  nextBox.textContent = json.next_prompt     || '—';
}

function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

// ===== feedback =====
async function submitFeedback(){
  const name = fbName.value.trim();
  const email= fbEmail.value.trim();
  const text = fbText.value.trim();
  const rating = fbRating || 5;

  try{
    if(supabase){
      await supabase.from('feedback').insert({
        user_id: currentUser?.id ?? null, name, email, text, rating
      });
    }
    allowNextWithoutLogin = true;
    fbBack.style.display='none';
    alert('Thanks for your feedback! You can continue practicing.');
  }catch(err){
    // even if failed, allow continuing (don’t block)
    allowNextWithoutLogin = true;
    fbBack.style.display='none';
  }
}

// ===== OAuth helpers =====
async function startOAuth(provider){
  if(!supabase) return alert('Supabase client missing.');
  try{
    await supabase.auth.signInWithOAuth({
      provider,
      options:{ redirectTo: location.origin }
    });
  }catch(e){ alert('Sign-in failed'); }
}

// ===== initialize =====
updateHeader();
showLive(false);
