<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>English Coach â€” Instant English Feedback</title>
<meta name="description" content="Record 60â€“90 seconds and get instant English feedback: level, key corrections, and your next prompt." />

<style>
  :root{
    --bg:#191919;
    --panel:#1f1f1f;
    --panel-2:#242424;
    --text:#f5f5f5;
    --muted:#a7a7a7;
    --ring:rgba(78,10,122,.35);
    --ok:#22c55e;
    --err:#ef4444;
    --chip:#2a2a2a;
    --primary:#4E0A7A;
    --primary-2:#6c1aa3;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background: radial-gradient(800px 400px at 90% -10%, rgba(78,10,122,.20), transparent 60%), var(--bg);
    color:var(--text);
    font: 16px/1.5 "Avenir Next",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  }
  a{color:#a6a8ff;text-decoration:none}
  a:hover{text-decoration:underline}

  header{
    display:flex;align-items:center;justify-content:space-between;
    padding:18px 20px 10px; gap:16px;
  }
  .brand{display:flex;align-items:center;gap:12px}
  .badge{background:linear-gradient(90deg, var(--primary), var(--primary-2)); padding:8px 12px; border-radius:999px; font-weight:700; box-shadow:0 6px 20px rgba(78,10,122,.35)}
  .app-title{font-size:22px;font-weight:800;letter-spacing:.2px}

  .wrap{
    max-width:1200px;margin:0 auto;padding:10px 16px 80px;
    display:grid;grid-template-columns: 360px 1fr;gap:20px;
  }
  @media (max-width:980px){ .wrap{grid-template-columns:1fr} }

  .card{
    background:linear-gradient(180deg, var(--panel), var(--panel-2));
    border:1px solid rgba(255,255,255,.06);
    border-radius:14px; box-shadow:var(--shadow);
  }
  .card .head{padding:16px 16px 8px;font-weight:800;font-size:14px;letter-spacing:.3px;color:#d8d8d8}

  .left .inner{padding:16px}
  .hint{color:var(--muted); font-size:14px;margin-top:6px}

  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .btn{
     appearance:none;border:0;border-radius:12px;padding:12px 16px;
     background:#2b2b2b;color:var(--text);font-weight:700;cursor:pointer;
     box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
     transition:.15s transform ease, .2s background ease, .2s box-shadow ease;
  }
  .btn:hover{transform:translateY(-1px)}
  .btn:disabled{opacity:.65;cursor:not-allowed;transform:none}
  .btn.primary{background:linear-gradient(180deg,var(--primary),var(--primary-2));box-shadow:0 8px 24px rgba(78,10,122,.45)}
  .btn.ghost{background:#2a2a2a}
  .btn.icon{padding:10px 12px;border-radius:10px}

  /* goal chips */
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{
    padding:8px 12px;border-radius:999px;background:var(--chip);
    border:1px solid rgba(255,255,255,.07);cursor:pointer;font-weight:700;color:#ddd;
  }
  .chip.active{background:linear-gradient(180deg,var(--primary),var(--primary-2)); color:#fff; box-shadow:0 6px 20px rgba(78,10,122,.35)}

  /* API bar */
  .api-bar{display:flex;gap:8px;align-items:center;justify-content:flex-end;padding:0 16px}
  .api-input{
    width:min(520px,90vw);background:#141414;border:1px solid rgba(255,255,255,.08);
    color:#ddd;border-radius:10px;padding:10px 12px;outline:none;
  }
  .api-dot{width:10px;height:10px;border-radius:50%;background:var(--ok);box-shadow:0 0 0 3px rgba(34,197,94,.2)}

  /* fields */
  .field{display:flex;flex-direction:column;gap:8px;margin-top:12px}
  .lbl{font-weight:800;font-size:12px;color:#c9c9c9;letter-spacing:.3px}
  .box{
    background:#171717;border:1px solid rgba(255,255,255,.08);color:#dcdcdc;
    padding:12px;border-radius:10px;min-height:44px;display:flex;align-items:center
  }
  .box.multiline{min-height:56px;line-height:1.4}
  .box code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:13px;color:#c7cfff}

  .metric{display:flex;gap:6px;align-items:center}
  .pill{background:#2c2c2c;border:1px solid rgba(255,255,255,.08);padding:6px 10px;border-radius:999px;font-weight:800;color:#dcdcdc}

  footer{max-width:1200px;margin:26px auto; padding:0 16px;color:#bdbdbd;font-size:13px;opacity:.9}
  .kbd{background:#2a2a2a;border:1px solid rgba(255,255,255,.12);border-radius:6px;padding:2px 6px;font-family:ui-monospace}

  .ghost-text{opacity:.55}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="badge">Instant English Feedback</div>
    <div class="app-title">English Coach</div>
  </div>

  <div class="api-bar">
    <div class="api-dot" id="apiDot" title="API status"></div>
    <input id="api" class="api-input" type="url"
      placeholder="https://your-domain.vercel.app/api/analyze" />
    <button class="btn icon" id="saveApi" title="Save API">Save</button>
      <button class="btn icon" id="shareLink" title="Copy public link">Share</button>
  </div>
</header>

<div class="wrap">

  <!-- LEFT: recorder / controls -->
  <section class="card left">
    <div class="inner">
      <div class="lbl">Record for <strong>60â€“90 seconds</strong>.
        Weâ€™ll analyze fluency and correctness, then show key corrections and a next prompt.</div>

      <!-- goals -->
      <div class="field" style="margin-top:12px">
        <div class="lbl">Goal</div>
        <div class="chips" id="goalChips">
          <button class="chip active" data-goal="Work English">Work</button>
          <button class="chip" data-goal="Casual English">Casual</button>
          <button class="chip" data-goal="Interview Prep">Interview</button>
          <button class="chip" data-goal="Travel English">Travel</button>
        </div>
      </div>

      <!-- starter prompt -->
      <div class="field">
        <div class="lbl" style="display:flex;align-items:center;gap:8px">
          Try saying this to start
          <button class="btn icon ghost" id="shuffle">ðŸŽ²</button>
        </div>
        <div class="box multiline" id="starterBox">â€”</div>
        <div class="hint">You can talk about this for ~60â€“90 seconds, then press <b>Send & Analyze</b>.</div>
      </div>

      <!-- controls -->
      <div class="field" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:14px">
        <button class="btn primary" id="startBtn">Start recording</button>
        <button class="btn ghost" id="stopBtn" disabled>Stop</button>
        <button class="btn" id="sendBtn" disabled>Send & Analyze</button>
        <div class="box" style="min-width:120px;flex:0 0 auto" id="timer">00:00</div>
      </div>

      <div class="hint">We donâ€™t store your audio; itâ€™s sent to the analyzer and immediately discarded.</div>
    </div>
  </section>

  <!-- RIGHT: debug + results -->
  <section>
    <div class="card">
      <div class="head">Debug / Raw response</div>
      <div class="inner" style="padding:12px 16px 16px">
        <div class="box multiline" id="debug">â€”</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="head">Summary</div>
      <div class="inner" style="padding:12px 16px 16px">
        <div class="row" style="gap:10px; margin-bottom:10px">
          <div class="metric">
            <span class="pill" id="levelFriendly">â€“</span>
            <span class="ghost-text" id="cefrSmall" style="margin-left:6px"></span>
          </div>
          <div class="metric">
            <span class="pill"><span class="ghost-text">Fillers:</span> <span id="fillersNum">0</span></span>
          </div>
        </div>

        <div class="field">
          <div class="lbl">What to fix now</div>
          <div class="box multiline" id="fixNow">â€“</div>
        </div>

        <div class="field">
          <div class="lbl">Next prompt (30â€“45s)</div>
          <div class="box multiline" id="nextPrompt">â€“</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="head">Grammar</div>
      <div class="inner">
        <div class="box multiline" id="grammarBox">â€“</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="head">Pronunciation</div>
      <div class="inner">
        <div class="box multiline" id="pronBox">â€“</div>
      </div>
    </div>
  </section>
</div>

<footer>
  Â© 2025 <a href="https://simpleia.com" target="_blank">Simpleia</a> â€” Built by <a href="https://aosama.net/" target="_blank">Abdo Osama</a>.
</footer>

<script>

  
/* ==============================
   Config & helpers
============================== */
const API_INPUT = document.getElementById('api');
const apiDot = document.getElementById('apiDot');
const saveApiBtn = document.getElementById('saveApi');
const debugBox = document.getElementById('debug');

const levelFriendly = document.getElementById('levelFriendly');
const cefrSmall = document.getElementById('cefrSmall');
const fillersNum = document.getElementById('fillersNum');
const fixNow = document.getElementById('fixNow');
const nextPrompt = document.getElementById('nextPrompt');
const grammarBox = document.getElementById('grammarBox');
const pronBox = document.getElementById('pronBox');

const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const sendBtn  = document.getElementById('sendBtn');
const timerEl  = document.getElementById('timer');

const goalChips = document.getElementById('goalChips');
const shuffleBtn = document.getElementById('shuffle');
const starterBox = document.getElementById('starterBox');

const FRIENDLY = {
  A1:{friendly:'Beginner'},
  A2:{friendly:'Basic'},
  B1:{friendly:'Average'},
  B2:{friendly:'Advanced'},
  C1:{friendly:'Fluent'},
  C2:{friendly:'Fluent+'},
};

const STARTER = {
  'Work English': [
    "Give a quick update on a project youâ€™re working on. What changed this week?",
    "Explain one problem your team faced and how you solved it.",
    "Describe a recent meeting: goals, outcomes, and next steps."
  ],
  'Casual English': [
    "Talk about your last weekend from morning to night.",
    "Describe your favorite hobby and how you got into it.",
    "Tell a short story about a happy memory."
  ],
  'Interview Prep': [
    "Introduce yourself and explain your biggest strength with an example.",
    "Describe a time you overcame a challenge at work.",
    "Explain a project youâ€™re proud of: your role and impact."
  ],
  'Travel English': [
    "Describe your favorite city to visit. What should a new visitor do?",
    "Tell the story of a trip that went wrong and what you learned.",
    "Explain how you would plan a weekend in a new country."
  ]
};

function pickStarter(goal){
  const arr = STARTER[goal] || STARTER['Work English'];
  return arr[Math.floor(Math.random()*arr.length)];
}

function setStarter(){
  const active = goalChips.querySelector('.chip.active');
  const goal = active?.dataset.goal || 'Work English';
  const text = pickStarter(goal);
  starterBox.textContent = text;
  nextPrompt.textContent = text; // prefill so users always have something to say
}

/* Persist API */
const LS_KEY = 'ec_api_url';
API_INPUT.value = localStorage.getItem(LS_KEY) || localStorage.getItem('ec_make_url') || ''; // read old key too
saveApiBtn.onclick = () => {
  localStorage.setItem(LS_KEY, API_INPUT.value.trim());
  apiDot.style.background = '#22c55e';
};

  // --- Prefill from ?api= (and save it)
(function hydrateFromQuery() {
  const qs = new URLSearchParams(location.search);
  const apiParam = qs.get('api');
  if (apiParam) {
    API_INPUT.value = apiParam.trim();
    localStorage.setItem(LS_KEY, API_INPUT.value);
    apiDot.style.background = '#22c55e';
  }
})();

// Optional: also honor ?goal=Work%20English etc.
(function hydrateGoal() {
  const qs = new URLSearchParams(location.search);
  const g = qs.get('goal');
  if (!g) return;
  const chip = [...goalChips.querySelectorAll('.chip')]
    .find(c => (c.dataset.goal || '').toLowerCase() === g.toLowerCase());
  if (chip) {
    goalChips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    setStarter();
  }
})();

// --- Share button: copies link with ?api=<current value>
function buildShareURL() {
  const api = (API_INPUT.value || '').trim();
  const u = new URL(location.href);
  if (api) u.searchParams.set('api', api);
  else u.searchParams.delete('api');
  // keep ?goal= if present (useful when sharing a goal)
  return u.toString();
}

const shareBtn = document.getElementById('shareLink');
shareBtn?.addEventListener('click', async () => {
  try {
    const url = buildShareURL();
    await navigator.clipboard.writeText(url);
    debugBox.textContent = 'Copied share link:\n' + url;
  } catch (e) {
    debugBox.textContent = 'Could not copy link: ' + e.message + '\n' + buildShareURL();
  }
});

/* Goal chips */
goalChips.addEventListener('click', (e)=>{
  const chip = e.target.closest('.chip');
  if(!chip) return;
  goalChips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active');
  setStarter();
});

shuffleBtn.addEventListener('click', setStarter);

/* ==============================
   Recorder
============================== */
let mediaRecorder, chunks=[], startedAt=0, timerInt=null;

function fmt(sec){
  sec = Math.max(0,Math.floor(sec));
  const m = String(Math.floor(sec/60)).padStart(2,'0');
  const s = String(sec%60).padStart(2,'0');
  return `${m}:${s}`;
}

function tick(){
  const sec = (Date.now()-startedAt)/1000;
  timerEl.textContent = fmt(sec);
}

startBtn.onclick = async () => {
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    chunks = [];
    mediaRecorder = new MediaRecorder(stream,{mimeType:'audio/webm'});
    mediaRecorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
    mediaRecorder.start(250);

    startedAt = Date.now();
    timerInt = setInterval(tick, 250);

    startBtn.disabled = true;
    stopBtn.disabled  = false;
    sendBtn.disabled  = true;
  }catch(err){
    alert("Mic access failed: " + err.message);
  }
};

stopBtn.onclick = () => {
  if(!mediaRecorder) return;
  mediaRecorder.stop();
  mediaRecorder.stream.getTracks().forEach(t=>t.stop());
  clearInterval(timerInt);
  sendBtn.disabled = false;
  stopBtn.disabled = true;
  startBtn.disabled = false;
};

async function sendAnalyze(){
  const api = (API_INPUT.value||'').trim();
  if(!/^https?:\/\//.test(api)) {
    alert('Please set a valid Analyzer API URL first.'); return;
  }
  if(!chunks.length){ alert('Please record something first.'); return; }

  const blob = new Blob(chunks,{type:'audio/webm'});
  const file = new File([blob], 'audio.webm', {type: blob.type});
  const dur = Math.round((Date.now()-startedAt)/1000);

  const active = goalChips.querySelector('.chip.active');
  const goal = active?.dataset.goal || 'Work English';

  const fd = new FormData();
  fd.append('files[]', file);
  fd.append('duration_sec', String(dur));
  fd.append('goal', goal);

  setBusy(true, 'Sendingâ€¦');

  try{
    const res = await fetch(api, {method:'POST', body: fd});
    const raw = await res.text();
    debugBox.textContent = raw || '(empty)';
    let json=null;
    try { json = JSON.parse(raw); } catch(e){ json = null; }
    if(json) render(json);
    else statusBubble(false);
  }catch(err){
    debugBox.textContent = 'Request failed: ' + err.message;
    statusBubble(false);
  }finally{
    setBusy(false);
  }
}
sendBtn.onclick = sendAnalyze;

function setBusy(b, txt=''){
  document.body.style.cursor = b ? 'progress' : 'default';
  [startBtn, stopBtn, sendBtn, shuffleBtn].forEach(bn => bn.disabled = !!b);
  if(b) debugBox.textContent = txt;
}
function statusBubble(ok){
  apiDot.style.background = ok ? '#22c55e' : '#ef4444';
}

/* ==============================
   Render results
============================== */
function render(d){
  statusBubble(true);

  // Friendly level
  let cefr = (d.cefr_estimate||'').toUpperCase();
  let friendly = FRIENDLY[cefr]?.friendly || (cefr ? cefr : 'â€”');
  levelFriendly.textContent = friendly;
  cefrSmall.textContent = cefr ? `(${cefr})` : '';

  // Fillers
  const fillers = (d.fluency && typeof d.fluency.fillers==='number') ? d.fluency.fillers : 0;
  fillersNum.textContent = String(fillers);

  // What to fix now & next prompt
  fixNow.textContent = d.one_thing_to_fix || 'â€”';
  nextPrompt.textContent = d.next_prompt || nextPrompt.textContent || starterBox.textContent || 'â€”';

  // Grammar
  if(Array.isArray(d.grammar_issues) && d.grammar_issues.length){
    grammarBox.innerHTML = d.grammar_issues.map(g => {
      const err = (g.error||'').trim();
      const fix = (g.fix||'').trim();
      const why = (g.why||'').trim();
      return `<div style="margin-bottom:10px">
        <div><strong>âœ– ${escapeHTML(err||'-')}</strong></div>
        <div style="opacity:.7">â†’ ${escapeHTML(fix||'-')}</div>
        <div class="hint" style="margin-top:4px">${escapeHTML(why||'')}</div>
      </div>`;
    }).join('');
  }else{
    grammarBox.textContent = 'â€”';
  }

  // Pronunciation
  if(Array.isArray(d.pronunciation) && d.pronunciation.length){
    pronBox.innerHTML = d.pronunciation.map(p => {
      const w = (p.sound_or_word||'').trim();
      const issue = (p.issue||'').trim();
      const pair = (p.minimal_pair||'').trim();
      return `<div style="margin-bottom:10px">
        <div><strong>${escapeHTML(w||'-')}</strong> â€” ${escapeHTML(issue||'-')}</div>
        ${pair ? `<div class="hint">Try: ${escapeHTML(pair)}</div>` : ``}
      </div>`;
    }).join('');
  }else{
    pronBox.textContent = 'â€”';
  }
}

function escapeHTML(s){
  return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* bootstrap */
setStarter();
const saved = localStorage.getItem(LS_KEY);
if(saved){ API_INPUT.value = saved; apiDot.style.background = '#22c55e'; }
</script>
</body>
</html>
