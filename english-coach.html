<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>English Coach ‚Äî Instant English Feedback</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='96' height='96'%3E%3Crect rx='20' ry='20' width='96' height='96' fill='%237b3ff6'/%3E%3C/svg%3E" />
<style>
  :root{
    --bg:#0f0f12;--panel:#17181c;--panel-2:#1c1e23;--muted:#a3a7b0;--text:#e9e9ef;
    --accent:#7b3ff6;--accent-2:#5b2cd3;--ok:#28c281;--warn:#ffc858;--danger:#ff5a6d;
    --card:#1a1b21;--chip:#22232a;--shadow:0 10px 30px rgba(0,0,0,.35);
    --radius:14px;--radius-sm:10px;--radius-lg:18px;
  }
  *{box-sizing:border-box}
  html,body{background:var(--bg);color:var(--text);font:16px/1.5 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0}
  .wrap{max-width:1220px;margin:32px auto;padding:0 20px}
  header{display:flex;align-items:center;gap:14px;margin-bottom:22px}
  .logo{width:26px;height:26px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#9b6bff);box-shadow:0 0 18px rgba(123,63,246,.45)}
  h1{font-size:26px;margin:0 6px 0 0}
  .version{margin-left:auto;color:var(--muted);font-size:12px;opacity:.8}
  .grid{display:grid;grid-template-columns:340px 1fr;gap:18px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid #23252c;border-radius:var(--radius);box-shadow:var(--shadow)}
  .card h3{margin:0 0 10px;font-size:14px;color:#cfd2da;letter-spacing:.4px}
  .section{padding:16px}
  .chip-row{display:flex;flex-wrap:wrap;gap:10px}
  .chip{background:var(--chip);color:#dfe2ea;border:1px solid #2a2c35;padding:10px 14px;border-radius:999px;cursor:pointer;user-select:none}
  .chip.active{background:linear-gradient(135deg,var(--accent),#9b6bff);border-color:transparent;color:#fff;box-shadow:0 8px 20px rgba(123,63,246,.35)}
  .row{display:flex;gap:10px;align-items:center}
  .btn{border:0;border-radius:14px;padding:14px 18px;font-weight:700;letter-spacing:.2px;cursor:pointer}
  .btn-primary{background:linear-gradient(135deg,var(--accent),#9b6bff);color:#fff}
  .btn-ghost{background:#24252c;color:#cdd1da}
  .btn-secondary{background:#23242b;color:#dfe2ea;border:1px solid #2b2d36}
  .btn-tertiary{background:#1f2026;color:#c2c6cf;border:1px solid #2a2c33}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .pill{padding:6px 10px;border-radius:999px;background:#202129;border:1px solid #2c2e37;font-size:12px;color:#c7cbd5}
  .meter{height:12px;background:#24252b;border:1px solid #2c2e36;border-radius:999px;overflow:hidden}
  .meter>i{display:block;height:100%;background:linear-gradient(90deg,#ff6b6b,#ffc858,#34d399);width:0%}
  .timer{font-size:38px;font-weight:900;letter-spacing:.5px;background:#1a1b21;border:1px solid #2a2c34;border-radius:20px;padding:16px 18px;min-width:190px;text-align:center}
  .title{font-weight:800;font-size:28px;line-height:1.2;margin:0 0 10px}
  .subtitle{color:#c8cbd4;margin-top:-4px}
  .block{background:var(--panel-2);border:1px solid #262830;border-radius:14px;padding:14px}
  .list{display:grid;gap:10px}
  .item{background:#1a1b21;border:1px solid #272a33;border-radius:12px;padding:12px}
  .small{font-size:12px;color:#b7bbc6}
  textarea, input[type="text"], input[type="email"]{background:#1a1b21;border:1px solid #2c2f37;color:#e7e9ef;border-radius:12px;padding:12px;width:100%}
  .footer{margin:26px 0 60px;color:#aeb3bf;text-align:center}
  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
  .modal.open{display:flex}
  .modal .sheet{width:min(560px,92vw);background:var(--panel);border:1px solid #262931;border-radius:16px;box-shadow:var(--shadow)}
  .sheet header{padding:14px 16px;border-bottom:1px solid #262931}
  .sheet .body{padding:16px}
  .sheet footer{padding:12px 16px;border-top:1px solid #262931;display:flex;justify-content:flex-end;gap:10px}
  .stars{display:flex;gap:6px;font-size:20px;cursor:pointer}
  .star{filter:grayscale(1);opacity:.6}
  .star.active{filter:none;opacity:1}
  /* auth bar */
  .auth-card .btn{padding:10px 14px}
  .link{color:#cdbbff;text-decoration:underline;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo"></div>
    <h1>English Coach</h1>
    <div class="version mono">v1.2.12</div>
  </header>

  <!-- Auth bar -->
  <div id="auth-bar" class="card section auth-card" style="margin-bottom:14px;">
    <div id="auth-out">
      <div class="muted" style="margin-bottom:8px">Sign in to save your streak & appear on the leaderboard</div>
      <div class="row" style="flex-wrap:wrap;gap:8px">
        <button id="btn-google"   class="btn btn-secondary">Continue with Google</button>
        <button id="btn-facebook" class="btn btn-secondary">Continue with Facebook</button>
      </div>
      <div class="row" style="margin-top:8px;gap:8px">
        <input id="email-input" type="email" placeholder="you@email.com" style="max-width:260px">
        <button id="btn-email" class="btn btn-secondary">Email sign-in link</button>
      </div>
      <div id="email-hint" class="small" style="display:none;margin-top:6px">Check your inbox for the magic link.</div>
    </div>
    <div id="auth-in" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div id="user-badge" class="muted"></div>
        <button id="btn-signout" class="btn btn-tertiary">Sign out</button>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: controls -->
    <div class="card section">
      <div class="title">Record for 60‚Äì90 seconds.</div>
      <div class="subtitle">We‚Äôll analyze fluency & correctness, then show key corrections and a next prompt.</div>

      <div style="height:10px"></div>
      <h3>Goal</h3>
      <div class="chip-row" id="goal-row">
        <div class="chip active" data-goal="Work English">Work English</div>
        <div class="chip" data-goal="Daily Life">Daily Life</div>
        <div class="chip" data-goal="Interview Prep">Interview Prep</div>
        <div class="chip" data-goal="Travel">Travel</div>
        <div class="chip" data-goal="Presentation">Presentation</div>
      </div>

      <div style="height:16px"></div>
      <h3>Recording</h3>
      <div class="row" style="flex-wrap:wrap">
        <button id="btn-start" class="btn btn-primary">‚ñ∂Ô∏è&nbsp;&nbsp;Start recording</button>
        <button id="btn-stop"  class="btn btn-tertiary" disabled>‚èπÔ∏è&nbsp;&nbsp;Stop</button>
      </div>

      <div class="row" style="align-items:center;margin-top:12px">
        <div id="timer" class="timer mono">00:00</div>
        <div class="meter" style="flex:1">
          <i id="progress" style="width:0%"></i>
        </div>
      </div>

      <div style="height:12px"></div>
      <button id="btn-send" class="btn btn-primary" style="width:100%" disabled>Send & Analyze</button>

      <div style="height:16px"></div>
      <h3>What to say to start</h3>
      <div class="block">
        <textarea id="prompt" rows="3">Describe a recent project you led and one lesson you learned.</textarea>
        <div class="row" style="margin-top:10px;gap:8px">
          <button id="btn-random" class="btn btn-ghost">üé≤ Randomize prompt</button>
          <div class="small muted">We don‚Äôt store your audio; it‚Äôs sent to the analyzer and immediately discarded.</div>
        </div>
      </div>

      <div style="height:18px"></div>
      <div class="block">
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <div class="pill" id="pill-live">‚óè Idle</div>
          <div class="pill"><b>Level:</b> <span id="level-text">‚Äî</span></div>
          <div class="pill"><b>Fillers:</b> <span id="fillers">0</span></div>
          <div class="pill"><b>Streak:</b> <span id="streak">0</span></div>
          <div class="pill"><b>Sessions:</b> <span id="sessions">0</span></div>
        </div>
        <div style="height:10px"></div>
        <div class="small muted">Level meter</div>
        <div class="meter"><i id="level-meter" style="width:0%"></i></div>
      </div>
    </div>

    <!-- RIGHT: results -->
    <div class="card section">
      <div class="list">

        <div class="item">
          <h3>Pronunciation</h3>
          <div id="pron" class="small muted">‚Äì</div>
        </div>

        <div class="item">
          <h3>Grammar</h3>
          <div id="grammar" class="list"></div>
        </div>

        <div class="item">
          <h3>What to fix now</h3>
          <div id="fixnow" class="small muted">‚Äì</div>
        </div>

        <div class="item">
          <h3>Next prompt (30‚Äì45s)</h3>
          <div id="next" class="small muted">‚Äì</div>
        </div>

        <div class="item">
          <h3>Leaderboard</h3>
          <div id="leader" class="small">
            Public leaderboard requires sign-in. You‚Äôll still see your local totals below.
            <div id="leader-table" class="list" style="margin-top:10px"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="footer small">
    ¬© 2025 <a class="link" href="https://simpleia.com" target="_blank" rel="noreferrer">Simpleia</a> ‚Äî Built by <a class="link" href="https://aosama.net" target="_blank" rel="noreferrer">Abdo Osama</a> ‚Ä¢ <span class="mono">v1.2.12</span>
  </div>
</div>

<!-- Feedback modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="fb-title">
  <div class="sheet">
    <header><strong id="fb-title">Quick feedback (required to continue)</strong></header>
    <div class="body">
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <input id="fb-name" type="text" placeholder="Your name" style="flex:1;min-width:180px">
        <input id="fb-email" type="email" placeholder="you@email.com" style="flex:1;min-width:220px">
      </div>
      <div style="height:10px"></div>
      <div>Rating</div>
      <div class="stars" id="stars">
        <span class="star">‚≠ê</span><span class="star">‚≠ê</span><span class="star">‚≠ê</span><span class="star">‚≠ê</span><span class="star">‚≠ê</span>
      </div>
      <div style="height:10px"></div>
      <textarea id="fb-text" rows="4" placeholder="What did you like? What can be improved?"></textarea>
    </div>
    <footer>
      <button id="fb-cancel" class="btn btn-tertiary">Cancel</button>
      <button id="fb-submit" class="btn btn-primary">Submit feedback</button>
    </footer>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ---------- CONFIG (replace) ---------- */
const APP_VERSION = 'v1.2.12';
const ANALYZE_URL = 'https://english-coach-endpoint.vercel.app/api/analyze';   // ‚Üê your Vercel API
const SUPABASE_URL = 'https://YOUR_PROJECT_REF.supabase.co';                   // ‚Üê replace
const SUPABASE_ANON = 'YOUR_SUPABASE_ANON_PUBLIC_KEY';                         // ‚Üê replace

/* ---------- SUPABASE ---------- */
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const authOut = document.getElementById('auth-out');
const authIn  = document.getElementById('auth-in');
const userBadge = document.getElementById('user-badge');

document.getElementById('btn-google').onclick = () =>
  supabase.auth.signInWithOAuth({ provider: 'google', options:{ redirectTo: location.origin }});

document.getElementById('btn-facebook').onclick = () =>
  supabase.auth.signInWithOAuth({ provider: 'facebook', options:{ redirectTo: location.origin }});

document.getElementById('btn-email').onclick = async () => {
  const email = document.getElementById('email-input').value.trim();
  if(!email) return;
  const { error } = await supabase.auth.signInWithOtp({ email, options:{ emailRedirectTo: location.origin }});
  document.getElementById('email-hint').style.display = error ? 'none' : 'block';
};

document.getElementById('btn-signout').onclick = async () => { await supabase.auth.signOut(); };

async function onAuthInit(){
  const { data:{ session } } = await supabase.auth.getSession();
  applyAuth(session?.user || null);
}
supabase.auth.onAuthStateChange((_e, session)=> applyAuth(session?.user || null));

function applyAuth(user){
  if(user){
    authOut.style.display = 'none';
    authIn.style.display = 'block';
    const name = user.user_metadata?.full_name || user.user_metadata?.name || '';
    userBadge.textContent = name ? `${name} ‚Äî ${user.email}` : (user.email||'');
    document.getElementById('fb-name').value = name||'';
    document.getElementById('fb-email').value = user.email||'';
  }else{
    authOut.style.display = 'block';
    authIn.style.display = 'none';
  }
}
onAuthInit();

/* ---------- UI refs ---------- */
const chips = [...document.querySelectorAll('.chip')];
const promptEl = document.getElementById('prompt');
const btnRandom = document.getElementById('btn-random');

const btnStart = document.getElementById('btn-start');
const btnStop  = document.getElementById('btn-stop');
const btnSend  = document.getElementById('btn-send');
const timerEl  = document.getElementById('timer');
const progEl   = document.getElementById('progress');

const pillLive = document.getElementById('pill-live');
const levelText= document.getElementById('level-text');
const levelMeter=document.getElementById('level-meter');
const fillersEl= document.getElementById('fillers');
const streakEl = document.getElementById('streak');
const sessionsEl=document.getElementById('sessions');

const pronEl   = document.getElementById('pron');
const grammarEl= document.getElementById('grammar');
const fixEl    = document.getElementById('fixnow');
const nextEl   = document.getElementById('next');

const leaderWrap = document.getElementById('leader-table');

/* ---------- prompts by goal ---------- */
const PROMPTS = {
  'Work English': [
    'Describe a recent project you led and one lesson you learned.',
    'Explain one problem your team faced and how you solved it.',
    'Share a time you gave feedback that helped a teammate improve.'
  ],
  'Daily Life': [
    'What did you do last weekend? Describe it in 45 seconds.',
    'Explain your morning routine and one habit you‚Äôre trying to build.',
    'Tell a short story about a small win this week.'
  ],
  'Interview Prep': [
    'Tell me about a challenge you faced and how you overcame it.',
    'Describe your most impactful project and your role.',
    'What‚Äôs a mistake you learned from? Explain briefly.'
  ],
  'Travel': [
    'Describe your favorite trip and one memorable moment.',
    'If a friend visited your city, where would you take them and why?',
    'Explain a travel problem you faced and how you handled it.'
  ],
  'Presentation': [
    'Summarize a presentation you recently gave in simple terms.',
    'Pitch a product you like to someone who has never seen it.',
    'Explain a chart or figure as if the audience can‚Äôt see it.'
  ]
};
function setPromptFor(goal){ promptEl.value = PROMPTS[goal][0]; }
function randomizePrompt(){
  if(recording) return; // disabled while recording
  const goal = currentGoal();
  const list = PROMPTS[goal]; const i = Math.floor(Math.random()*list.length);
  promptEl.value = list[i];
}
btnRandom.onclick = randomizePrompt;

/* ---------- goal chips ---------- */
function currentGoal(){ return document.querySelector('.chip.active').dataset.goal; }
chips.forEach(ch=>{
  ch.onclick = ()=>{ chips.forEach(c=>c.classList.remove('active')); ch.classList.add('active'); setPromptFor(currentGoal()); };
});
setPromptFor(currentGoal());

/* ---------- recorder ---------- */
let media, rec, chunks=[], startedAt=0, tickInt=null, duration=0, recording=false;
const MAX_SEC=95; // auto-stop safeguard

function fmt(s){s|=0; const m=String(Math.floor(s/60)).padStart(2,'0'); const sec=String(s%60).padStart(2,'0'); return `${m}:${sec}`;}
function setLive(on){ pillLive.textContent = on ? '‚óè Live' : '‚óè Idle'; pillLive.style.background = on?'#1e2620':'#202129'; pillLive.style.color=on?'#9ee8c1':'#c7cbd5'; }

async function startRec(){
  try{
    media = await navigator.mediaDevices.getUserMedia({audio:true});
    rec = new MediaRecorder(media);
    chunks=[]; rec.ondataavailable = e=> chunks.push(e.data);
    rec.onstop = ()=> media.getTracks().forEach(t=>t.stop());
    rec.start(200);
    startedAt = Date.now(); duration = 0; updateTimer(0);
    tickInt = setInterval(()=>{
      duration = Math.floor((Date.now()-startedAt)/1000);
      updateTimer(duration);
      if(duration>=MAX_SEC) stopRec();
    }, 200);
    recording = true; btnStart.disabled=true; btnStop.disabled=false; btnSend.disabled=true; btnRandom.disabled=true;
    setLive(true);
  }catch(e){ alert('Mic permission denied.'); }
}
function stopRec(){
  if(!recording) return;
  rec.stop(); clearInterval(tickInt); recording=false;
  btnStart.disabled=false; btnStop.disabled=true; btnSend.disabled = (chunks.length===0);
  btnRandom.disabled=false;
  setLive(false);
}
function updateTimer(s){
  timerEl.textContent = fmt(s);
  const pct = Math.min(100, Math.round( (s/90)*100 ));
  const color = s<20?'var(--danger)':(s<45?'var(--warn)':'var(--ok)');
  progEl.style.width = pct+'%'; progEl.style.background = color;
}

btnStart.onclick = startRec;
btnStop.onclick  = stopRec;

/* ---------- analyze ---------- */
let feedbackRequired = false;

btnSend.onclick = async ()=>{
  if(recording) stopRec();
  if(chunks.length===0) return;
  btnSend.disabled=true;

  const blob = new Blob(chunks, {type:'audio/webm'}); chunks=[];
  const fd = new FormData();
  fd.append('files[]', new File([blob], 'audio.webm', {type:'audio/webm'}));
  fd.append('duration_sec', String(duration||0));
  fd.append('goal', currentGoal());
  fd.append('prompt_text', promptEl.value);

  const res = await fetch(ANALYZE_URL, { method:'POST', body: fd }).catch(()=>null);
  if(!res){ btnSend.disabled=false; return alert('Network error.'); }
  const json = await res.json().catch(()=> ({}));

  // fallback or error
  if(json.fallback){
    levelText.textContent = 'Beginner';
    levelMeter.style.width = '10%';
    fillersEl.textContent = '0';
    pronEl.textContent='‚Äì';
    grammarEl.innerHTML='';
    fixEl.textContent = json.one_thing_to_fix || 'Speak for at least 30‚Äì60 seconds in full sentences.';
    nextEl.textContent = json.next_prompt || 'Describe your last weekend in ~45 seconds.';
  }else if(json.ok===false){
    alert(json.error||'Analyzer error');
  }else{
    // render
    levelText.textContent = json.friendly_level || json.cefr_estimate || '‚Äî';
    levelMeter.style.width = (json.level_score||50)+'%';
    fillersEl.textContent = json.fluency?.fillers ?? 0;

    // pronunciation list
    if(Array.isArray(json.pronunciation) && json.pronunciation.length){
      pronEl.innerHTML = json.pronunciation.map(p=>(
        `<div class="item small"><b>${escapeHtml(p.sound_or_word||'')}</b> ‚Äî ${escapeHtml(p.issue||'')}
         ${p.minimal_pair? `<div class="small muted">Try: ${escapeHtml(p.minimal_pair)}</div>`:''}</div>`
      )).join('');
    }else pronEl.textContent='‚Äî';

    // grammar list
    grammarEl.innerHTML = (json.grammar_issues||[]).map(g=>(
      `<div class="item">
        <div>‚Üí ${escapeHtml(g.error||'')}</div>
        <div class="small muted">Try: ${escapeHtml(g.fix||'')}</div>
        <div class="small muted">Why: ${escapeHtml(g.why||'')}</div>
      </div>`
    )).join('') || '<div class="small muted">‚Äî</div>';

    fixEl.textContent = json.one_thing_to_fix || '‚Äî';
    nextEl.textContent = json.next_prompt || '‚Äî';
  }

  // save session + update counters
  await addSession(duration||0, levelText.textContent);

  // reset UI for next
  timerEl.textContent='00:00'; progEl.style.width='0%'; btnSend.disabled=true;

  // require feedback before next session
  openFeedbackModal();
};

/* ---------- counters, streak, leaderboard ---------- */
function todayKey(){ const d=new Date();return d.toISOString().slice(0,10); }
function lsGet(k,def){ try{const v=localStorage.getItem(k);return v?JSON.parse(v):def}catch{ return def; } }
function lsSet(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

async function addSession(sec, level){
  // local counters
  const sessions = (lsGet('ec_sessions',0)||0)+1; lsSet('ec_sessions', sessions);
  sessionsEl.textContent = sessions;
  // streak
  const last = lsGet('ec_last_day', null);
  const today = todayKey();
  let streak = lsGet('ec_streak', 0);
  if(last!==today){
    const yest = new Date(); yest.setDate(yest.getDate()-1);
    const yk = yest.toISOString().slice(0,10);
    streak = (last===yk) ? streak+1 : 1;
    lsSet('ec_streak', streak); lsSet('ec_last_day', today);
  }
  streakEl.textContent = streak;

  // save to Supabase if logged in
  const { data:{ session } } = await supabase.auth.getSession();
  if(session?.user){
    try{
      await supabase.from('sessions').insert({
        user_id: session.user.id,
        duration_sec: sec,
        level_label: level,
        goal: currentGoal()
      });
      await refreshLeaderboard();
    }catch(e){}
  }else{
    refreshLocalLeaderboard();
  }
}
async function refreshLeaderboard(){
  const { data:{ session } } = await supabase.auth.getSession();
  leaderWrap.innerHTML='';
  if(!session?.user){
    refreshLocalLeaderboard();
    return;
  }
  // top 10 by count
  const { data, error } = await supabase.rpc('top_users_by_sessions'); // optional function
  if(error){ refreshLocalLeaderboard(); return; }
  (data||[]).slice(0,10).forEach((r,i)=>{
    const row = document.createElement('div');
    row.className='row'; row.style.justifyContent='space-between'; row.style.background='#1a1b21'; row.style.border='1px solid #2a2d35'; row.style.borderRadius='10px'; row.style.padding='8px 10px';
    row.innerHTML=`<div class="small">${i+1}. ${escapeHtml(r.display || r.email || 'User')}</div><div class="small muted">${r.sessions} sessions</div>`;
    leaderWrap.appendChild(row);
  });
}
function refreshLocalLeaderboard(){
  leaderWrap.innerHTML='';
  const you = lsGet('ec_sessions',0)||0;
  const row = document.createElement('div');
  row.className='row'; row.style.justifyContent='space-between'; row.style.background='#1a1b21'; row.style.border='1px solid #2a2d35'; row.style.borderRadius='10px'; row.style.padding='8px 10px';
  row.innerHTML=`<div class="small">You</div><div class="small muted">${you} sessions</div>`;
  leaderWrap.appendChild(row);
}
refreshLocalLeaderboard();

/* ---------- feedback modal ---------- */
const modal = document.getElementById('modal');
const fbName = document.getElementById('fb-name');
const fbEmail= document.getElementById('fb-email');
const fbText = document.getElementById('fb-text');
const starsEl= document.getElementById('stars');
let fbRating = 0;
[...starsEl.querySelectorAll('.star')].forEach((s,idx)=>{
  s.onclick = ()=>{ fbRating = idx+1; [...starsEl.children].forEach((c,i)=> c.classList.toggle('active',i<fbRating)); };
});
document.getElementById('fb-cancel').onclick = ()=> { /* feedback is required */ };
document.getElementById('fb-submit').onclick = submitFeedback;

function openFeedbackModal(){
  feedbackRequired = true;
  modal.classList.add('open');
  btnStart.disabled = true; // block next use
  btnStop.disabled = true;
  btnRandom.disabled = false;
}
async function submitFeedback(){
  const name = fbName.value.trim(); const email = fbEmail.value.trim(); const text = fbText.value.trim();
  if(!fbRating || !text){ return alert('Please pick a rating and add a comment.'); }
  // try supabase, else store locally
  const { data:{ session } } = await supabase.auth.getSession();
  try{
    if(session?.user){
      await supabase.from('feedback').insert({
        user_id: session.user.id,
        name, email, rating: fbRating, text
      });
    }else{
      const curr = lsGet('ec_feedback', []); curr.push({ name, email, rating: fbRating, text, t: Date.now() }); lsSet('ec_feedback', curr);
    }
  }catch(e){}
  modal.classList.remove('open'); feedbackRequired=false;
  btnStart.disabled = false; // allow new recording
  // reset fields for next time
  fbText.value=''; fbRating=0; [...starsEl.children].forEach(c=>c.classList.remove('active'));
}

/* ---------- tiny utils ---------- */
function escapeHtml(s){ return String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

/* ---------- guard: cannot start while feedback required ---------- */
btnStart.addEventListener('click', (e)=>{ if(feedbackRequired){ e.preventDefault(); openFeedbackModal(); }});
</script>
</body>
</html>
