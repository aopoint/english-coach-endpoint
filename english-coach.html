<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>English Coach ‚Äî Instant English Feedback</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#191919;
    --panel:#1f1f1f;
    --sunken:#1a1a1a;
    --text:#e9e9e9;
    --muted:#9aa0a6;
    --chip:#2a2a2a;
    --ring: rgba(78,10,122,.35);
    --primary:#4E0A7A;
    --primary-2:#7f2dd1;
    --ok:#22c55e;
    --warn:#f59e0b;
    --err:#ef4444;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background: radial-gradient(1000px 600px at 30% -10%, rgba(127,45,209,.18), transparent 60%),
                radial-gradient(800px 400px at 90% -10%, rgba(78,10,122,.18), transparent 60%),
                var(--bg);
    color:var(--text);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  header{display:flex;align-items:center;gap:16px;margin-bottom:20px}
  header h1{margin:0;font-weight:800;letter-spacing:.2px}
  .badge{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;background:linear-gradient(135deg,var(--primary),var(--primary-2));border-radius:999px;font-weight:700}
  .layout{display:grid;grid-template-columns:360px 1fr;gap:24px}
  @media (max-width:980px){.layout{grid-template-columns:1fr}}
  .card{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card.pad{padding:22px}
  .title{font-weight:800;margin:0 0 8px;font-size:40px;line-height:1.1}
  .subtitle{margin:0 0 22px;color:var(--muted)}
  .section-title{font-weight:800;margin:0 0 10px}
  .hint{color:var(--muted);font-size:13px}
  .goals{display:flex;flex-wrap:wrap;gap:12px;margin:6px 0 16px}
  .goal{border:none;background:#262626;color:#e8e8e8;padding:14px 18px;border-radius:14px;font-weight:700;cursor:pointer;transition:.18s transform}
  .goal:hover{transform:translateY(-1px)}
  .goal.active{background:linear-gradient(135deg,var(--primary),var(--primary-2));box-shadow:0 0 0 6px var(--ring)}
  .controls{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:10px 0 12px}
  .btn{border:none;border-radius:14px;padding:16px 18px;font-weight:800;cursor:pointer}
  .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-2));color:white}
  .btn-ghost{background:#2a2a2a;color:#eee}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .timer-row{display:flex;align-items:center;gap:14px;margin:6px 0 14px}
  .timer{font-weight:900;font-size:22px;letter-spacing:.5px;background:#232323;border-radius:12px;padding:10px 14px;min-width:100px;text-align:center}
  .bar{flex:1;height:8px;background:#2a2a2a;border-radius:999px;overflow:hidden}
  .bar > span{display:block;height:100%;width:0;background:linear-gradient(90deg,#7f2dd1,var(--primary),#22c55e);transition:width .25s}
  .chip{display:inline-flex;align-items:center;gap:10px;background:#242424;border-radius:999px;padding:8px 12px;font-weight:800}
  .chip .led{width:8px;height:8px;border-radius:50%;background:#7a7a7a;box-shadow:0 0 0 4px rgba(122,122,122,.18)}
  .chip.live .led{background:#ef4444;box-shadow:0 0 0 6px rgba(239,68,68,.22)}
  .grid{display:grid;gap:14px}
  .row-2{grid-template-columns:1fr 1fr}
  @media (max-width:980px){.row-2{grid-template-columns:1fr}}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#242424;border-radius:999px;padding:8px 12px;font-weight:800}
  .slot{background:#222;border:1px solid #2b2b2b;border-radius:14px;padding:16px 18px}
  .slot p{margin:0}
  .list{display:grid;gap:10px}
  .issue{background:#222;border:1px solid #2c2c2c;border-radius:12px;padding:12px 14px;line-height:1.5}
  .muted{color:var(--muted)}
  .kbd{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;background:#222;border-radius:999px}
  footer{display:flex;justify-content:center;margin:26px 0 14px;color:#a9a3b8;font-size:13px;gap:6px}
  footer a{color:#c1b7ff;text-decoration:none}
  .row-split{display:grid;grid-template-columns:1fr;gap:14px;margin-top:12px}
  .row-split .btn-primary{width:100%}
  .rand{display:flex;align-items:center;gap:10px;margin-top:10px}
  .rand .btn-ghost{padding:10px 12px;border-radius:999px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 style="font-size:34px;">English Coach</h1>
      <span class="badge">Instant English Feedback</span>
    </header>

    <div class="layout">
      <!-- LEFT: controls -->
      <section class="card pad" aria-labelledby="controlsTitle">
        <h2 id="controlsTitle" class="title">Record for<br>60‚Äì90 seconds.</h2>
        <p class="subtitle">We‚Äôll analyze fluency & correctness, then show key corrections and a next prompt.</p>

        <h3 class="section-title">Goal</h3>
        <div class="goals" id="goals">
          <button class="goal active" data-goal="Work English">Work English</button>
          <button class="goal" data-goal="Daily Life">Daily Life</button>
          <button class="goal" data-goal="Interview Prep">Interview Prep</button>
          <button class="goal" data-goal="Travel">Travel</button>
          <button class="goal" data-goal="Presentation">Presentation</button>
        </div>

        <!-- Controls block looks visually separate -->
        <div class="card pad" style="background:var(--sunken);margin:10px 0 14px;">
          <div class="controls">
            <button id="btnStart" class="btn btn-primary">‚ñ∂Ô∏è Start recording</button>
            <button id="btnStop" class="btn btn-ghost" disabled>‚èπÔ∏è Stop</button>
          </div>

          <div class="timer-row">
            <div class="timer" id="timer">00:00</div>
            <div class="bar"><span id="barFill"></span></div>
          </div>

          <div class="row-split">
            <button id="btnSend" class="btn btn-primary" disabled>Send & Analyze</button>
          </div>
        </div>

        <h3 class="section-title">What to say to start</h3>
        <div class="slot">
          <p id="promptBox">Describe a recent project you led and one lesson you learned.</p>
          <div class="rand">
            <button id="btnRand" class="btn btn-ghost">üé≤ Randomize prompt</button>
            <span class="hint">We don‚Äôt store your audio; it‚Äôs sent to the analyzer and immediately discarded.</span>
          </div>
        </div>
      </section>

      <!-- RIGHT: results -->
      <section class="card pad" aria-live="polite">
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:6px">
          <span id="liveChip" class="chip"><span class="led"></span> Live</span>
          <span class="pill">Level: <span id="lvl">‚Äì</span></span>
          <span class="pill">Fillers: <span id="fillers">0</span></span>
          <span class="pill muted" id="sessionsPill" title="Completed analyses on this device">Sessions: 0</span>
        </div>

        <div class="grid">
          <div>
            <h3 class="section-title">What to fix now</h3>
            <div class="slot" id="fixNow">‚Äì</div>
          </div>

          <div>
            <h3 class="section-title">Grammar</h3>
            <div id="grammar" class="list">
              <div class="issue muted">‚Äì</div>
            </div>
          </div>

          <div>
            <h3 class="section-title">Pronunciation</h3>
            <div id="pron" class="list">
              <div class="issue muted">‚Äì</div>
            </div>
          </div>

          <div>
            <h3 class="section-title">Next prompt (30‚Äì45s)</h3>
            <div class="slot" id="nextPrompt">‚Äì</div>
          </div>
        </div>
      </section>
    </div>

    <footer>
      <span>¬© 2025&nbsp;Simpleia ‚Äî Built by <a href="https://aosama.net" target="_blank" rel="noopener">Abdo Osama</a></span>
      <span>&nbsp;¬∑&nbsp;</span>
      <span id="ver">v1.2</span>
      <span>&nbsp;¬∑&nbsp;</span>
      <span class="muted">Free beta: features and availability may change.</span>
    </footer>
  </div>

<script>
/* ===== Config ===== */
const APP_VERSION = "v1.2";
const API_URL = "https://english-coach-endpoint.vercel.app/api/analyze"; // <- change if needed
const MIN_SEND_MS = 4000;  // enable ‚ÄúSend‚Äù after 4s so people can test quickly
const IDEAL_MS = 90000;    // 90s target
const STORAGE = {
  sessions: "ec_sessions_v1",
  goal: "ec_goal_v1"
};

/* ===== State ===== */
let mediaRecorder;
let chunks = [];
let recStart = 0;
let timerInt = null;
let currentGoal = localStorage.getItem(STORAGE.goal) || "Work English";

/* ===== UI refs ===== */
const btnStart = document.getElementById("btnStart");
const btnStop  = document.getElementById("btnStop");
const btnSend  = document.getElementById("btnSend");
const timerEl  = document.getElementById("timer");
const barFill  = document.getElementById("barFill");
const fixNow   = document.getElementById("fixNow");
const grammar  = document.getElementById("grammar");
const pron     = document.getElementById("pron");
const lvl      = document.getElementById("lvl");
const fillers  = document.getElementById("fillers");
const nextPrompt = document.getElementById("nextPrompt");
const liveChip = document.getElementById("liveChip");
const sessionsPill = document.getElementById("sessionsPill");
const promptBox = document.getElementById("promptBox");

/* Version badge */
document.getElementById("ver").textContent = APP_VERSION;

/* Goals */
document.querySelectorAll(".goal").forEach(b=>{
  if(b.dataset.goal===currentGoal) b.classList.add("active");
  b.addEventListener("click", ()=>{
    document.querySelectorAll(".goal").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    currentGoal = b.dataset.goal;
    localStorage.setItem(STORAGE.goal,currentGoal);
    seedPrompt(currentGoal);
  });
});

/* Randomize prompt */
const PROMPTS = {
  "Work English":[
    "Describe a recent challenge you faced at work and how you handled it.",
    "Explain a decision you made that improved your team‚Äôs workflow.",
    "Tell me about a project you‚Äôre proud of and why."
  ],
  "Daily Life":[
    "Describe your morning routine and how it affects your day.",
    "Tell me about a hobby you enjoy and what you‚Äôve learned from it.",
    "Talk about a place you like to visit and why."
  ],
  "Interview Prep":[
    "What is one mistake you made at work and what did you learn from it?",
    "Describe a time you led a team through a difficult situation.",
    "Explain a complex idea from your field as if to a non-expert."
  ],
  "Travel":[
    "Describe a memorable trip and what made it special.",
    "If you could visit any country next month, where and why?",
    "Share a travel issue you faced and how you solved it."
  ],
  "Presentation":[
    "Summarize a topic you could teach in 60‚Äì90 seconds.",
    "Pitch your product or idea to a non-technical audience.",
    "Explain a chart or set of numbers from a recent report."
  ]
};
function seedPrompt(goal){ promptBox.textContent = PROMPTS[goal][0]; }
seedPrompt(currentGoal);

document.getElementById("btnRand").addEventListener("click", ()=>{
  const list = PROMPTS[currentGoal] || PROMPTS["Work English"];
  const pick = list[Math.floor(Math.random()*list.length)];
  promptBox.textContent = pick;
});

/* Recording */
btnStart.addEventListener("click", async ()=>{
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    chunks = [];
    mediaRecorder = new MediaRecorder(stream, {mimeType: 'audio/webm'});
    mediaRecorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
    mediaRecorder.start(250);
    recStart = Date.now();
    setRecordingUI(true);
    timerInt = setInterval(updateTimer, 200);
  }catch(e){
    alert("Microphone permission is required.");
  }
});

btnStop.addEventListener("click", ()=>{
  if(mediaRecorder && mediaRecorder.state !== "inactive"){
    mediaRecorder.stop();
    mediaRecorder.stream.getTracks().forEach(t=>t.stop());
  }
  setRecordingUI(false);
  clearInterval(timerInt);
  updateTimer(); // final tick
});

function setRecordingUI(on){
  liveChip.classList.toggle("live", on);
  btnStart.disabled = on;
  btnStop.disabled = !on;
  btnSend.disabled = on || elapsedMs()<MIN_SEND_MS;
}

function elapsedMs(){ return recStart ? (Date.now() - recStart) : 0; }
function fmt(ms){
  const s = Math.floor(ms/1000);
  const m = Math.floor(s/60).toString().padStart(2,'0');
  const ss = (s%60).toString().padStart(2,'0');
  return `${m}:${ss}`;
}
function updateTimer(){
  const ms = elapsedMs();
  timerEl.textContent = fmt(ms);
  const pct = Math.min(100, Math.round((ms/IDEAL_MS)*100));
  barFill.style.width = pct + "%";
  if(ms >= MIN_SEND_MS) btnSend.disabled = liveChip.classList.contains("live");
}

/* Send & analyze */
btnSend.addEventListener("click", async ()=>{
  if(elapsedMs()<MIN_SEND_MS){ alert("Please record a few seconds first."); return; }

  // freeze UI
  btnSend.disabled = true; btnSend.textContent = "Sending‚Ä¶";
  const blob = new Blob(chunks, {type:'audio/webm'});
  const file = new File([blob], 'audio.webm', {type:blob.type});
  const fd = new FormData();
  fd.append('files[]', file);
  fd.append('duration_sec', Math.round(elapsedMs()/1000));
  fd.append('goal', currentGoal);

  try{
    const res = await fetch(API_URL, {method:'POST', body:fd});
    const raw = await res.text();
    let json={};
    try{ json = JSON.parse(raw); }catch{ throw new Error("Invalid JSON from analyzer."); }

    renderResult(json);
    // sessions count (gamification seed)
    const n = (parseInt(localStorage.getItem(STORAGE.sessions)||"0",10) || 0) + 1;
    localStorage.setItem(STORAGE.sessions, String(n));
    sessionsPill.textContent = `Sessions: ${n}`;
  }catch(e){
    renderError(e.message || "Request failed.");
  }finally{
    btnSend.disabled = false; btnSend.textContent = "Send & Analyze";
  }
});

sessionsPill.textContent = `Sessions: ${parseInt(localStorage.getItem(STORAGE.sessions)||"0",10) || 0}`;

/* Rendering */
function clearList(node){ while(node.firstChild) node.removeChild(node.firstChild); }

function renderResult(j){
  // fallback (short or silent)
  if(j && j.fallback){
    lvl.textContent = "‚Äî";
    fillers.textContent = "0";
    fixNow.textContent = "Speak for at least 30‚Äì60 seconds in full sentences.";
    setList(grammar, [
      "Try to extend ideas into full sentences.",
      "Use simple connectors (and, but, because) to link clauses.",
      "Keep going for 60‚Äì90 seconds."
    ]);
    setList(pron, ["‚Äî"]);
    nextPrompt.textContent = "Describe your last weekend in 45 seconds.";
    return;
  }

  lvl.textContent = j?.cefr_estimate || mapFriendlyLevel(j?.cefr_estimate);
  const f = (j?.fluency?.fillers ?? 0);
  fillers.textContent = String(f);
  fixNow.textContent = j?.one_thing_to_fix || j?.rationale || "‚Äî";
  nextPrompt.textContent = j?.next_prompt || "‚Äî";

  // Grammar
  const g = Array.isArray(j?.grammar_issues) ? j.grammar_issues : [];
  if(g.length===0){
    setList(grammar, ["No clear grammar issues were detected in this short clip."]);
  }else{
    setList(grammar, g.map(x=>formatGrammar(x)));
  }

  // Pronunciation
  const p = Array.isArray(j?.pronunciation) ? j.pronunciation : [];
  if(p.length===0){
    setList(pron, [
      "We couldn‚Äôt confidently assess pronunciation in this sample. " +
      "Try 45‚Äì90 seconds with clear nouns/verbs and steady pace."
    ]);
  }else{
    setList(pron, p.map(x=>formatPron(x)));
  }
}

function renderError(msg){
  lvl.textContent = "‚Äî";
  fillers.textContent = "0";
  fixNow.textContent = msg || "Error.";
  setList(grammar, ["‚Äî"]);
  setList(pron, ["‚Äî"]);
  nextPrompt.textContent = "‚Äî";
}

function setList(node, items){
  clearList(node);
  items.forEach(t=>{
    const d = document.createElement("div");
    d.className = "issue";
    d.textContent = t;
    node.appendChild(d);
  });
}

function formatGrammar(it){
  const e  = it?.error ? `‚Üí ${it.error}` : null;
  const fx = it?.fix   ? `Try: ${it.fix}` : null;
  const w  = it?.why   ? `Why: ${it.why}` : null;
  return [e,fx,w].filter(Boolean).join("\n");
}
function formatPron(it){
  const w  = it?.sound_or_word || it?.word || "‚Äî";
  const i  = it?.issue ? `‚Äî ${it.issue}` : "";
  const mp = it?.minimal_pair ? `Try: ${it.minimal_pair}` : "";
  return `${w} ${i}${mp ? "\n" + mp : ""}`;
}

function mapFriendlyLevel(code){
  // If backend returns A1..C2 we can map to friendly labels;
  // keep original for now since you prefer Elementary/Intermediate/Fluent style via backend.
  return code || "‚Äî";
}
</script>
</body>
</html>
