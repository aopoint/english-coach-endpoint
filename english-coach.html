<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>English Coach</title>

  <!-- Favicon: tiny gradient square -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop stop-color="%238b5cf6"/><stop offset="1" stop-color="%237c3aed"/></linearGradient></defs><rect rx="14" ry="14" width="64" height="64" fill="url(%23g)"/></svg>' />

  <style>
    :root{
      --bg:#0f0f13; --panel:#15161c; --panel-2:#191a22; --muted:#a5a7b1;
      --text:#e9e9f2; --chip:#232433; --ring:#434469; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --brand-1:#8b5cf6; --brand-2:#7c3aed;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      background: radial-gradient(900px 600px at 30% -10%, #1a1b24 0%, transparent 55%), var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .logo{width:18px;height:18px;border-radius:6px;background:linear-gradient(135deg,var(--brand-1),var(--brand-2));box-shadow:0 0 20px rgba(124,58,237,.25)}
    h1{font-size:26px;margin:0}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:18px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid #1d2030;border-radius:var(--radius);box-shadow:0 0 0 1px rgba(67,68,105,.06) inset}
    .card .head{padding:18px 18px 8px;font-weight:700;letter-spacing:.02em}
    .card .body{padding:12px 18px 18px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{
      background:var(--chip);border:1px solid #26283a;color:var(--text);
      padding:12px 16px;border-radius:14px;cursor:pointer;font-weight:700
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-ghost{background:var(--chip)}
    .btn-primary{
      background:linear-gradient(135deg,var(--brand-1),var(--brand-2));
      border:0; box-shadow:0 10px 30px rgba(124,58,237,.25), inset 0 0 0 1px rgba(255,255,255,.05)
    }
    .chips{display:flex;gap:10px;flex-wrap:wrap}
    .chip{
      padding:10px 14px;border-radius:12px;background:var(--chip);border:1px solid #26283a;color:var(--text);cursor:pointer;font-weight:700
    }
    .chip.active{outline:2px solid var(--ring);background:linear-gradient(135deg,var(--brand-1),var(--brand-2))}
    .timerBox{
      background:var(--panel-2);border:1px solid #1f2130;border-radius:16px;padding:16px 18px;font-size:28px;font-weight:800;letter-spacing:.04em
    }
    .bar{
      height:10px;border-radius:999px;background:#292b3d;border:1px solid #222433; position:relative; overflow:hidden
    }
    .bar>i{
      position:absolute;left:0;top:0;bottom:0;width:0%;border-radius:999px;background:linear-gradient(90deg,#ef4444,#f59e0b,#22c55e)
    }
    .kpi{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{background:#232433;border:1px solid #2a2c3f;border-radius:999px;padding:8px 12px;font-size:12px}
    .dot{width:8px;height:8px;border-radius:999px;background:#374151;border:1px solid #222}
    .dot.live{background:var(--ok)}
    .sec{padding:14px 16px;border-top:1px solid #222436}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{background:#1a1b24;border:1px solid #222436;border-radius:12px;padding:12px 12px}
    .titleRow{display:flex;justify-content:space-between;align-items:center;gap:12px}
    footer{margin:24px 0 40px;color:#9aa; font-size:12px;text-align:center}
    .hide{display:none}
    .rightOf{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"></div>
      <h1>English Coach</h1>
      <div class="rightOf muted">v1.2.13</div>
    </header>

    <div class="grid">
      <!-- LEFT: controls -->
      <div class="card">
        <div class="head">Goal</div>
        <div class="body">
          <div class="chips" id="goalChips"></div>
        </div>

        <div class="head">Recording</div>
        <div class="body">
          <div class="row">
            <button class="btn btn-primary" id="btnStart">▶ Start recording</button>
            <button class="btn btn-ghost" id="btnStop" disabled>◼ Stop</button>
          </div>
          <div class="row" style="margin-top:12px; align-items:center">
            <div class="timerBox" id="timer">00:00</div>
            <div class="bar" style="flex:1; margin-left:12px"><i id="progress"></i></div>
          </div>
          <div class="row" style="margin-top:12px">
            <button class="btn btn-primary" id="btnSend" disabled>Send &amp; Analyze</button>
          </div>
        </div>

        <div class="head">What to say to start</div>
        <div class="body">
          <div class="item" id="promptBox" style="min-height:64px"></div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnRand">🎲 Randomize prompt</button>
            <span class="muted">We don’t store your audio; it’s sent to the analyzer and immediately discarded.</span>
          </div>
        </div>
      </div>

      <!-- RIGHT: Results -->
      <div class="card" id="resultCard">
        <div class="sec kpi">
          <span class="dot" id="liveDot"></span><span class="muted">Live</span>
          <span class="pill">Level: <b id="levelText">–</b></span>
          <span class="pill">Fillers: <b id="fillers">0</b></span>
          <span class="pill">Sessions: <b id="sessions">0</b></span>
        </div>

        <div class="sec">
          <div class="row" style="gap:18px; align-items:center">
            <div style="min-width:160px">
              <div class="muted" style="font-size:12px;margin-bottom:6px">Level meter</div>
              <div class="bar" style="width:180px"><i id="levelBar"></i></div>
            </div>
            <div id="relWrap" class="hide" style="min-width:160px">
              <div class="muted" style="font-size:12px;margin-bottom:6px">Relevancy</div>
              <div class="bar" style="width:180px"><i id="relBar"></i></div>
            </div>
          </div>
        </div>

        <div class="sec">
          <div class="head" style="padding:0 0 8px">Pronunciation</div>
          <div class="list" id="pronList"><div class="muted">–</div></div>
        </div>

        <div class="sec">
          <div class="head" style="padding:0 0 8px">Grammar</div>
          <div class="list" id="gramList"><div class="muted">–</div></div>
        </div>

        <div class="sec">
          <div class="head" style="padding:0 0 8px">What to fix now</div>
          <div class="item" id="fixNow">–</div>
        </div>

        <div class="sec">
          <div class="head" style="padding:0 0 8px">Next prompt (30–45s)</div>
          <div class="item" id="nextPrompt">–</div>
        </div>
      </div>
    </div>

    <footer>
      © 2025 <a href="https://simpleia.com" target="_blank" style="color:#bbb;text-decoration:none">Simpleia</a> —
      Built by <a href="https://aosama.net" target="_blank" style="color:#bbb;text-decoration:none">Abdo Osama</a>
    </footer>
  </div>

  <script>
    /* ====== SETTINGS ====== */
    const ANALYZER_URL = "https://english-coach-endpoint.vercel.app/api/analyze"; // <- your API
    const MAX_REC_SEC  = 90;           // auto-stop limit
    const SHOW_RELEVANCE = false;      // turn on/off the relevancy meter

    const GOALS = ["Work English","Daily Life","Interview Prep","Travel","Presentation"];
    const PROMPTS = {
      "Work English":[
        "Describe a recent challenge you faced at work and how you handled it.",
        "Explain one problem your team faced and how you solved it.",
        "Tell me about a project you’re working on and your role."
      ],
      "Daily Life":[
        "Describe your morning routine in detail.",
        "What did you do last weekend? Share for ~45 seconds.",
        "Tell me about your favorite hobby and why you enjoy it."
      ],
      "Interview Prep":[
        "Tell me about yourself (as in a job interview).",
        "What’s a tough decision you made at work?",
        "Describe a time you improved a process."
      ],
      "Travel":[
        "Describe your favorite trip. Where did you go and what did you do?",
        "Plan a weekend in a new city for a friend.",
        "Explain how to apply for a visa step by step."
      ],
      "Presentation":[
        "Summarize a product idea and its main benefits.",
        "Pitch a proposal to reduce team bottlenecks.",
        "Explain a complex topic to a non-expert in 45 seconds."
      ]
    };

    /* ====== ELEMENTS ====== */
    const goalChips = document.getElementById('goalChips');
    const btnStart  = document.getElementById('btnStart');
    const btnStop   = document.getElementById('btnStop');
    const btnSend   = document.getElementById('btnSend');
    const btnRand   = document.getElementById('btnRand');
    const timerEl   = document.getElementById('timer');
    const progressI = document.getElementById('progress');
    const promptBox = document.getElementById('promptBox');

    const liveDot   = document.getElementById('liveDot');
    const levelText = document.getElementById('levelText');
    const fillersEl = document.getElementById('fillers');
    const sessionsEl= document.getElementById('sessions');
    const levelBar  = document.getElementById('levelBar');
    const relWrap   = document.getElementById('relWrap');
    const relBar    = document.getElementById('relBar');

    const pronList  = document.getElementById('pronList');
    const gramList  = document.getElementById('gramList');
    const fixNow    = document.getElementById('fixNow');
    const nextPrompt= document.getElementById('nextPrompt');

    /* ====== STATE ====== */
    let mediaRecorder = null;
    let chunks = [];
    let recStart = 0;
    let timer = null;
    let sec = 0;
    let goal = GOALS[0];
    let sessions = Number(localStorage.getItem('ec_sessions')||'0');

    sessionsEl.textContent = sessions;

    // Build goals UI
    function renderGoals(){
      goalChips.innerHTML = '';
      GOALS.forEach(g=>{
        const el = document.createElement('button');
        el.className = 'chip' + (g===goal?' active':'');
        el.textContent = g;
        el.onclick = ()=>{
          goal = g;
          renderGoals();
          setPrompt(randomPrompt());
        };
        goalChips.appendChild(el);
      });
    }

    function randomPrompt(){
      const arr = PROMPTS[goal] || PROMPTS[GOALS[0]];
      return arr[Math.floor(Math.random()*arr.length)];
    }
    function setPrompt(t){ promptBox.textContent = t; }

    // Timer / progress
    function fmt(n){ return (n<10?'0':'') + n; }
    function setTimer(s){
      sec = s;
      timerEl.textContent = fmt(Math.floor(sec/60)) + ':' + fmt(sec%60);
      const pct = Math.min(100, Math.round((sec / MAX_REC_SEC) * 100));
      progressI.style.width = pct + '%';
    }
    function tick(){
      setTimer(sec+1);
      // color “phases”: red <45, amber <60, green >=60
      const pct = (sec / MAX_REC_SEC);
      if (pct >= 1) stopRec(true);
      liveDot.classList.add('live');
    }

    // Recording
    async function startRec(){
      if (mediaRecorder && mediaRecorder.state === 'recording') return;
      try{
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];
        mediaRecorder.ondataavailable = e => { if (e.data.size>0) chunks.push(e.data); };
        mediaRecorder.onstop = ()=>{};
        mediaRecorder.start(250);

        recStart = Date.now();
        setTimer(0);
        timer = setInterval(tick, 1000);

        btnStart.disabled = true;
        btnStop.disabled  = false;
        btnSend.disabled  = true;
        btnRand.disabled  = true; // disable randomize while recording
        liveDot.classList.add('live');
      }catch(e){
        alert('Mic permission is required.');
      }
    }

    function stopRec(auto=false){
      if (!mediaRecorder) return;
      if (mediaRecorder.state !== 'inactive') mediaRecorder.stop();
      clearInterval(timer); timer = null;
      btnStart.disabled = false;
      btnStop.disabled  = true;
      btnSend.disabled  = chunks.length===0; // allow Send if we have audio
      btnRand.disabled  = false;
      if (auto) btnSend.focus();
    }

    async function sendAnalyze(){
      if (!chunks.length) return;
      btnSend.disabled = true;

      // build form
      const blob = new Blob(chunks, {type:'audio/webm'});
      const file = new File([blob], 'audio.webm', {type:blob.type});
      const fd = new FormData();
      fd.append('files[]', file);
      fd.append('duration_sec', Math.floor(sec));
      fd.append('goal', goal);
      fd.append('prompt_text', promptBox.textContent||'');

      liveDot.classList.remove('live');

      try{
        const res = await fetch(ANALYZER_URL, {method:'POST', body:fd});
        const json = await res.json();
        renderResult(json);

        // count sessions
        localStorage.setItem('ec_sessions', String(++sessions));
        sessionsEl.textContent = sessions;

        // reset UI for fresh recording
        chunks = [];
        setTimer(0);
        progressI.style.width = '0%';
        btnSend.disabled = true;
        btnStart.focus();
      }catch(err){
        alert('Request failed. Please try again.');
      }
    }

    // Rendering results
    function clearList(el){ el.innerHTML = '<div class="muted">–</div>'; }
    function pushItem(el, title, sub){
      if (el.firstElementChild && el.firstElementChild.classList.contains('muted')) el.innerHTML='';
      const it = document.createElement('div');
      it.className = 'item';
      it.innerHTML = `<div class="titleRow"><b>${title}</b></div>${sub?`<div class="muted" style="margin-top:6px">${sub}</div>`:''}`;
      el.appendChild(it);
    }

    function renderResult(r){
      const friendly = r.friendly_level || r.cefr_estimate || '–';
      levelText.textContent = friendly;
      fillersEl.textContent = (r.fluency && typeof r.fluency.fillers==='number')? r.fluency.fillers : 0;

      // level meter
      const lvl = Math.max(0, Math.min(100, Number(r.level_score||0)));
      levelBar.style.width = lvl + '%';

      // relevancy (optional)
      if (SHOW_RELEVANCE && r.relevance && typeof r.relevance.score==='number'){
        relWrap.classList.remove('hide');
        relBar.style.width = Math.max(0,Math.min(100,Math.round(r.relevance.score))) + '%';
      } else {
        relWrap.classList.add('hide');
      }

      // pronunciation
      clearList(pronList);
      (r.pronunciation||[]).forEach(p=>{
        const title = `${p.sound_or_word || '—'} — ${p.issue || ''}`.trim();
        pushItem(pronList, title, p.minimal_pair?`Try: ${p.minimal_pair}`:'');
      });
      if ((r.pronunciation||[]).length===0) pronList.innerHTML = '<div class="muted">–</div>';

      // grammar
      clearList(gramList);
      (r.grammar_issues||[]).forEach(g=>{
        const t = `→ ${g.error || ''}`;
        const sub = [
          g.fix?`Try: ${g.fix}`:'',
          g.why?`Why: ${g.why}`:''
        ].filter(Boolean).join('<br/>');
        pushItem(gramList, t, sub);
      });
      if ((r.grammar_issues||[]).length===0) gramList.innerHTML = '<div class="muted">–</div>';

      // fix now & next prompt (next last)
      fixNow.textContent = r.one_thing_to_fix || '–';
      nextPrompt.textContent = r.next_prompt || '–';
    }

    // Wire up
    btnStart.onclick = startRec;
    btnStop.onclick  = ()=>stopRec(false);
    btnSend.onclick  = sendAnalyze;
    btnRand.onclick  = ()=>{ if (!btnRand.disabled) setPrompt(randomPrompt()); };

    // init
    renderGoals();
    setPrompt(randomPrompt());
    setTimer(0);
  </script>
</body>
</html>
